<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>YoshinovaCalc Lab V1.0</title>
  
  <!-- 薬理学テーマのファビコン -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230d6efd;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230b5ed7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='url(%23grad)' rx='6'/%3E%3Ccircle cx='8' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='6' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='12' cy='16' r='2' fill='%23fff'/%3E%3Ccircle cx='20' cy='14' r='2' fill='%23fff'/%3E%3Ccircle cx='8' cy='24' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='22' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='24' r='2' fill='%23fff'/%3E%3Cline x1='8' y1='8' x2='16' y2='6' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='24' y2='8' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='8' y1='8' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='24' y1='8' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='8' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='22' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3C/svg%3E">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    * { box-sizing: border-box; }
    :root {
      --primary-bg: #fff; --secondary-bg: #f8f9fa; --tertiary-bg: #e9ecef; --border-color: #dee2e6;
      --primary-text: #212529; --secondary-text: #495057; --muted-text: #6c757d;
      --primary-blue: #0d6efd; --primary-blue-hover: #0b5ed7; --primary-blue-focus: #0a58ca;
      --success-color: #198754; --success-bg: #d1e7dd; --warning-color: #fd7e14; --warning-bg: #fff3cd;
      --warning-border: #ffecb5; --error-color: #dc3545; --error-bg: #f8d7da; --error-border: #f5c2c7;
      --info-color: #0dcaf0; --info-bg: #d1ecf1; --info-border: #b6effb;
      --focus-ring: 0 0 0 3px rgba(13,110,253,0.25); --transition: all 0.15s ease-in-out;
      --result-bg: #f8f9fa; --result-border: #6c757d; --result-shadow: rgba(0,0,0,0.08);
    }
    html, body { height: 100%; margin: 0; font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; font-size: 16px; line-height: 1.6; color: var(--primary-text); background: var(--primary-bg);}
    .container, .drug-info { overflow-x: auto; }
    .container { max-width: 700px; margin: 1rem auto; padding: 1.5rem; background: var(--primary-bg); border: 2px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .header { text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);}
    h1 { color: var(--primary-text); font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 0.5rem; line-height: 1.2;}
    .labicon { display: inline-block; font-size: 1.1em; margin: 0 0.2rem; vertical-align: middle;}
    .copyright { font-size: 0.8rem; color: var(--muted-text); margin-top: 0.5rem;}
    
    .results-panel {
      background: var(--result-bg); border: 1px solid var(--result-border);
      border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;
      box-shadow: 0 2px 8px var(--result-shadow), 0 1px 3px var(--result-shadow);
      transition: all 0.3s ease-in-out;
    }
    .results-title { font-weight: 600; margin-bottom: 1.2rem; color: var(--primary-text); font-size: 1rem; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--result-border); padding-bottom: 0.5rem;}
    .results-grid { display: grid; gap: 1rem; grid-template-columns: repeat(2,1fr);}
    .result-item { background: var(--primary-bg); padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); text-align: center;}
    .result-label { font-size: 0.75rem; color: var(--secondary-text); margin-bottom: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;}
    .result-value { font-size: 1.1rem; font-weight: 700; color: var(--primary-text); font-family: 'Monaco', 'Menlo', 'Consolas', monospace;}
    .results-placeholder { text-align: center; color: var(--muted-text); font-style: italic; padding: 2rem 1rem; background: var(--primary-bg); border-radius: 6px; border: 1px dashed var(--border-color);}
    
    /* 改善された最小化ボタン */
    .minimize-btn { 
      position: absolute; top: 0.7em; right: 1em; 
      background: var(--primary-blue); color: white; 
      border: none; border-radius: 4px;
      font-size: 1rem; padding: 0.3em 0.6em;
      cursor: pointer; z-index: 10101; 
      transition: all 0.2s ease;
      font-weight: 600;
      line-height: 1;
    }
    .minimize-btn:hover { background: var(--primary-blue-hover); transform: scale(1.05); }
    .minimize-btn:active, .minimize-btn:focus { background: var(--primary-blue-focus); }
    
    /* 復元ボタン（最小化時に表示） */
    .restore-btn {
      position: absolute; top: 0.5em; right: 0.5em;
      background: var(--primary-blue); color: white;
      border: none; border-radius: 50%;
      width: 24px; height: 24px;
      font-size: 0.8rem; cursor: pointer;
      z-index: 10102; transition: all 0.2s ease;
      display: none; align-items: center; justify-content: center;
    }
    .restore-btn:hover { background: var(--primary-blue-hover); transform: scale(1.1); }
    
    .show-results-btn { display: none; position: fixed; left: 50%; bottom: 1em; transform: translateX(-50%); z-index: 10001; font-size: 1.1rem; padding: 0.7em 2em; border-radius: 2em; background: var(--primary-blue); color: #fff; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.1); cursor: pointer;}
    
    /* PC用スタイリング */
    @media (min-width: 769px) {
      .results-panel {
        position: fixed !important; top: 2rem; right: 2rem; width: 300px; max-width: 25vw; z-index: 1000; margin: 0;
        backdrop-filter: blur(10px); background: rgba(248, 249, 250, 0.95); border: 2px solid var(--result-border);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.1);
      }
      
      /* PC用最小化状態 - ボタンは残す */
      .results-panel.minimized {
        width: 120px !important; height: 40px !important; padding: 0.5rem !important; overflow: hidden;
        border-radius: 20px 0 0 20px !important; right: 0 !important;
      }
      .results-panel.minimized .results-title { 
        font-size: 0.8rem; margin: 0; border: none; padding: 0; white-space: nowrap; cursor: pointer;
      }
      .results-panel.minimized #results-content { display: none !important; }
      .results-panel.minimized .minimize-btn { display: none !important; }
      .results-panel.minimized .restore-btn { display: flex !important; }
      
      .show-results-btn { display: none !important; }
      .container { max-width: 650px; margin: 1rem auto; }
      
      @media (min-width: 1400px) {
        .container { max-width: 700px; }
        .results-panel { width: 320px; max-width: 20vw; }
      }
      @media (min-width: 1000px) and (max-width: 1399px) {
        .container { max-width: 600px; }
      }
    }
    
    /* モバイル用スタイリング */
    @media (max-width: 768px) {
      .results-panel {
        position: fixed !important; left: 0; right: 0; bottom: 0; z-index: 10000; margin: 0; border-radius: 0; border-width: 2px 0 0 0; box-shadow: 0 -2px 8px var(--result-shadow); width: 100vw; max-width: 100vw; min-height: unset; padding: 0.8rem 1rem 1.6rem 1rem; background: var(--result-bg);
      }
      .results-panel.minimized { display: none !important; }
      .restore-btn { display: none !important; }
      body { padding-bottom: 8.5em; }
      .results-title { padding-bottom: 0.3rem;}
      .show-results-btn { display: block; }
    }
    
    /* フォームセクション */
    .form-section { margin-bottom: 1.5rem; padding: 1.5rem; background: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color); transition: var(--transition);}
    .form-section.completed { border-color: var(--success-color); box-shadow: 0 0 0 1px var(--success-color);}
    .form-section h2 { margin: 0 0 1rem 0; color: var(--primary-text); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;}
    
    /* セクションステータス */
    .section-status { font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 500;}
    .section-status.completed { background: var(--success-bg); color: var(--success-color);}
    .section-status.error { background: var(--error-bg); color: var(--error-color);}
    
    .input-group { margin-bottom: 1rem;}
    .input-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;}
    .input-with-status { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px;}
    
    /* 入力ステータス */
    .input-status { font-size: 1.1rem; min-width: 1.2rem; text-align: center;}
    
    .input-label { color: var(--primary-text); font-weight: 500; font-size: 0.95rem; margin-bottom: 0.25rem;}
    .required::after { content: " *"; color: var(--error-color); font-weight: bold;}
    
    input, select { font-size: 0.95rem; padding: 0.6rem 0.8rem; border-radius: 6px; border: 2px solid var(--border-color); font-family: inherit; background-color: var(--primary-bg); color: var(--primary-text); transition: var(--transition); min-height: 48px;}
    input:focus, select:focus { outline: none; border-color: var(--primary-blue); box-shadow: var(--focus-ring);}
    input.valid { border-color: var(--success-color);}
    input.invalid { border-color: var(--error-color);}
    
    .btn { min-height: 48px; display: inline-block; padding: 0.6rem 1.2rem; border-radius: 6px; border: none; font-size: 0.95rem; font-weight: 500; cursor: pointer; text-decoration: none; transition: var(--transition); font-family: inherit;}
    .btn:focus { outline: none; box-shadow: var(--focus-ring);}
    .btn:disabled { opacity: 0.65; cursor: not-allowed;}
    
    .section-result { background: var(--info-bg); padding: 0.5rem 0.75rem; border-radius: 4px; margin-top: 1rem; font-size: 0.9rem; border: 1px solid var(--info-border); color: var(--primary-text); opacity: 0; max-height: 0; overflow: hidden; transition: all 0.3s ease;}
    .section-result.show { opacity: 1; max-height: 200px;}
    .section-result strong { color: var(--success-color); font-weight: 600;}
    
    .drug-info { background-color: var(--tertiary-bg); padding: 1rem; margin-top: 1rem; border-radius: 6px; border: 1px solid var(--border-color);}
    .info-table { width: 100%; border-collapse: collapse; font-size: 0.9rem;}
    .info-table tr { border-bottom: 1px solid var(--border-color);}
    .info-table td { padding: 0.5rem 0.75rem; vertical-align: top;}
    .info-label { font-weight: 600; color: var(--primary-text); background-color: var(--secondary-bg); border-radius: 3px; min-width: 6rem; font-size: 0.85rem;}
    
    /* バリデーションメッセージ */
    .validation-message { padding: 0.6rem 0.8rem; margin: 0.5rem 0; border-radius: 4px; font-size: 0.85rem; font-weight: 500; border-left: 3px solid;}
    .validation-message.error { background-color: var(--error-bg); color: var(--error-color); border-left-color: var(--error-color);}
    .validation-message.warning { background-color: var(--warning-bg); color: var(--warning-color); border-left-color: var(--warning-color);}
    
    /* ローディングアニメーション */
    .loading { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border-color); border-radius: 50%; border-top-color: var(--primary-blue); animation: spin 1s linear infinite; margin-right: 0.5rem;}
    @keyframes spin { to { transform: rotate(360deg); }}
    
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0;}
    .btn-primary { background-color: var(--primary-blue); color: white;}
    .btn-primary:hover:not(:disabled) { background-color: var(--primary-blue-hover);}
    .btn-primary:active:not(:disabled) { background-color: var(--primary-blue-focus);}
    .btn:focus { outline: none; box-shadow: var(--focus-ring);}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>
        <span class="labicon" aria-hidden="true">🧬</span>
        YoshinovaCalc Lab V1.0
        <span class="labicon" aria-hidden="true">⚗️</span>
      </h1>
      <div class="copyright">
        © 2025 Fumihiko Yoshino. All Rights Reserved.
      </div>
    </header>
    
    <!-- 計算結果パネル -->
    <div class="results-panel" id="results-panel">
      <button class="minimize-btn" id="results-minimize" type="button" title="パネルを最小化">▼</button>
      <button class="restore-btn" id="results-restore" type="button" title="パネルを復元">▲</button>
      <div class="results-title">計算結果</div>
      <div id="results-content">
        <div class="results-placeholder">
          必要項目を入力すると、ここに結果が表示されます
        </div>
      </div>
    </div>
    <button class="show-results-btn" id="results-show" type="button" style="display:none;">計算結果を表示</button>
    
    <main id="main-content">
      <!-- ストック溶液設定 -->
      <section class="form-section" id="section-stock" role="region" aria-labelledby="stock-heading">
        <h2 id="stock-heading">
          ストック溶液設定
          <span class="section-status" id="status-stock"></span>
        </h2>
        <div class="input-group">
          <label for="mw" class="input-label required">分子量（g/mol）</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="number" id="mw" step="0.01" placeholder="分子量を入力" required inputmode="decimal">
              <span class="input-status" id="status-mw"></span>
            </div>
          </div>
          <small style="color: var(--muted-text); font-size: 0.8rem;">物質の分子量をg/mol単位で入力</small>
        </div>
        <div class="input-group">
          <label for="molarity" class="input-label required">ストック溶液のモル濃度</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="number" id="molarity" step="any" min="0" placeholder="濃度を入力" required inputmode="decimal">
              <span class="input-status" id="status-molarity"></span>
            </div>
            <select id="molarity_unit" aria-label="濃度の単位">
              <option value="1">mol/L</option>
              <option value="0.001">mmol/L</option>
              <option value="0.000001">μmol/L</option>
              <option value="0.000000001">nmol/L</option>
            </select>
          </div>
          <small style="color: var(--muted-text); font-size: 0.8rem;">調製したいストック溶液の濃度を入力</small>
        </div>
        <div class="input-group">
          <label for="volume" class="input-label required">ストック溶液量</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="number" id="volume" step="any" min="0" placeholder="調製量を入力" required inputmode="decimal">
              <span class="input-status" id="status-volume"></span>
            </div>
            <select id="volume_unit" aria-label="体積の単位">
              <option value="0.001">mL</option>
              <option value="1">L</option>
            </select>
          </div>
          <small style="color: var(--muted-text); font-size: 0.8rem;">調製したいストック溶液の総量を入力</small>
        </div>
        <div class="input-group">
          <label for="mass_unit" class="input-label">表示単位（必要な薬量）</label>
          <div class="input-row">
            <select id="mass_unit" aria-label="質量の表示単位">
              <option value="g">g</option>
              <option value="mg">mg</option>
              <option value="μg">μg</option>
            </select>
          </div>
        </div>
        <div id="section-result-stock" class="section-result"></div>
      </section>
      
      <!-- 希釈計算 -->
      <section class="form-section" id="section-dilution" role="region" aria-labelledby="dilution-heading">
        <h2 id="dilution-heading">
          希釈計算（任意）
          <span class="section-status" id="status-dilution"></span>
        </h2>
        <div class="input-group">
          <label for="final_molarity" class="input-label">実験での最終濃度</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="number" id="final_molarity" step="any" min="0" placeholder="例: 5" inputmode="decimal">
              <span class="input-status" id="status-final-molarity"></span>
            </div>
            <select id="final_molarity_unit" aria-label="最終濃度の単位">
              <option value="1">mol/L</option>
              <option value="0.001">mmol/L</option>
              <option value="0.000001">μmol/L</option>
              <option value="0.000000001">nmol/L</option>
            </select>
          </div>
          <small style="color: var(--muted-text); font-size: 0.8rem;">実験で使用したい最終濃度を入力</small>
        </div>
        <div class="input-group">
          <label for="final_total_vol" class="input-label">希釈後総量（溶媒＋サンプル）</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="number" id="final_total_vol" step="any" min="0" placeholder="例: 100" inputmode="decimal">
              <span class="input-status" id="status-final-volume"></span>
            </div>
            <select id="final_total_vol_unit" aria-label="希釈後総量の単位">
              <option value="0.001">μL</option>
              <option value="1">mL</option>
            </select>
          </div>
          <small style="color: var(--muted-text); font-size: 0.8rem;">
            溶媒にストック溶液を添加した後の最終総液量を入力
          </small>
        </div>
        <div id="section-result-dilution" class="section-result"></div>
      </section>
      
      <!-- CID検索セクション（下部に移動） -->
      <section class="form-section" id="section-search" role="region" aria-labelledby="search-heading">
        <h2 id="search-heading">
          薬物情報検索（CIDコード）
          <span class="section-status" id="status-search"></span>
        </h2>
        <div class="input-group">
          <label for="cid" class="input-label">CIDコード</label>
          <div class="input-row">
            <div class="input-with-status">
              <input type="text" id="cid" autocomplete="off" placeholder="例: 54670067" aria-describedby="cid-help">
              <span class="input-status" id="status-cid"></span>
            </div>
            <button class="btn btn-primary" type="button" onclick="fetchPubChem()"><span id="search-text">検索</span></button>
          </div>
          <small id="cid-help" style="color: var(--muted-text); font-size: 0.8rem;">
            PubChemのCompound IDを入力（ハイフンは削除して入力してください。なお、薬物情報が自動取得できない場合は分子量を手入力してください）
          </small>
        </div>
        <div id="drug_info" class="drug-info" style="display:none;" role="region" aria-labelledby="drug-info-heading">
          <h3 id="drug-info-heading" class="sr-only">取得した薬物情報</h3>
        </div>
      </section>
      
      <!-- バリデーションメッセージ -->
      <div id="validation-messages"></div>
    </main>
  </div>

<script>
// グローバル変数
let currentValidation = { warnings: [], errors: [] };

// ステータス更新関数
function updateInputStatus(inputId, isValid, isEmpty = false) {
    const statusEl = document.getElementById(`status-${inputId.replace('_', '-')}`);
    const inputEl = document.getElementById(inputId);
    
    if (!statusEl || !inputEl) return;
    
    if (isEmpty) {
        statusEl.textContent = '';
        inputEl.className = inputEl.className.replace(/\s*(valid|invalid)/, '');
    } else if (isValid) {
        statusEl.textContent = '✓';
        statusEl.style.color = 'var(--success-color)';
        inputEl.className = inputEl.className.replace(/\s*(valid|invalid)/, '') + ' valid';
    } else {
        statusEl.textContent = '⚠';
        statusEl.style.color = 'var(--error-color)';
        inputEl.className = inputEl.className.replace(/\s*(valid|invalid)/, '') + ' invalid';
    }
}

// セクションステータス更新関数
function updateSectionStatus(sectionId, status) {
    const statusEl = document.getElementById(`status-${sectionId}`);
    const sectionEl = document.getElementById(`section-${sectionId}`);
    
    if (!statusEl || !sectionEl) return;
    
    statusEl.className = 'section-status ' + status;
    
    if (status === 'completed') {
        statusEl.textContent = '完了';
        sectionEl.classList.add('completed');
    } else if (status === 'error') {
        statusEl.textContent = 'エラー';
        sectionEl.classList.remove('completed');
    } else {
        statusEl.textContent = '';
        sectionEl.classList.remove('completed');
    }
}

// バリデーション関数
function validateInputs() {
    const warnings = [];
    const errors = [];
    
    const mw = parseFloat(document.getElementById('mw').value);
    const molarity = parseFloat(document.getElementById('molarity').value);
    const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
    const volume = parseFloat(document.getElementById('volume').value);
    const volume_unit = parseFloat(document.getElementById('volume_unit').value);
    
    const final_molarity = parseFloat(document.getElementById('final_molarity').value);
    const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
    const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
    const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);

    // 個別入力検証とステータス更新
    const mwValid = !isNaN(mw) && mw > 0;
    const molarityValid = !isNaN(molarity) && molarity > 0;
    const volumeValid = !isNaN(volume) && volume > 0;
    const finalMolarityValid = document.getElementById('final_molarity').value === '' || (!isNaN(final_molarity) && final_molarity > 0);
    const finalVolumeValid = document.getElementById('final_total_vol').value === '' || (!isNaN(final_total_vol) && final_total_vol > 0);
    
    updateInputStatus('mw', mwValid, !document.getElementById('mw').value);
    updateInputStatus('molarity', molarityValid, !document.getElementById('molarity').value);
    updateInputStatus('volume', volumeValid, !document.getElementById('volume').value);
    updateInputStatus('final-molarity', finalMolarityValid, !document.getElementById('final_molarity').value);
    updateInputStatus('final-volume', finalVolumeValid, !document.getElementById('final_total_vol').value);

    // 分子量チェック
    if (mwValid) {
        if (mw < 10) {
            warnings.push("分子量が10未満です。低分子化合物でも通常10以上です。入力値を確認してください。");
        } else if (mw > 2000 && mw <= 10000) {
            warnings.push("分子量が2000を超えています。ペプチドや大分子化合物ですか？溶解性にご注意ください。");
        } else if (mw > 10000) {
            warnings.push("分子量が10000を超えています。タンパク質などの巨大分子ですね。特殊な溶解条件が必要かもしれません。");
        }
    }
    
    // ストック濃度チェック
    if (molarityValid && molarity_unit > 0) {
        const stock_conc_molL = molarity * molarity_unit;
        if (stock_conc_molL > 1) {
            warnings.push("ストック濃度が1 M を超えています。溶解度は大丈夫ですか？高濃度では沈殿のリスクがあります。");
        } else if (stock_conc_molL > 0.1) {
            warnings.push("ストック濃度が100 mM を超えています。完全溶解を確認してから使用してください。");
        }
        if (stock_conc_molL < 1e-9) {
            warnings.push("ストック濃度が極めて低いです（1 nM未満）。希釈精度が問題になる可能性があります。");
        }
    }
    
    // 調製量チェック
    if (volumeValid && volume_unit > 0) {
        const total_vol_ul = volume * (volume_unit === 1 ? 1e6 : 1e3);
        if (total_vol_ul < 10) {
            errors.push("調製量が10μL未満です。実際の調製は困難です。より大きな量での調製を推奨します。");
        } else if (total_vol_ul < 100) {
            warnings.push("調製量が100μL未満です。ピペッティング精度にご注意ください。マイクロピペットの使用を推奨します。");
        }
        if (total_vol_ul > 1e9) {
            warnings.push("調製量が非現実的に大きいです（1 L超）。単位を確認してください。");
        }
    }

    // 希釈計算のチェック
    if (finalMolarityValid && final_molarity > 0 && molarityValid && molarity > 0) {
        const stock_conc = molarity * molarity_unit;
        const final_conc = final_molarity * final_molarity_unit;
        
        if (final_conc >= stock_conc) {
            errors.push("最終濃度がストック濃度以上です。希釈では実現できません。ストック濃度を上げるか最終濃度を下げてください。");
        }
        
        if (final_conc < stock_conc) {
            const dilution_factor = stock_conc / final_conc;
            if (dilution_factor > 10000) {
                warnings.push("希釈倍率が1万倍を超えています。段階希釈を検討してください。精度が低下する可能性があります。");
            } else if (dilution_factor < 2) {
                warnings.push("希釈倍率が2倍未満です。もう少し濃いストック溶液の方が良いかもしれません。");
            }
        }
    }
    
    // ピペッティング量のチェック
    if (finalMolarityValid && final_molarity > 0 && 
        finalVolumeValid && final_total_vol > 0 &&
        molarityValid && molarity > 0) {
        
        const C1 = molarity * molarity_unit;
        const C2 = final_molarity * final_molarity_unit;
        const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);
        const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
        
        if (V1 < 0.1) {
            errors.push("必要なストック溶液量が0.1μL未満です。正確なピペッティングは不可能です。ストック濃度を下げてください。");
        } else if (V1 < 1) {
            warnings.push("必要なストック溶液量が1μL未満です。高精度ピペット（0.1-2μL用）が必要です。");
        }
        
        if (V1 > V2 * 0.9) {
            warnings.push("ストック溶液の添加量が最終液量の90%を超えています。溶媒効果にご注意ください。");
        }
        
        if (volumeValid && volume > 0) {
            const stock_vol_ul = volume * (volume_unit === 1 ? 1e6 : 1e3);
            if (V1 > stock_vol_ul) {
                errors.push("必要なストック溶液量が調製量を超えています。ストック溶液をもっと作る必要があります。");
            } else if (V1 > stock_vol_ul * 0.8) {
                warnings.push("ストック溶液の80%以上を使用します。予備分を考慮して追加調製を推奨します。");
            }
        }
    }
    
    // 薬量チェック
    if (mwValid && molarityValid && volumeValid) {
        const molarity_molL = molarity * molarity_unit;
        const volume_L = volume * volume_unit;
        const mass_mg = mw * molarity_molL * volume_L * 1000;
        
        if (mass_mg < 0.1) {
            errors.push("必要な薬量が0.1mg未満です。分析天秤でも正確な秤量は困難です。濃度を下げるか量を増やしてください。");
        } else if (mass_mg < 1) {
            warnings.push("必要な薬量が1mg未満です。マイクロ天秤または母液調製法（高濃度で少量調製後希釈）を推奨します。");
        } else if (mass_mg > 1000) {
            warnings.push("必要な薬量が1gを超えています。容器サイズと溶解時間にご注意ください。段階的に溶解することを推奨します。");
        }
    }
    
    // セクションステータス更新
    const stockValid = mwValid && molarityValid && volumeValid;
    const stockHasErrors = errors.some(error => 
        error.includes('調製量') || error.includes('薬量') || error.includes('分子量')
    );
    
    if (stockHasErrors) {
        updateSectionStatus('stock', 'error');
    } else if (stockValid) {
        updateSectionStatus('stock', 'completed');
    } else {
        updateSectionStatus('stock', '');
    }
    
    const dilutionComplete = (finalMolarityValid && finalVolumeValid && 
        document.getElementById('final_molarity').value !== '' && 
        document.getElementById('final_total_vol').value !== '') ||
        (document.getElementById('final_molarity').value === '' && 
         document.getElementById('final_total_vol').value === '');
    
    const dilutionHasErrors = errors.some(error => 
        error.includes('最終濃度') || error.includes('ストック溶液量')
    );
    
    if (dilutionHasErrors) {
        updateSectionStatus('dilution', 'error');
    } else if (dilutionComplete && stockValid && !stockHasErrors) {
        updateSectionStatus('dilution', 'completed');
    } else {
        updateSectionStatus('dilution', '');
    }
    
    return { warnings, errors };
}

// バリデーションメッセージ表示関数
function updateValidationMessages(validation) {
    const container = document.getElementById('validation-messages');
    if (!container) return;
    
    let messageHTML = '';
    
    // エラーメッセージ
    validation.errors.forEach(error => {
        messageHTML += `<div class="validation-message error">⚠ ${error}</div>`;
    });
    
    // 警告メッセージ
    validation.warnings.forEach(warning => {
        messageHTML += `<div class="validation-message warning">💡 ${warning}</div>`;
    });
    
    container.innerHTML = messageHTML;
    currentValidation = validation;
}

// メイン計算・更新関数
function updateMainResults() {
    const mw = parseFloat(document.getElementById('mw').value);
    const molarity = parseFloat(document.getElementById('molarity').value);
    const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
    const volume = parseFloat(document.getElementById('volume').value);
    const volume_unit = parseFloat(document.getElementById('volume_unit').value);
    const final_molarity = parseFloat(document.getElementById('final_molarity').value);
    const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
    const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
    const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);

    let resultHTML = '';
    let hasResults = false;

    // ストック溶液計算
    if (!isNaN(mw) && mw > 0 && !isNaN(molarity) && molarity > 0 && !isNaN(volume) && volume > 0) {
        const molarity_molL = molarity * molarity_unit;
        const volume_L = volume * volume_unit;
        const mass_mg = mw * molarity_molL * volume_L * 1000;
        let solvent_ul = volume * (volume_unit === 1 ? 1000000 : 1000);

        resultHTML += `<div class="results-grid">
            <div class="result-item">
              <div class="result-label">必要な薬量</div>
              <div class="result-value">${formatMassSI(mass_mg)}</div>
            </div>
            <div class="result-item">
              <div class="result-label">溶媒量</div>
              <div class="result-value">${formatVolumeSI(solvent_ul)}</div>
            </div>`;

        hasResults = true;

        // ストックセクションの結果
        let stockResult = `<strong>ストック溶液調製:</strong> 薬 ${formatMassSI(mass_mg)} + 溶媒 ${formatVolumeSI(solvent_ul)}`;
        if (mass_mg < 1) {
            stockResult += '<br><span style="color: var(--warning-color);">⚠ 1mg未満のため母液調製法を推奨</span>';
        }
        showSectionResult('section-result-stock', stockResult);
    } else {
        showSectionResult('section-result-stock', null);
    }

    // 希釈計算
    if (!isNaN(molarity) && molarity > 0 && !isNaN(final_molarity) && final_molarity > 0 &&
        !isNaN(final_total_vol) && final_total_vol > 0) {
        const C1 = molarity * molarity_unit;
        const C2 = final_molarity * final_molarity_unit;
        const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);
        const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
        const V1_fixed = Math.max(0, V1);
        const diluent_uL = V2 - V1_fixed;

        if (hasResults) {
            resultHTML += `
                <div class="result-item">
                  <div class="result-label">ストック溶液</div>
                  <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">追加溶媒</div>
                  <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
                </div>
            `;
        } else {
            resultHTML += `
            <div class="results-grid">
                <div class="result-item">
                  <div class="result-label">ストック溶液</div>
                  <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
                </div>
                <div class="result-item">
                  <div class="result-label">追加溶媒</div>
                  <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
                </div>
            `;
        }
        resultHTML += '</div>';
        hasResults = true;

        // 希釈セクションの結果
        let dilutionResult = `<strong>希釈配合:</strong> ストック ${formatVolumeSI(V1_fixed)} + 溶媒 ${formatVolumeSI(diluent_uL)}`;
        if (V1_fixed < 1) {
            dilutionResult += '<br><span style="color: var(--warning-color);">⚠ 高精度ピペット必要</span>';
        }
        showSectionResult('section-result-dilution', dilutionResult);
    } else {
        showSectionResult('section-result-dilution', null);
    }

    if (hasResults) {
        if (!resultHTML.includes('</div>')) {
            resultHTML += '</div>';
        }
        document.getElementById('results-content').innerHTML = resultHTML;
    } else {
        document.getElementById('results-content').innerHTML = `
            <div class="results-placeholder">
              必要項目を入力すると、ここに結果が表示されます
            </div>
        `;
    }
    
    // バリデーションチェックを実行
    const validation = validateInputs();
    updateValidationMessages(validation);
}

function showSectionResult(containerId, content) {
    const container = document.getElementById(containerId);
    if (container) {
        if (content) {
            container.innerHTML = content;
            container.classList.add('show');
        } else {
            container.classList.remove('show');
        }
    }
}

function formatNumber(num) {
    if (num === 0) return "0";
    if (Math.abs(num) >= 1) {
        return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
    } else if (Math.abs(num) >= 0.01) {
        return num.toLocaleString(undefined, { maximumFractionDigits: 4 });
    } else {
        return num.toFixed(5).replace(/0+$/,"").replace(/\.$/,"");
    }
}

function formatVolumeSI(value_ul) {
    if (value_ul >= 1e6) {
        return `${formatNumber(value_ul / 1e6)} L`;
    } else if (value_ul >= 1e3) {
        return `${formatNumber(value_ul / 1e3)} mL`;
    } else if (value_ul >= 1) {
        return `${formatNumber(value_ul)} μL`;
    } else if (value_ul >= 1e-3) {
        return `${formatNumber(value_ul * 1e3)} nL`;
    } else if (value_ul > 0) {
        return `${formatNumber(value_ul * 1e6)} pL`;
    } else {
        return "0";
    }
}

function formatMassSI(value_mg) {
    if (value_mg >= 1000) {
        return `${formatNumber(value_mg / 1000)} g`;
    } else if (value_mg >= 1) {
        return `${formatNumber(value_mg)} mg`;
    } else if (value_mg >= 0.001) {
        return `${formatNumber(value_mg * 1000)} μg`;
    } else if (value_mg > 0) {
        return `${formatNumber(value_mg * 1e6)} ng`;
    } else {
        return "0";
    }
}

// 入力イベント
[
  "mw","molarity","molarity_unit","volume","volume_unit","mass_unit",
  "final_molarity","final_molarity_unit","final_total_vol","final_total_vol_unit"
].forEach(id => {
  if(document.getElementById(id)){
    document.getElementById(id).addEventListener('input', updateMainResults);
    document.getElementById(id).addEventListener('change', updateMainResults);
  }
});

// 初期化
updateMainResults();

// --- PC・スマホ対応：計算結果パネルの最小化/再表示 ---
const panel = document.getElementById('results-panel');
const minimizeBtn = document.getElementById('results-minimize');
const restoreBtn = document.getElementById('results-restore');
const showBtn = document.getElementById('results-show');

// 最小化ボタンのイベント
minimizeBtn.addEventListener('click', function() {
    panel.classList.add('minimized');
    if (window.innerWidth <= 768) {
        showBtn.style.display = 'block';
    }
});

// 復元ボタンのイベント（PC用）
restoreBtn.addEventListener('click', function() {
    panel.classList.remove('minimized');
});

// モバイル用の表示ボタン
showBtn.addEventListener('click', function() {
    panel.classList.remove('minimized');
    showBtn.style.display = 'none';
});

// PC用：最小化されたタイトルをクリックして復元
const resultsTitle = document.querySelector('.results-title');
resultsTitle.addEventListener('click', function() {
    if (window.innerWidth > 768 && panel.classList.contains('minimized')) {
        panel.classList.remove('minimized');
    }
});

// --- CID検索 ---
function fetchPubChem() {
    const cid = document.getElementById('cid').value.trim();
    const searchButton = document.querySelector('.btn-primary');
    const searchText = document.getElementById('search-text');
    if (!cid) {
        alert("CIDを入力してください。");
        document.getElementById('cid').focus();
        return;
    }
    searchText.innerHTML = '<span class="loading" aria-hidden="true"></span>検索中';
    searchButton.disabled = true;

    const originalEndpoint = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/MolecularWeight,IUPACName,Title,CanonicalSMILES,MolecularFormula/JSON`;
    const proxyEndpoint = `https://api.allorigins.win/get?url=${encodeURIComponent(originalEndpoint)}`;
    fetch(proxyEndpoint)
      .then(response => {
        if (!response.ok) throw new Error("情報が見つかりませんでした。");
        return response.json();
      })
      .then(proxyData => {
        const data = JSON.parse(proxyData.contents);
        const prop = data.PropertyTable.Properties[0];
        if (prop.CID) document.getElementById('cid').value = prop.CID;
        if (prop.MolecularWeight) document.getElementById('mw').value = prop.MolecularWeight;
        let infoHTML = "<table class='info-table' role='table'>";
        infoHTML += "<caption class='sr-only'>取得した薬物情報</caption>";
        infoHTML += `<tr><td class='info-label'>CID</td><td>${prop.CID ? prop.CID : "-"}</td></tr>`;
        infoHTML += `<tr><td class='info-label'>化学式</td><td>${prop.MolecularFormula ? prop.MolecularFormula : "-"}</td></tr>`;
        infoHTML += `<tr><td class='info-label'>分子量</td><td>${prop.MolecularWeight ? prop.MolecularWeight : "-"}</td></tr>`;
        if (prop.CanonicalSMILES)
            infoHTML += `<tr><td class='info-label'>SMILES</td><td style="word-break: break-all;">${prop.CanonicalSMILES}</td></tr>`;
        infoHTML += "</table>";
        document.getElementById('drug_info').innerHTML = infoHTML;
        document.getElementById('drug_info').style.display = "block";
        updateSectionStatus('search', 'completed');
        updateMainResults();
      })
      .catch(error => {
        document.getElementById('drug_info').style.display = "none";
        alert("薬物情報の取得に失敗しました: " + error.message);
        updateSectionStatus('search', 'error');
      })
      .finally(() => {
        searchText.textContent = '検索';
        searchButton.disabled = false;
      });
}
</script>
</body>
</html>
