<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- === MathJax (Êï∞ÂºèË°®Á§∫Áî®) === -->
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- === DOMPurify (XSSÈò≤Âæ°Áî®) === -->
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
    /* === prefers-reduced-motion ÂØæÂøú === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>YoshinovaCalc Lab - Universal Calculator</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230d6efd;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230b5ed7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='url(%23grad)' rx='6'/%3E%3Ccircle cx='8' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='6' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='12' cy='16' r='2' fill='%23fff'/%3E%3Ccircle cx='20' cy='14' r='2' fill='%23fff'/%3E%3Ccircle cx='8' cy='24' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='22' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='24' r='2' fill='%23fff'/%3E%3Cline x1='8' y1='8' x2='16' y2='6' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='24' y2='8' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='8' y1='8' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='24' y1='8' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='8' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='22' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3C/svg%3E">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --primary-bg-dark: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      --panel-bg: rgba(255, 255, 255, 0.85);
      --panel-bg-dark: rgba(30, 40, 50, 0.9);
      --border-color: rgba(255, 255, 255, 0.18);
      --border-color-dark: rgba(255, 255, 255, 0.1);
      --primary-text: #1a202c;
      --primary-text-dark: #e2e8f0;
      --secondary-text: #4a5568;
      --secondary-text-dark: #a0aec0;
      --muted-text: #718096;
      --muted-text-dark: #718096;
      --primary-blue: #4299e1;
      --primary-blue-hover: #3182ce;
      --primary-blue-focus: #2c5aa0;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-bg-dark: rgba(0, 0, 0, 0.3);
      --backdrop-blur: blur(10px);
      --card-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      --card-shadow-dark: 0 8px 32px rgba(0, 0, 0, 0.5);
      --neumorphism-light: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
      --neumorphism-dark: 20px 20px 60px #1e2a3a, -20px -20px 60px #364a5e;
    }

    [data-theme="dark"] {
      --panel-bg: var(--panel-bg-dark);
      --border-color: var(--border-color-dark);
      --primary-text: var(--primary-text-dark);
      --secondary-text: var(--secondary-text-dark);
      --muted-text: var(--muted-text-dark);
      --glass-bg: var(--glass-bg-dark);
      --card-shadow: var(--card-shadow-dark);
    }

    * {
      box-sizing: border-box;
      transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }

    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      color: var(--primary-text);
      background: var(--primary-bg);
      background-attachment: fixed;
      overflow-x: hidden;
    }

    body[data-theme="dark"] {
      background: var(--primary-bg-dark);
    }

    .container {
      max-width: 520px;
      margin: 2rem auto 1.5rem auto;
      padding: 2.5rem 2rem 2rem 2rem;
      background: var(--panel-bg);
      backdrop-filter: var(--backdrop-blur);
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      position: relative;
      z-index: 1;
      animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
      }
      50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 5px var(--warning-color);
      }
      50% {
        box-shadow: 0 0 20px var(--warning-color), 0 0 30px var(--warning-color);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .theme-toggle {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.3rem;
      transition: all 0.3s ease;
      backdrop-filter: var(--backdrop-blur);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .theme-toggle:hover::before {
      left: 100%;
    }

    .theme-toggle:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    h1 {
      color: var(--primary-blue);
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version-badge {
      display: inline-block;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      color: white;
      padding: 0.2rem 0.8rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .labicon {
      font-size: 1.3em;
      vertical-align: middle;
      animation: pulse 2s infinite;
    }

    .copyright {
      font-size: 0.8rem;
      color: var(--muted-text);
      margin-top: 0.8rem;
      opacity: 0.8;
    }

    /* üéØ Ë®àÁÆó„É¢„Éº„ÉâÈÅ∏Êäû„Çø„Éñ */
    .calculation-mode-tabs {
      display: flex;
      background: var(--glass-bg);
      border-radius: 12px;
      padding: 0.3rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      backdrop-filter: var(--backdrop-blur);
    }

    .tab-button {
      flex: 1;
      background: transparent;
      border: none;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--secondary-text);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tab-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .tab-button:hover::before {
      left: 100%;
    }

    .tab-button.active {
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
      transform: translateY(-1px);
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      pointer-events: none;
    }

    .tab-button:hover:not(.active) {
      background: rgba(66, 153, 225, 0.1);
      color: var(--primary-blue);
    }

    /* „É¢„Éº„ÉâÂàáÊõøÁî®„Ç≥„É≥„ÉÜ„Éä */
    .calculation-mode {
      display: none;
    }

    .calculation-mode.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0.6rem 1.1rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--secondary-text);
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: var(--backdrop-blur);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .toolbar-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .toolbar-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      color: var(--primary-blue);
      border-color: var(--primary-blue);
    }

    .toolbar-btn:hover::before {
      left: 100%;
    }

    .toolbar-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .toolbar-btn.active {
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      border-color: var(--primary-blue);
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
      transform: translateY(-1px);
    }

    .toolbar-btn.active::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      pointer-events: none;
    }

    .form-section {
      margin-bottom: 2rem;
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border-radius: 18px;
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue), var(--success-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .form-section.completed::before {
      transform: scaleX(1);
    }

    .form-section.completed {
      border-color: var(--success-color);
      box-shadow: 0 0 20px rgba(72, 187, 120, 0.2);
    }

    .form-section.has-warnings {
      border-color: var(--warning-color);
      background: linear-gradient(135deg, 
        var(--glass-bg), 
        rgba(237, 137, 54, 0.05)
      );
      animation: glow 2s infinite;
    }

    .form-section.has-errors {
      border-color: var(--error-color);
      background: linear-gradient(135deg, 
        var(--glass-bg), 
        rgba(245, 101, 101, 0.05)
      );
      animation: shake 0.5s ease-in-out;
    }

    .form-section h2 {
      margin: 0 0 1.2rem 0;
      color: var(--primary-blue);
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .section-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
    }

    .section-status {
      font-size: 0.75rem;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-weight: 600;
      margin-left: auto;
      transition: all 0.3s ease;
    }

    .section-status.completed {
      background: linear-gradient(45deg, var(--success-color), #68d391);
      color: white;
      box-shadow: 0 2px 10px rgba(72, 187, 120, 0.3);
    }

    .section-status.error {
      background: linear-gradient(45deg, var(--error-color), #fc8181);
      color: white;
      box-shadow: 0 2px 10px rgba(245, 101, 101, 0.3);
    }

    .section-status.warning {
      background: linear-gradient(45deg, var(--warning-color), #f6ad55);
      color: white;
      box-shadow: 0 2px 10px rgba(237, 137, 54, 0.3);
      animation: pulse 1.5s infinite;
    }

    .input-group {
      margin-bottom: 1.3rem;
      position: relative;
    }

    .input-label {
      color: var(--primary-text);
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      display: block;
      position: relative;
    }

    .required::after {
      content: " *";
      color: var(--error-color);
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .input-row {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-bottom: 0.3rem;
    }

    .input-with-status {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      flex: 1;
    }

    .input-with-unit {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      padding: 0.3rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .input-with-unit:focus-within {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      transform: translateY(-1px);
    }

    .input-with-unit input[type="number"] {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      padding: 0.8rem;
      color: var(--primary-text);
      font-weight: 500;
    }

    .input-with-unit select {
      border: none;
      background: var(--glass-bg);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      color: var(--secondary-text);
      font-weight: 500;
      cursor: pointer;
      outline: none;
      min-width: 80px;
    }

    .input-with-unit span {
      color: var(--muted-text);
      font-size: 0.9rem;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
    }

    input, select {
      font-size: 1rem;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      font-family: inherit;
      background: rgba(255, 255, 255, 0.8);
      color: var(--primary-text);
      transition: all 0.3s ease;
      min-height: 48px;
      font-weight: 500;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      transform: translateY(-2px);
    }

    input.valid {
      border-color: var(--success-color);
      background: rgba(72, 187, 120, 0.05);
    }

    input.invalid {
      border-color: var(--error-color) !important;
      background: rgba(245, 101, 101, 0.05);
      animation: shake 0.5s ease-in-out;
    }

    input.warning {
      border-color: var(--warning-color) !important;
      background: rgba(237, 137, 54, 0.05);
      animation: glow 1.5s infinite;
    }

    .input-status {
      font-size: 1.2rem;
      min-width: 24px;
      text-align: center;
      transition: all 0.3s ease;
      align-self: center;
    }

    .preset-chemicals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.6rem;
      margin-bottom: 1rem;
    }

    .preset-btn {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.7rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      color: var(--secondary-text);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .preset-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(66, 153, 225, 0.2), transparent);
      transition: left 0.4s;
    }

    .preset-btn:hover::before {
      left: 100%;
    }

    .preset-btn:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
    }

    .preset-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* „Éï„Ç£„Éº„É´„ÉâÁõ¥‰∏ã„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„ÇíÂ§ßÂπÖÂº∑Âåñ */
    .input-error-message, .input-warning-message {
      font-size: 0.85rem;
      min-height: 1.2em;
      margin-top: 0.4rem;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      line-height: 1.4;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: bounceIn 0.4s ease-out;
      border-left: 4px solid;
      backdrop-filter: var(--backdrop-blur);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .input-error-message {
      color: var(--error-color);
      background: linear-gradient(135deg, 
        rgba(245, 101, 101, 0.15), 
        rgba(245, 101, 101, 0.05)
      );
      border-left-color: var(--error-color);
    }

    .input-error-message::before {
      content: "‚ö†Ô∏è";
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .input-warning-message {
      color: var(--warning-color);
      background: linear-gradient(135deg, 
        rgba(237, 137, 54, 0.15), 
        rgba(237, 137, 54, 0.05)
      );
      border-left-color: var(--warning-color);
    }

    .input-warning-message::before {
      content: "üí°";
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    /* Á©∫„ÅÆÂ†¥Âêà„ÅØ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÆåÂÖ®„Å´Èö†„Åô */
    .input-error-message:empty, .input-warning-message:empty {
      display: none;
    }

    /* üéØ „É¢„É´ÊøÉÂ∫¶Ë®àÁÆóÂ∞ÇÁî®„ÅÆ„Çπ„Çø„Ç§„É´ */
    .concentration-display {
      background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(72, 187, 120, 0.1));
      border: 1px solid var(--primary-blue);
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      text-align: center;
      font-weight: 700;
      color: var(--primary-blue);
      backdrop-filter: var(--backdrop-blur);
      animation: bounceIn 0.4s ease-out;
    }

    .section-result {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      padding: 1rem 1.2rem;
      border-radius: 12px;
      margin-top: 1.2rem;
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
      color: var(--primary-text);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.4s ease;
      transform: translateY(-10px);
    }

    .section-result.show {
      opacity: 1;
      max-height: 300px;
      transform: translateY(0);
    }

    .section-result strong {
      color: var(--success-color);
      font-weight: 700;
    }

    .results-panel {
      position: fixed;
      top: 2rem;
      right: 2rem;
      width: 380px;
      max-width: 90vw;
      background: var(--panel-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      z-index: 999;
      animation: slideInRight 0.6s ease-out;
      transition: transform 0.3s cubic-bezier(.4,2,.6,1), max-height 0.4s ease;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .results-panel.minimized {
      transform: translateY(75%);
      max-height: 62px !important;
      min-height: 44px;
      overflow: hidden;
      opacity: 0.8;
      pointer-events: auto;
    }

    .results-panel.minimized .results-title {
      border-bottom: none;
    }

    .results-minimize-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: var(--glass-bg);
      border: 1.5px solid var(--border-color);
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 1px 8px rgba(66,153,225,0.12);
      backdrop-filter: var(--backdrop-blur);
    }

    .results-minimize-btn:hover {
      background: var(--primary-blue);
      color: #fff;
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
    }

    .results-minimize-btn:active {
      transform: scale(0.95);
    }

    .results-title {
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary-blue);
      font-size: 1.1rem;
      text-align: center;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0.5rem;
      position: relative;
    }

    .results-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
    }

    .results-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(2, 1fr);
    }

    .result-item {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .result-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-blue), var(--success-color));
    }

    .result-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--secondary-text);
      margin-bottom: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-value {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary-text);
      word-break: break-all;
    }

    .results-placeholder {
      text-align: center;
      color: var(--muted-text);
      font-style: italic;
      padding: 2rem 1rem;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 2px dashed var(--border-color);
      backdrop-filter: var(--backdrop-blur);
    }

    .btn {
      min-height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--glass-bg);
      color: var(--secondary-text);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-text);
      color: white;
    }

    .history-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
    }

    .history-item:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateX(5px);
    }

    .formula-display {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--primary-text);
      transition: all 0.3s ease;
    }

    .drug-info {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
    }

    .info-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .info-label {
      font-weight: 600;
      color: var(--secondary-text);
      width: 30%;
    }

    /* „Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞ÈÄöÁü•ÔºàÁ∑äÊÄ•ÊôÇÁî®Ôºâ */
    .floating-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 350px;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 1000;
      animation: bounceIn 0.5s ease-out;
      backdrop-filter: var(--backdrop-blur);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .floating-notification.success {
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.9), rgba(72, 187, 120, 0.7));
      color: white;
      border-left-color: var(--success-color);
    }

    .floating-notification.warning {
      background: linear-gradient(135deg, rgba(237, 137, 54, 0.9), rgba(237, 137, 54, 0.7));
      color: white;
      border-left-color: var(--warning-color);
    }

    .floating-notification.error {
      background: linear-gradient(135deg, rgba(245, 101, 101, 0.9), rgba(245, 101, 101, 0.7));
      color: white;
      border-left-color: var(--error-color);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .keyboard-shortcuts {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: var(--muted-text);
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .keyboard-shortcuts:hover {
      opacity: 1;
    }

    small {
      color: var(--muted-text);
      font-size: 0.8rem;
      line-height: 1.4;
    }

    @media (max-width: 1200px) {
      .results-panel {
        right: 1rem;
        width: 340px;
      }
    }

    @media (max-width: 768px) {
      .container {
        max-width: 95vw;
        padding: 1.5rem 1rem;
        margin: 1rem auto;
      }

      .results-panel {
        left: 0;
        right: 0;
        top: auto;
        bottom: 0;
        width: 100vw;
        max-width: 100vw;
        border-radius: 20px 20px 0 0;
        border-width: 1px 0 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        padding: 1.5rem 1rem 2rem 1rem;
        animation: slideInUp 0.6s ease-out;
      }

      .results-panel.minimized {
  	transform: translateY(0%);
  	max-height: 56px !important;
  	min-height: 44px;
  	opacity: 0.97;
  	pointer-events: auto;
  	bottom: 0;
  	left: 0;
  	right: 0;
	}


      .results-minimize-btn {
        width: 44px;
        height: 44px;
        font-size: 2rem;
        top: 8px;
        right: 8px;
      }

      .results-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .toolbar {
        justify-content: center;
      }

      .toolbar-btn {
        font-size: 0.7rem;
        padding: 0.5rem 0.9rem;
      }

      .keyboard-shortcuts {
        display: none;
      }

      .preset-chemicals {
        grid-template-columns: repeat(2, 1fr);
      }

      .floating-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .calculation-mode-tabs {
        flex-direction: column;
        gap: 0.3rem;
      }

      .tab-button {
        font-size: 0.8rem;
        padding: 0.6rem 0.8rem;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      .container {
        padding: 1rem 0.8rem;
      }

      .form-section {
        padding: 1rem;
      }

      .input-row {
        flex-direction: column;
        gap: 0.5rem;
      }

      .preset-chemicals {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Print styles */
    @media print {
      .results-panel,
      .toolbar,
      .theme-toggle,
      .keyboard-shortcuts,
      .calculation-mode-tabs {
        display: none !important;
      }

      .container {
        box-shadow: none;
        border: 1px solid #000;
        max-width: 100%;
        margin: 0;
      }

      body {
        background: white !important;
      }
    }
  </style>
</head>
<body>
<button id="theme-btn" class="theme-toggle" aria-label="Áπù„Éª„ÉªÁπùÊß´„ÉªË≠ñÔΩø">ÓÅûÊäΩ</button>
  <div class="container">
    <header class="header">
      <div class="theme-toggle" onclick="toggleTheme()" title="„ÉÜ„Éº„ÉûÂàáÊõø (Ctrl+D)">
        <span id="theme-icon">üíä</span>
      </div>
      <h1>
        YoshinovaCalc Lab Ver.1.1
      </h1>
      <div class="copyright">
        ¬© 2025 Fumihiko Yoshino. All Rights Reserved. Update:2025-06-06
      </div>
    </header>

    <!-- üéØ Ë®àÁÆó„É¢„Éº„ÉâÈÅ∏Êäû„Çø„Éñ -->
    <div class="calculation-mode-tabs">
      <button class="tab-button active" onclick="switchCalculationMode('stock')" id="tab-stock">
        üî¨ „Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë™øË£Ω
      </button>
      <button class="tab-button" onclick="switchCalculationMode('molarity')" id="tab-molarity">
        üß™ „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó
      </button>
    </div>

    <div class="toolbar">
      <button class="toolbar-btn" id="formula-btn" onclick="toggleFormula()" title="Ë®àÁÆóÂºèË°®Á§∫ (Ctrl+F)">
        üìê Ë®àÁÆóÂºè
      </button>
      <button class="toolbar-btn" id="history-btn" onclick="toggleHistory()" title="Â±•Ê≠¥Ë°®Á§∫ (Ctrl+H)">
        üìã Â±•Ê≠¥
      </button>
      <button class="toolbar-btn" onclick="exportResults()" title="PDFÂá∫Âäõ (Ctrl+P)">
        üìÑ PDFÂá∫Âäõ
      </button>
      <button class="toolbar-btn" onclick="clearAll()" title="„É™„Çª„ÉÉ„Éà (Ctrl+R)">
        üóëÔ∏è „É™„Çª„ÉÉ„Éà
      </button>
    </div>

    <main id="main-content">
      <!-- üî¨ „Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë™øË£Ω„É¢„Éº„Éâ -->
      <div id="stock-mode" class="calculation-mode active">
        <!-- „Çà„Åè‰ΩøÁî®„Åï„Çå„ÇãÂåñÂêàÁâ©„ÅÆ„Éó„É™„Çª„ÉÉ„Éà -->
        <section class="form-section" id="section-presets">
          <h2>
            <div class="section-icon">‚ö°</div>
            „ÇØ„Ç§„ÉÉ„ÇØ„Éó„É™„Çª„ÉÉ„Éà
          </h2>
          <div class="preset-chemicals">
            <button class="preset-btn" onclick="applyPreset('4-OH-TEMPO', 157.25)">4-OH-TEMPO</button>
            <button class="preset-btn" onclick="applyPreset('CYPMPO', 225.32)">CYPMPO</button>
            <button class="preset-btn" onclick="applyPreset('L-histidine', 155.15)">L-histidine</button>
            <button class="preset-btn" onclick="applyPreset('Phloxine B', 641.83)">Phloxine B</button>
            <button class="preset-btn" onclick="applyPreset('Rose Bengal', 1017.60)">Rose Bengal</button>
            <button class="preset-btn" onclick="applyPreset('TEMPOL', 172.24)">TEMPOL</button>
          </div>
        </section>

        <!-- „Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë®≠ÂÆö -->
        <section class="form-section" id="section-stock" role="region" aria-labelledby="stock-heading">
          <h2 id="stock-heading">
            <div class="section-icon">üî¨</div>
            „Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë®≠ÂÆö
            <span class="section-status" id="status-stock"></span>
          </h2>
          <div class="input-group">
            <label for="mw" class="input-label required">ÂàÜÂ≠êÈáèÔºàg/molÔºâ</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="mw" step="0.01" placeholder="ÂàÜÂ≠êÈáè" required inputmode="decimal" accesskey="m">
                  <span>g/mol</span>
                </div>
                <span class="input-status" id="status-mw"></span>
                <div class="input-error-message" id="error-mw"></div>
              </div>
            </div>
            <small>Áâ©Ë≥™„ÅÆÂàÜÂ≠êÈáè„Çíg/molÂçò‰Ωç„ÅßÂÖ•Âäõ (Shortcut: Alt+M)</small>
          </div>

          <div class="input-group">
            <label for="molarity" class="input-label required">„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÅÆ„É¢„É´ÊøÉÂ∫¶</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="molarity" step="any" min="0" placeholder="ÊøÉÂ∫¶" required inputmode="decimal" accesskey="c">
                  <select id="molarity_unit" aria-label="ÊøÉÂ∫¶„ÅÆÂçò‰Ωç">
                    <option value="1">mol/L</option>
                    <option value="0.001">mmol/L</option>
                    <option value="0.000001">Œºmol/L</option>
                    <option value="0.000000001">nmol/L</option>
                  </select>
                </div>
                <span class="input-status" id="status-molarity"></span>
                <div class="input-error-message" id="error-molarity"></div>
              </div>
            </div>
            <small>Ë™øË£Ω„Åó„Åü„ÅÑ„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÅÆÊøÉÂ∫¶„ÇíÂÖ•Âäõ (Shortcut: Alt+C)</small>
          </div>

          <div class="input-group">
            <label for="volume" class="input-label required">„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="volume" step="any" min="0" placeholder="Ë™øË£ΩÈáè" required inputmode="decimal" accesskey="v">
                  <select id="volume_unit" aria-label="‰ΩìÁ©ç„ÅÆÂçò‰Ωç">
                    <option value="0.001">mL</option>
                    <option value="1">L</option>
                  </select>
                </div>
                <span class="input-status" id="status-volume"></span>
                <div class="input-error-message" id="error-volume"></div>
              </div>
            </div>
            <small>Ë™øË£Ω„Åó„Åü„ÅÑ„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÅÆÁ∑èÈáè„ÇíÂÖ•Âäõ (Shortcut: Alt+V)</small>
          </div>

          <div class="input-group">
            <label for="mass_unit" class="input-label">Ë°®Á§∫Âçò‰ΩçÔºàÂøÖË¶Å„Å™Ëñ¨ÈáèÔºâ</label>
            <div class="input-row">
              <select id="mass_unit" aria-label="Ë≥™Èáè„ÅÆË°®Á§∫Âçò‰Ωç" style="width:7em;">
                <option value="mg">mg</option>
                <option value="g">g</option>
                <option value="Œºg">Œºg</option>
              </select>
            </div>
          </div>

          <div id="section-result-stock" class="section-result" aria-live="polite"></div>
        </section>

        <!-- Â∏åÈáàË®àÁÆó -->
        <section class="form-section" id="section-dilution" role="region" aria-labelledby="dilution-heading">
          <h2 id="dilution-heading">
            <div class="section-icon">üíß</div>
            Â∏åÈáàË®àÁÆóÔºà‰ªªÊÑèÔºâ
            <span class="section-status" id="status-dilution"></span>
          </h2>
          <div class="input-group">
            <label for="final_molarity" class="input-label">ÂÆüÈ®ì„Åß„ÅÆÊúÄÁµÇÊøÉÂ∫¶</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="final_molarity" step="any" min="0" placeholder="‰æã: 5" inputmode="decimal" accesskey="f">
                  <select id="final_molarity_unit" aria-label="ÊúÄÁµÇÊøÉÂ∫¶„ÅÆÂçò‰Ωç">
                    <option value="1">mol/L</option>
                    <option value="0.001">mmol/L</option>
                    <option value="0.000001">Œºmol/L</option>
                    <option value="0.000000001">nmol/L</option>
                  </select>
                </div>
                <span class="input-status" id="status-final-molarity"></span>
                <div class="input-error-message" id="error-final-molarity"></div>
              </div>
            </div>
            <small>ÂÆüÈ®ì„Åß‰ΩøÁî®„Åó„Åü„ÅÑÊúÄÁµÇÊøÉÂ∫¶„ÇíÂÖ•Âäõ (Shortcut: Alt+F)</small>
          </div>

          <div class="input-group">
            <label for="final_total_vol" class="input-label">Â∏åÈáàÂæåÁ∑èÈáèÔºàÊ∫∂Â™íÔºã„Çµ„É≥„Éó„É´Ôºâ</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="final_total_vol" step="any" min="0" placeholder="‰æã: 100" inputmode="decimal" accesskey="t">
                  <select id="final_total_vol_unit" aria-label="Â∏åÈáàÂæåÁ∑èÈáè„ÅÆÂçò‰Ωç">
                    <option value="0.001">ŒºL</option>
                    <option value="1">mL</option>
                  </select>
                </div>
                <span class="input-status" id="status-final-volume"></span>
                <div class="input-error-message" id="error-final-total-vol"></div>
              </div>
            </div>
            <small>Ê∫∂Â™í„Å´„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÇíÊ∑ªÂä†„Åó„ÅüÂæå„ÅÆÊúÄÁµÇÁ∑èÊ∂≤Èáè„ÇíÂÖ•Âäõ (Shortcut: Alt+T)</small>
          </div>

          <div id="section-result-dilution" class="section-result" aria-live="polite"></div>
        </section>

        <!-- CIDÊ§úÁ¥¢„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <section class="form-section" id="section-search" role="region" aria-labelledby="search-heading">
          <h2 id="search-heading">
            <div class="section-icon">üîç</div>
            Ëñ¨Áâ©ÊÉÖÂ†±Ê§úÁ¥¢ÔºàCID„Ç≥„Éº„ÉâÔºâ
            <span class="section-status" id="status-search"></span>
          </h2>
          <div class="input-group">
            <label for="cid" class="input-label">CID„Ç≥„Éº„Éâ</label>
            <div class="input-row">
              <div class="input-with-status" style="flex-direction: column;">
                <input type="text" id="cid" autocomplete="off" placeholder="‰æã: 54670067" aria-describedby="cid-help" accesskey="s">
                <span class="input-status" id="status-cid"></span>
                <div class="input-error-message" id="error-cid"></div>
              </div>
              <button class="btn btn-primary" type="button" onclick="fetchPubChem()">
                <span id="search-text">Ê§úÁ¥¢</span>
              </button>
            </div>
            <small id="cid-help">PubChem„ÅÆCompound ID„ÇíÂÖ•Âäõ (Shortcut: Alt+S)</small>
          </div>
          <div id="drug_info" class="drug-info" style="display:none;" role="region" aria-labelledby="drug-info-heading">
            <h3 id="drug-info-heading" class="sr-only">ÂèñÂæó„Åó„ÅüËñ¨Áâ©ÊÉÖÂ†±</h3>
          </div>
        </section>
      </div>

      <!-- üß™ „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó„É¢„Éº„Éâ -->
      <div id="molarity-mode" class="calculation-mode">
        <section class="form-section" id="section-molarity-info">
          <h2>
            <div class="section-icon">üí°</div>
            Ë®àÁÆóÊâãÈ†Ü
          </h2>
          <div style="background: rgba(66, 153, 225, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
            <strong>„Çπ„ÉÜ„ÉÉ„Éó:</strong><br>
            1. Ë≥™ÈáèÊøÉÂ∫¶ (mg/mL) = Ëñ¨Áâ©Èáè √∑ Ê∂≤Èáè<br>
            2. „É¢„É´ÊøÉÂ∫¶ (mol/L) = Ë≥™ÈáèÊøÉÂ∫¶ (mg/mL) √∑ ÂàÜÂ≠êÈáè (g/mol)
          </div>
        </section>

        <section class="form-section" id="section-molarity-calc">
          <h2>
            <div class="section-icon">üß™</div>
            ÂàÜÂ≠êÈáè„ÉªËñ¨Áâ©Èáè„ÉªÊ∂≤ÈáèÂÖ•Âäõ
            <span class="section-status" id="status-molarity-calc"></span>
          </h2>
          
          <div class="input-group">
            <label for="molecular_weight" class="input-label required">ÂàÜÂ≠êÈáè</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number"
                         id="molecular_weight"
                         step="0.01"
                         placeholder="‰æã: 300.0"
                         required
                         inputmode="decimal">
                  <span>g/mol</span>
                </div>
                <span class="input-status" id="status-molecular-weight"></span>
                <div class="input-error-message" id="error-molecular-weight"></div>
              </div>
            </div>
            <small>Ëñ¨Áâ©„ÅÆÂàÜÂ≠êÈáèÔºà„ÉÄ„É´„Éà„É≥ÂÄ§„Å®Âêå„ÅòÔºâ</small>
          </div>
          <div class="input-group">
            <label for="drug_amount" class="input-label required">Ëñ¨Áâ©Èáè</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="drug_amount" step="0.0001" placeholder="‰æã: 10.0" required inputmode="decimal">
                  <select id="drug_unit" aria-label="Ëñ¨Áâ©Èáè„ÅÆÂçò‰Ωç">
                    <option value="mg" selected>mg</option>
                    <option value="g">g</option>
                    <option value="Œºg">Œºg</option>
                    <option value="ng">ng</option>
                    <option value="kg">kg</option>
                  </select>
                </div>
                <span class="input-status" id="status-drug-amount"></span>
                <div class="input-error-message" id="error-drug-amount"></div>
              </div>
            </div>
            <small>Ëñ¨Áâ©„ÅÆÁ∑èÈáçÈáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
          </div>

          <div class="input-group">
            <label for="liquid_volume" class="input-label required">Ê∂≤ÈáèÔºàÊ∫∂Â™íÈáèÔºâ</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="liquid_volume" step="0.0001" placeholder="‰æã: 10.0" required inputmode="decimal">
                  <select id="liquid_unit" aria-label="Ê∂≤Èáè„ÅÆÂçò‰Ωç">
                    <option value="mL" selected>mL</option>
                    <option value="L">L</option>
                    <option value="ŒºL">ŒºL</option>
                    <option value="nL">nL</option>
                    <option value="dL">dL</option>
                  </select>
                </div>
                <span class="input-status" id="status-liquid-volume"></span>
                <div class="input-error-message" id="error-liquid-volume"></div>
              </div>
            </div>
            <small>Ëñ¨Áâ©„ÇíÊ∫∂Ëß£„Åô„ÇãÊ∫∂Â™í„ÅÆ‰ΩìÁ©ç</small>
          </div>

          <div id="concentration-display" class="concentration-display" style="display: none;" aria-live="polite">
            Ë≥™ÈáèÊøÉÂ∫¶: <span id="concentration-value">-</span> mg/mL
          </div>

            <div class="input-group">
            <label for="drug_name" class="input-label">Ëñ¨Áâ©ÂêçÔºà‰ªªÊÑèÔºâ</label>
            <div class="input-row">
              <input type="text" id="drug_name" placeholder="‰æã: „Ç¢„Çπ„Éî„É™„É≥" style="width: 100%;">
            </div>
            <small>Ë®àÁÆóÁµêÊûú„ÅÆË°®Á§∫Áî®</small>
          </div>
        </section>
      </div>

      <!-- Ë®àÁÆóÂºèË°®Á§∫„Ç®„É™„Ç¢ -->
      <div id="formula-display" class="formula-display" style="display:none;">
        <h3>üí° Ë®àÁÆóÂºè</h3>
        <div id="formula-content"></div>
      </div>

      <!-- Â±•Ê≠¥Ë°®Á§∫„Ç®„É™„Ç¢ -->
      <div id="history-panel" class="history-panel" style="display:none;">
        <h3>üìã Ë®àÁÆóÂ±•Ê≠¥</h3>
        <div id="history-content"></div>
        <button class="btn btn-secondary" onclick="clearHistory()" style="width: 100%; margin-top: 1rem;">
          Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
        </button>
      </div>
    </main>
  </div>

  <!-- Ë®àÁÆóÁµêÊûú„Éë„Éç„É´ÔºöPCÂè≥‰∏ä/„Çπ„Éû„Éõ‰∏ãÈÉ®„Å´ËøΩÂæì -->
  <div class="results-panel" id="results-panel">
    <button id="results-minimize-btn"
            class="results-minimize-btn"
            title="ÁµêÊûú„Éë„Éç„É´„ÇíÊúÄÂ∞èÂåñ"
            aria-label="ÁµêÊûú„Éë„Éç„É´„ÇíÊúÄÂ∞èÂåñ"
            type="button">
      <span id="results-minimize-icon">‚ñº</span>
    </button>
    <div class="results-title">‚öóÔ∏è Ë®àÁÆóÁµêÊûú</div>
    <div id="results-content">
      <div class="results-placeholder">
        ÂøÖË¶ÅÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
      </div>
    </div>
  </div>

  <!-- „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàË°®Á§∫ -->
  <div class="keyboard-shortcuts">
    üí° Ctrl+D: „ÉÜ„Éº„ÉûÂàáÊõø | Ctrl+F: Ë®àÁÆóÂºè | Ctrl+H: Â±•Ê≠¥ | Ctrl+R: „É™„Çª„ÉÉ„Éà
  </div>

<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentValidation = { warnings: [], errors: [] };
let calculationHistory = JSON.parse(localStorage.getItem('molarity-calc-history') || '[]');
let isDarkMode = localStorage.getItem('theme') === 'dark';
let activeStates = {
  formula: false,
  history: false
};
let currentCalculationMode = 'stock'; // 'stock' „Åæ„Åü„ÅØ 'molarity'

// üéØ „É¢„É´ÊøÉÂ∫¶Ë®àÁÆóÁî®„ÅÆÂçò‰ΩçÂ§âÊèõ‰øÇÊï∞
const drugUnitFactors = {
  'mg': 1,
  'g': 1000,
  'Œºg': 0.001,
  'ng': 0.000001,
  'kg': 1000000
};

const volumeUnitFactors = {
  'mL': 1,
  'L': 1000,
  'ŒºL': 0.001,
  'nL': 0.000001,
  'dL': 100
};

// üéØ ÂÆåÂÖ®„Å´‰øÆÊ≠£„Åï„Çå„ÅüÊúÄÂ∞èÂåñ„Éú„Çø„É≥Ê©üËÉΩ
function initializeResultsMinimizeButton() {
  const resultsPanel = document.getElementById('results-panel');
  const minimizeBtn = document.getElementById('results-minimize-btn');
  const minimizeIcon = document.getElementById('results-minimize-icon');
  const resultsTitle = document.querySelector('.results-title'); // ‚òÖËøΩÂä†

  if (!resultsPanel || !minimizeBtn || !minimizeIcon || !resultsTitle) {
    console.error('ÁµêÊûú„Éë„Éç„É´„Åæ„Åü„ÅØÊúÄÂ∞èÂåñ„Éú„Çø„É≥„ÅÆË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    return;
  }

  function setResultsPanelMinimized(minimized) {
    if (minimized) {
      resultsPanel.classList.add('minimized');
      minimizeIcon.textContent = '‚ñ≤';
      minimizeBtn.title = 'ÁµêÊûú„Éë„Éç„É´„ÇíÂÖÉ„Å´Êàª„Åô';
      minimizeBtn.setAttribute('aria-label', 'ÁµêÊûú„Éë„Éç„É´„ÇíÂÖÉ„Å´Êàª„Åô');
      resultsTitle.innerHTML = '‚ñ≤ Ë®àÁÆóÁµêÊûú„ÇíÈñã„ÅèÔºà„Çø„ÉÉ„ÉóÔºâ'; // „Éí„É≥„Éà„Åä„Åô„Åô„ÇÅ
      localStorage.setItem('results-panel-minimized', 'true');
    } else {
      resultsPanel.classList.remove('minimized');
      minimizeIcon.textContent = '‚ñº';
      minimizeBtn.title = 'ÁµêÊûú„Éë„Éç„É´„ÇíÊúÄÂ∞èÂåñ';
      minimizeBtn.setAttribute('aria-label', 'ÁµêÊûú„Éë„Éç„É´„ÇíÊúÄÂ∞èÂåñ');
      resultsTitle.innerHTML = (currentCalculationMode === 'stock')
        ? '‚öóÔ∏è Ë®àÁÆóÁµêÊûú'
        : 'üß™ „É¢„É´ÊøÉÂ∫¶ÁµêÊûú';
      localStorage.setItem('results-panel-minimized', 'false');
    }
  }

  // ‚òÖ„Åì„ÅìÔºÅ
  minimizeBtn.addEventListener('click', function(event) {
    event.preventDefault();
    event.stopPropagation();
    const isCurrentlyMinimized = resultsPanel.classList.contains('minimized');
    setResultsPanelMinimized(!isCurrentlyMinimized);
  });

  // ‚òÖ„Åì„Åì„ÇÇÔºÅ
  resultsTitle.addEventListener('click', function() {
    if (resultsPanel.classList.contains('minimized')) {
      setResultsPanelMinimized(false);
    }
  });

  // ÂàùÊúüÁä∂ÊÖã„ÅÆÂæ©ÂÖÉ
  const shouldBeMinimized = localStorage.getItem('results-panel-minimized') === 'true';
  setResultsPanelMinimized(shouldBeMinimized);
  
  console.log('ÁµêÊûú„Éë„Éç„É´„ÅÆÊúÄÂ∞èÂåñ„Éú„Çø„É≥„ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
}


// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅÂàùÊúüÂåñÈñãÂßã...');
  
  if (isDarkMode) {
    document.body.setAttribute('data-theme', 'dark');
    document.getElementById('theme-icon').textContent = 'üî¨';
  }
  
  loadHistory();
  setupKeyboardShortcuts();
  setupMolarityCalculationListeners();
  updateResultsPanelTitle();
  
  // üéØ ÊúÄÂ∞èÂåñ„Éú„Çø„É≥„ÅÆÂàùÊúüÂåñÔºà‰øÆÊ≠£ÁâàÔºâ
  initializeResultsMinimizeButton();
  
  console.log('ÂàùÊúüÂåñÂÆå‰∫Ü');
});

// üéØ results-panel„ÅÆ„Çø„Ç§„Éà„É´„Çí„É¢„Éº„Éâ„Å´Âøú„Åò„Å¶Â§âÊõ¥
function updateResultsPanelTitle() {
  const resultsTitle = document.querySelector('.results-title');
  // „ÇÇ„ÅóÊúÄÂ∞èÂåñ‰∏≠„Å™„Çâ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
  if (document.getElementById('results-panel').classList.contains('minimized')) return;
  if (currentCalculationMode === 'stock') {
    resultsTitle.innerHTML = '‚öóÔ∏è Ë®àÁÆóÁµêÊûú';
  } else {
    resultsTitle.innerHTML = 'üß™ „É¢„É´ÊøÉÂ∫¶ÁµêÊûú';
  }
}

// üéØ Ë®àÁÆó„É¢„Éº„ÉâÂàáÊõø
function switchCalculationMode(mode) {
  currentCalculationMode = mode;
  
  // „Çø„Éñ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`tab-${mode}`).classList.add('active');
  
  // „É¢„Éº„ÉâË°®Á§∫ÂàáÊõø
  document.querySelectorAll('.calculation-mode').forEach(el => el.classList.remove('active'));
  document.getElementById(`${mode}-mode`).classList.add('active');
  
  // ÁµêÊûú„Çí„ÇØ„É™„Ç¢
  clearModeResults();
  
  // üéØ results-panel„ÅÆ„Çø„Ç§„Éà„É´Êõ¥Êñ∞
  updateResultsPanelTitle();
  
  // Ë®àÁÆóÂºè„ÅÆÊõ¥Êñ∞
  if (activeStates.formula) {
    updateFormulaDisplay();
  }
  
  showFloatingNotification(
    mode === 'stock' ? '„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë™øË£Ω„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü' : '„É¢„É´ÊøÉÂ∫¶Ë®àÁÆó„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü', 
    'success'
  );
  
  // üéØ „É¢„Éº„ÉâÂàáÊõøÂæå„Å´Ë®àÁÆó„ÇíÂÜçÂÆüË°å
  if (mode === 'stock') {
    updateMainResults();
  } else {
    calculateMolarity();
  }
}

function clearModeResults() {
  // results-panel„ÅÆÁµêÊûú„Çí„ÇØ„É™„Ç¢
  document.getElementById('results-content').innerHTML = `
    <div class="results-placeholder">
      ÂøÖË¶ÅÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
    </div>
  `;
  
  // „É¢„É´ÊøÉÂ∫¶„É¢„Éº„Éâ„ÅÆË≥™ÈáèÊøÉÂ∫¶Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
  const concentrationDisplay = document.getElementById('concentration-display');
  if (concentrationDisplay) {
    concentrationDisplay.style.display = 'none';
  }
}

// „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø
function toggleTheme() {
  isDarkMode = !isDarkMode;
  if (isDarkMode) {
    document.body.setAttribute('data-theme', 'dark');
    document.getElementById('theme-icon').textContent = 'üî¨';
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.removeAttribute('data-theme');
    document.getElementById('theme-icon').textContent = 'üíä';
    localStorage.setItem('theme', 'light');
  }
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàË®≠ÂÆö
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'd':
          e.preventDefault();
          toggleTheme();
          break;
        case 'f':
          e.preventDefault();
          toggleFormula();
          break;
        case 'h':
          e.preventDefault();
          toggleHistory();
          break;
        case 'r':
          e.preventDefault();
          clearAll();
          break;
        case 'p':
          e.preventDefault();
          exportResults();
          break;
        case '1':
          e.preventDefault();
          switchCalculationMode('stock');
          break;
        case '2':
          e.preventDefault();
          switchCalculationMode('molarity');
          break;
      }
    }
  });
}

// „Éó„É™„Çª„ÉÉ„ÉàÈÅ©Áî®
function applyPreset(name, mw) {
  if (currentCalculationMode === 'stock') {
    document.getElementById('mw').value = mw;
    updateMainResults();
  } else {
    document.getElementById('molecular_weight').value = mw;
    document.getElementById('drug_name').value = name;
    calculateMolarity();
  }
  showFloatingNotification(`${name} (MW: ${mw}) „Åå„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü`, 'success');
}

// üéØ ÊîπÂñÑ„Åï„Çå„ÅüÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
function showFloatingNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = `floating-notification ${type}`;
  
  const icon = type === 'error' ? '‚ö†Ô∏è' : type === 'warning' ? 'üí°' : '‚úÖ';
  notification.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100px)';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// Ë®àÁÆóÂºèË°®Á§∫ÂàáÊõø
function toggleFormula() {
  activeStates.formula = !activeStates.formula;
  if (activeStates.formula) {
    updateFormulaDisplay();
    document.getElementById('formula-display').style.display = 'block';
    document.getElementById('formula-btn').classList.add('active');
  } else {
    document.getElementById('formula-display').style.display = 'none';
    document.getElementById('formula-btn').classList.remove('active');
  }
}

function updateFormulaDisplay() {
  const formulaContent = document.getElementById('formula-content');

  if (currentCalculationMode === 'stock') {
    // ÂÖ•ÂäõÂÄ§ÂèñÂæó
    const mw = document.getElementById('mw').value;
    const molarity = document.getElementById('molarity').value;
    const molarity_unit_el = document.getElementById('molarity_unit');
    const molarity_unit_txt = molarity_unit_el.options[molarity_unit_el.selectedIndex].text;
    const molarity_unit_val = parseFloat(molarity_unit_el.value);
    const volume = document.getElementById('volume').value;
    const volume_unit_el = document.getElementById('volume_unit');
    const volume_unit_txt = volume_unit_el.options[volume_unit_el.selectedIndex].text;
    const volume_unit_val = parseFloat(volume_unit_el.value);

    // Â∏åÈáàË®àÁÆóÁî®
    const final_molarity = document.getElementById('final_molarity').value;
    const final_molarity_unit = document.getElementById('final_molarity_unit');
    const final_molarity_unit_txt = final_molarity_unit.options[final_molarity_unit.selectedIndex].text;
    const final_total_vol = document.getElementById('final_total_vol').value;
    const final_total_vol_unit = document.getElementById('final_total_vol_unit');
    const final_total_vol_unit_txt = final_total_vol_unit.options[final_total_vol_unit.selectedIndex].text;

    // ‰ΩìÁ©çLÊèõÁÆó
    let volume_L = "";
    if (volume && volume_unit_val) {
      volume_L = (parseFloat(volume) * volume_unit_val).toFixed(6);
    }

    // „É¢„É´ÊøÉÂ∫¶mol/LÊèõÁÆó
    let molarity_molL = "";
    if (molarity && molarity_unit_val) {
      molarity_molL = (parseFloat(molarity) * molarity_unit_val).toExponential(6);
    }

    // ÂøÖË¶ÅËñ¨ÈáèÔºàgÔºâË®àÁÆó
    let mass = "";
    if (mw && molarity && molarity_unit_val && volume && volume_unit_val) {
      mass = (parseFloat(mw) * parseFloat(molarity) * molarity_unit_val * parseFloat(volume) * volume_unit_val).toFixed(6);
    }

    // ÂøÖË¶ÅËñ¨Èáè„ÅÆ‰æã
    let stockExample = '';
    if (mw && molarity && volume) {
      stockExample = `
        <div style="margin-top:0.6em;">
          ‰æã: <b>${mw}</b> (g/mol) √ó <b>${molarity}</b> (${molarity_unit_txt}) √ó <b>${volume}</b> (${volume_unit_txt})
          <br>Ôºù <b>${mw}</b> (g/mol) √ó <b>${molarity_molL}</b> (mol/L) √ó <b>${volume_L}</b> (L)
          <br>Ôºù <span style="color:#38a169;font-weight:bold;">${mass} g</span>
        </div>
        <div style="color:#555;font-size:0.95em;">
          ‚Äª‰ΩìÁ©ç„ÉªÊøÉÂ∫¶„ÅØËá™Âãï„ÅßSIÂçò‰Ωç(L, mol/L)„Å´ÊèõÁÆó
        </div>
      `;
    }

    // Â∏åÈáàË®àÁÆó„ÅÆ‰æã
    let dilutionExample = '';
    if (final_molarity && final_total_vol && molarity) {
      dilutionExample = `
        <div style="margin-top:0.6em;">
          ‰æã: <b>${final_molarity}</b> √ó <b>${final_total_vol}</b> √∑ <b>${molarity}</b> = <span style="color:#3182ce;font-weight:bold;">${(final_molarity * final_total_vol / molarity).toFixed(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[Âçò‰Ωç: ${final_molarity_unit_txt}, ${final_total_vol_unit_txt}, ${molarity_unit_txt}]</div>
      `;
    }

    // Â∏åÈáàÂÄçÁéá„ÅÆ‰æã
    let factorExample = '';
    if (molarity && final_molarity) {
      factorExample = `
        <div style="margin-top:0.6em;">
          ‰æã: <b>${molarity}</b> √∑ <b>${final_molarity}</b> = <span style="color:#ed8936;font-weight:bold;">${(molarity / final_molarity).toFixed(2)} ÂÄç</span>
        </div>
      `;
    }

    // „Åì„Åì„Åß„Åæ„Å®„ÇÅ„Å¶HTML„Å´„Çª„ÉÉ„Éà
    formulaContent.innerHTML = `
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">
          ÂøÖË¶ÅËñ¨Èáè (g) = ÂàÜÂ≠êÈáè (g/mol) √ó „É¢„É´ÊøÉÂ∫¶ (mol/L) √ó ‰ΩìÁ©ç (L)
        </span>
        ${stockExample}
      </div>
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">Â∏åÈáàË®àÁÆó: V<sub>1</sub> = (C<sub>2</sub> √ó V<sub>2</sub>) √∑ C<sub>1</sub></span>
        ${dilutionExample}
        <div style="color:#718096;font-size:0.9em;">V<sub>1</sub>: ÂøÖË¶Å„Å™„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè, C<sub>1</sub>: „Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶, C<sub>2</sub>: ÊúÄÁµÇÊøÉÂ∫¶, V<sub>2</sub>: ÊúÄÁµÇ‰ΩìÁ©ç</div>
      </div>
      <div>
        <span style="font-weight:bold;">Â∏åÈáàÂÄçÁéá = „Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶ √∑ ÊúÄÁµÇÊøÉÂ∫¶</span>
        ${factorExample}
      </div>
    `;
  } else {
    // „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó„É¢„Éº„Éâ
    const drug_amount = document.getElementById('drug_amount').value;
    const drug_unit = document.getElementById('drug_unit').value;
    const liquid_volume = document.getElementById('liquid_volume').value;
    const liquid_unit = document.getElementById('liquid_unit').value;
    const molecular_weight = document.getElementById('molecular_weight').value;

    let step1 = '';
    if (drug_amount && liquid_volume) {
      step1 = `
        <div style="margin-top:0.6em;">
          ‰æã: <b>${drug_amount}</b> √∑ <b>${liquid_volume}</b> = <span style="color:#38a169;font-weight:bold;">${(drug_amount / liquid_volume).toFixed(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[Âçò‰Ωç: ${drug_unit}, ${liquid_unit}]</div>
      `;
    }
    let step2 = '';
    if (drug_amount && liquid_volume && molecular_weight) {
      step2 = `
        <div style="margin-top:0.6em;">
          ‰æã: ${drug_amount / liquid_volume} √∑ ${molecular_weight} = <span style="color:#3182ce;font-weight:bold;">${((drug_amount / liquid_volume) / molecular_weight).toExponential(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[Âçò‰Ωç: mol/L]</div>
      `;
    }

    formulaContent.innerHTML = `
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">Ë≥™ÈáèÊøÉÂ∫¶ = Ëñ¨Áâ©Èáè √∑ Ê∂≤Èáè</span>
        ${step1}
      </div>
      <div>
        <span style="font-weight:bold;">„É¢„É´ÊøÉÂ∫¶ = Ë≥™ÈáèÊøÉÂ∫¶ √∑ ÂàÜÂ≠êÈáè</span>
        ${step2}
      </div>
    `;
  }
}

// Â±•Ê≠¥Ë°®Á§∫ÂàáÊõø
function toggleHistory() {
  const historyPanel = document.getElementById('history-panel');
  const historyBtn = document.getElementById('history-btn');
  
  activeStates.history = !activeStates.history;
  
  if (activeStates.history) {
    loadHistory();
    historyPanel.style.display = 'block';
    historyBtn.classList.add('active');
  } else {
    historyPanel.style.display = 'none';
    historyBtn.classList.remove('active');
  }
}

// Â±•Ê≠¥‰øùÂ≠ò
function saveToHistory() {
  if (currentCalculationMode === 'stock') {
    const mw = parseFloat(document.getElementById('mw').value);
    const molarity = parseFloat(document.getElementById('molarity').value);
    const volume = parseFloat(document.getElementById('volume').value);
    
    if (!isNaN(mw) && !isNaN(molarity) && !isNaN(volume)) {
      const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
      const volume_unit = parseFloat(document.getElementById('volume_unit').value);
      const mass_mg = mw * molarity * molarity_unit * volume * volume_unit * 1000;
      
      const historyItem = {
        type: 'stock',
        timestamp: new Date().toLocaleString('ja-JP'),
        mw: mw,
        molarity: molarity,
        molarity_unit: document.getElementById('molarity_unit').options[document.getElementById('molarity_unit').selectedIndex].text,
        volume: volume,
        volume_unit: document.getElementById('volume_unit').options[document.getElementById('volume_unit').selectedIndex].text,
        mass_mg: mass_mg
      };
      
      calculationHistory.unshift(historyItem);
      if (calculationHistory.length > 15) {
        calculationHistory.pop();
      }
      
      localStorage.setItem('molarity-calc-history', JSON.stringify(calculationHistory));
    }
  } else {
    // „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó„ÅÆÂ±•Ê≠¥‰øùÂ≠ò
    const drugAmount = parseFloat(document.getElementById('drug_amount').value);
    const liquidVolume = parseFloat(document.getElementById('liquid_volume').value);
    const molecularWeight = parseFloat(document.getElementById('molecular_weight').value);
    const drugName = document.getElementById('drug_name').value;
    
    if (!isNaN(drugAmount) && !isNaN(liquidVolume) && !isNaN(molecularWeight)) {
      const drugUnit = document.getElementById('drug_unit').value;
      const liquidUnit = document.getElementById('liquid_unit').value;
      
      const drugAmountInMg = drugAmount * drugUnitFactors[drugUnit];
      const liquidVolumeInMl = liquidVolume * volumeUnitFactors[liquidUnit];
      const concentration = drugAmountInMg / liquidVolumeInMl;
      const molarity = concentration / molecularWeight;
      
      const historyItem = {
        type: 'molarity',
        timestamp: new Date().toLocaleString('ja-JP'),
        drugAmount: drugAmount,
        drugUnit: drugUnit,
        liquidVolume: liquidVolume,
        liquidUnit: liquidUnit,
        molecularWeight: molecularWeight,
        drugName: drugName || '',
        concentration: concentration,
        molarity: molarity
      };
      
      calculationHistory.unshift(historyItem);
      if (calculationHistory.length > 15) {
        calculationHistory.pop();
      }
      
      localStorage.setItem('molarity-calc-history', JSON.stringify(calculationHistory));
    }
  }
}

// Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
function loadHistory() {
  const historyContent = document.getElementById('history-content');
  const modeHistory = calculationHistory.filter(item => 
    currentCalculationMode === 'stock' ? item.type === 'stock' : item.type === 'molarity'
  );
  
  if (modeHistory.length === 0) {
    historyContent.innerHTML = '<p style="text-align: center; color: var(--muted-text);">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    return;
  }
  
  let historyHTML = '';
  modeHistory.forEach((item, index) => {
    if (item.type === 'stock') {
      historyHTML += `
        <div class="history-item" onclick="loadFromHistory(${calculationHistory.indexOf(item)})">
          <div style="font-size: 0.8rem; color: var(--muted-text);">${item.timestamp} [„Çπ„Éà„ÉÉ„ÇØ]</div>
          <div><strong>MW:</strong> ${item.mw} g/mol</div>
          <div><strong>ÊøÉÂ∫¶:</strong> ${item.molarity} ${item.molarity_unit}</div>
          <div><strong>‰ΩìÁ©ç:</strong> ${item.volume} ${item.volume_unit}</div>
          <div><strong>ÂøÖË¶ÅËñ¨Èáè:</strong> ${formatNumber(item.mass_mg)} mg</div>
        </div>
      `;
    } else {
      const displayName = item.drugName ? ` [${item.drugName}]` : '';
      historyHTML += `
        <div class="history-item" onclick="loadFromHistory(${calculationHistory.indexOf(item)})">
          <div style="font-size: 0.8rem; color: var(--muted-text);">${item.timestamp} [„É¢„É´ÊøÉÂ∫¶]${displayName}</div>
          <div><strong>Ëñ¨Áâ©:</strong> ${item.drugAmount} ${item.drugUnit}</div>
          <div><strong>Ê∂≤Èáè:</strong> ${item.liquidVolume} ${item.liquidUnit}</div>
          <div><strong>MW:</strong> ${item.molecularWeight} g/mol</div>
          <div><strong>„É¢„É´ÊøÉÂ∫¶:</strong> ${formatMolarityForDisplay(item.molarity)}</div>
        </div>
      `;
    }
  });
  
  historyContent.innerHTML = historyHTML;
}

// Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åø
function loadFromHistory(index) {
  const item = calculationHistory[index];
  
  if (item.type === 'stock') {
    if (currentCalculationMode !== 'stock') {
      switchCalculationMode('stock');
      setTimeout(() => loadFromHistoryStock(item), 100);
    } else {
      loadFromHistoryStock(item);
    }
  } else {
    if (currentCalculationMode !== 'molarity') {
      switchCalculationMode('molarity');
      setTimeout(() => loadFromHistoryMolarity(item), 100);
    } else {
      loadFromHistoryMolarity(item);
    }
  }
  
  toggleHistory();
  showFloatingNotification('Â±•Ê≠¥„Åã„ÇâË™≠„ÅøËæº„Åø„Åæ„Åó„Åü', 'success');
}

function loadFromHistoryStock(item) {
  document.getElementById('mw').value = item.mw;
  document.getElementById('molarity').value = item.molarity;
  
  const molarityUnit = document.getElementById('molarity_unit');
  for (let i = 0; i < molarityUnit.options.length; i++) {
    if (molarityUnit.options[i].text === item.molarity_unit) {
      molarityUnit.selectedIndex = i;
      break;
    }
  }
  
  const volumeUnit = document.getElementById('volume_unit');
  for (let i = 0; i < volumeUnit.options.length; i++) {
    if (volumeUnit.options[i].text === item.volume_unit) {
      volumeUnit.selectedIndex = i;
      break;
    }
  }
  
  document.getElementById('volume').value = item.volume;
  updateMainResults();
}

function loadFromHistoryMolarity(item) {
  document.getElementById('drug_amount').value = item.drugAmount;
  document.getElementById('drug_unit').value = item.drugUnit;
  document.getElementById('liquid_volume').value = item.liquidVolume;
  document.getElementById('liquid_unit').value = item.liquidUnit;
  document.getElementById('molecular_weight').value = item.molecularWeight;
  document.getElementById('drug_name').value = item.drugName || '';
  calculateMolarity();
}

// Â±•Ê≠¥„ÇØ„É™„Ç¢
function clearHistory() {
  if (confirm('Â±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
    calculationHistory = [];
    localStorage.removeItem('molarity-calc-history');
    loadHistory();
    showFloatingNotification('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
  }
}

// ÂÖ®„ÇØ„É™„Ç¢
function clearAll() {
  if (confirm('„Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
    if (currentCalculationMode === 'stock') {
      document.getElementById('mw').value = '';
      document.getElementById('molarity').value = '';
      document.getElementById('volume').value = '';
      document.getElementById('final_molarity').value = '';
      document.getElementById('final_total_vol').value = '';
      document.getElementById('cid').value = '';
      document.getElementById('drug_info').style.display = 'none';
      updateMainResults();
    } else {
      document.getElementById('drug_amount').value = '';
      document.getElementById('liquid_volume').value = '';
      document.getElementById('molecular_weight').value = '';
      document.getElementById('drug_name').value = '';
      calculateMolarity();
    }
    
    // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇÇ„É™„Çª„ÉÉ„Éà
    if (activeStates.formula) toggleFormula();
    if (activeStates.history) toggleHistory();
    
    clearModeResults();
    showFloatingNotification('„Åô„Åπ„Å¶„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'success');
  }
}

// üéØ ÁµêÊûú„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÈñ¢Êï∞„ÇíÊõ¥Êñ∞
function exportResults() {
  const resultsContent = document.getElementById('results-content');
  const hasResults = !resultsContent.querySelector('.results-placeholder');
  
  if (!hasResults) {
    showFloatingNotification('Ë®àÁÆóÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
    return;
  }
  
  const printWindow = window.open('', '_blank');
  const modeTitle = currentCalculationMode === 'stock' ? '„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë™øË£Ω' : '„É¢„É´ÊøÉÂ∫¶Ë®àÁÆó';
  const results = resultsContent.innerHTML;
  
    // ES5Ëé†ÂëàÈã§„ÉªÂ£ΩÊûöËüÑÊÄú„ÉªÈ®æÔΩ£ÈÇ®Ëàå„ÄíHTMLÈÇ®„ÉªÔΩ´ÂÖ∑ÔΩº„Éª„ÉªËúâ„Éª
  var html =
    '<!DOCTYPE html>' +
    '<html lang="ja">' +
    '<head><meta charset="UTF-8"><title>YoshinovaCalc Lab ' + modeTitle + ' ÈÇ®ÂÖàÊ£°</title>' +
      '<style>' +
        'body{font-family:Inter,system-ui,sans-serif;margin:20px;color:#333;}' +
        '.header{text-align:center;margin-bottom:20px;border-bottom:2px solid #4299e1;padding-bottom:10px;}' +
        '.results{border:1px solid #ccc;padding:15px;border-radius:6px;background:#f9f9f9;}' +
      '</style>' +
    '</head>' +
    '<body>' +
      '<div class="header"><h1>ÓÅûÔΩßÔΩ¨ YoshinovaCalc Lab ÓÅûÔΩßÔΩ¨</h1>' +
      '<p>' + modeTitle + ' ÈÇ®ÂÖàÊ£° - ' + new Date().toLocaleString('ja-JP') + '</p></div>' +
      '<div class="results">' + results + '</div>' +
    '</body>' +
    '</html>';
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.print();
}

// üéØ „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó„ÅÆÂÆüË£ÖÔºàresults-panelÁµ±‰∏ÄÁâàÔºâ
function setupMolarityCalculationListeners() {
  const molarityInputs = ['drug_amount', 'drug_unit', 'liquid_volume', 'liquid_unit', 'molecular_weight', 'drug_name'];
  molarityInputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', calculateMolarity);
      element.addEventListener('change', calculateMolarity);
    }
  });
}

function formatNumber(num) {
  if (num === 0) return "0";
  if (Math.abs(num) >= 100) return num.toFixed(1);
  if (Math.abs(num) >= 10) return num.toFixed(2);
  if (Math.abs(num) >= 1) return num.toFixed(3);
  if (Math.abs(num) >= 0.1) return num.toFixed(3);
  return num.toFixed(4);
}

function formatMolarityForDisplay(molarity) {
  let displayValue, unit;
  if (molarity >= 1) {
    displayValue = formatNumber(molarity);
    unit = 'M';
  } else if (molarity >= 0.001) {
    displayValue = formatNumber(molarity * 1000);
    unit = 'mM';
  } else if (molarity >= 0.000001) {
    displayValue = formatNumber(molarity * 1000000);
    unit = 'ŒºM';
  } else {
    displayValue = formatNumber(molarity * 1000000000);
    unit = 'nM';
  }
  return `${displayValue} ${unit}`;
}

function calculateMolarity() {
  if (currentCalculationMode !== 'molarity') return;
  
  const drugAmount = parseFloat(document.getElementById('drug_amount').value);
  const drugUnit = document.getElementById('drug_unit').value;
  const liquidVolume = parseFloat(document.getElementById('liquid_volume').value);
  const liquidUnit = document.getElementById('liquid_unit').value;
  const molecularWeight = parseFloat(document.getElementById('molecular_weight').value);
  const drugName = document.getElementById('drug_name').value;
  
  const concentrationDisplay = document.getElementById('concentration-display');
  const concentrationValue = document.getElementById('concentration-value');
  const resultsContent = document.getElementById('results-content');
  
  // ÂÖ•ÂäõÂÄ§Ê§úË®º
  if (isNaN(drugAmount) || isNaN(liquidVolume) || drugAmount <= 0 || liquidVolume <= 0) {
    concentrationDisplay.style.display = 'none';
    resultsContent.innerHTML = `
      <div class="results-placeholder">
        ÂøÖË¶ÅÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
      </div>
    `;
    updateSectionStatus('molarity-calc', '');
    return;
  }
  
  try {
    // Âçò‰ΩçÂ§âÊèõ
    const drugAmountInMg = drugAmount * drugUnitFactors[drugUnit];
    const liquidVolumeInMl = liquidVolume * volumeUnitFactors[liquidUnit];
    
    // Ë≥™ÈáèÊøÉÂ∫¶Ë®àÁÆó (mg/mL)
    const concentration = drugAmountInMg / liquidVolumeInMl;
    
    // Ë≥™ÈáèÊøÉÂ∫¶Ë°®Á§∫ÔºàÂ∑¶ÂÅ¥Ôºâ
    concentrationValue.textContent = formatNumber(concentration);
    concentrationDisplay.style.display = 'block';
    
    // „É¢„É´ÊøÉÂ∫¶Ë®àÁÆó
    if (!isNaN(molecularWeight) && molecularWeight > 0) {
      const molarity = concentration / molecularWeight;
      const molarityDisplayValue = formatMolarityForDisplay(molarity);
      
      // üéØ Âè≥ÂÅ¥results-panel„Å´Áµ±‰∏ÄË°®Á§∫
      const drugDisplay = drugName ? drugName : 'ÂåñÂêàÁâ©';
      
      resultsContent.innerHTML = `
        <div class="results-grid">
          <div class="result-item">
            <div class="result-label">Ë≥™ÈáèÊøÉÂ∫¶</div>
            <div class="result-value">${formatNumber(concentration)} mg/mL</div>
          </div>
          <div class="result-item">
            <div class="result-label">„É¢„É´ÊøÉÂ∫¶</div>
            <div class="result-value">${molarityDisplayValue}</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">Ë™øË£ΩÊù°‰ª∂</div>
            <div class="result-value" style="font-size: 0.9rem;">${drugAmount} ${drugUnit} √∑ ${liquidVolume} ${liquidUnit}</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">Ëñ¨Áâ©ÊÉÖÂ†±</div>
            <div class="result-value" style="font-size: 0.9rem;">
              ${drugDisplay} (MW: ${molecularWeight} g/mol)
            </div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(255, 255, 255, 0.3); border-radius: 8px; font-size: 0.8rem; color: var(--muted-text);">
          <strong>üí° Ë®àÁÆóÈÅéÁ®ã:</strong><br>
          1. Ë≥™ÈáèÊøÉÂ∫¶ = ${formatNumber(drugAmountInMg)} mg √∑ ${formatNumber(liquidVolumeInMl)} mL = ${formatNumber(concentration)} mg/mL<br>
          2. „É¢„É´ÊøÉÂ∫¶ = ${formatNumber(concentration)} √∑ ${molecularWeight} = ${formatNumber(molarity, 4)} mol/L<br>
          3. Ë©≥Á¥∞ÂÄ§: ${molarity.toExponential(3)} mol/L
        </div>
      `;
      
      updateSectionStatus('molarity-calc', 'completed');
      saveToHistory();
    } else {
      // ÂàÜÂ≠êÈáèÊú™ÂÖ•ÂäõÊôÇ
      resultsContent.innerHTML = `
        <div class="results-grid">
          <div class="result-item">
            <div class="result-label">Ë≥™ÈáèÊøÉÂ∫¶</div>
            <div class="result-value">${formatNumber(concentration)} mg/mL</div>
          </div>
          <div class="result-item">
            <div class="result-label">„É¢„É´ÊøÉÂ∫¶</div>
            <div class="result-value" style="color: var(--muted-text);">ÂàÜÂ≠êÈáè„ÇíÂÖ•Âäõ</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">Ë™øË£ΩÊù°‰ª∂</div>
            <div class="result-value" style="font-size: 0.9rem;">${drugAmount} ${drugUnit} √∑ ${liquidVolume} ${liquidUnit}</div>
          </div>
        </div>
      `;
      updateSectionStatus('molarity-calc', '');
    }
    
  } catch (error) {
    resultsContent.innerHTML = `
      <div class="results-placeholder" style="color: var(--error-color); border-color: var(--error-color);">
        ‚ö†Ô∏è Ë®àÁÆó„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÖ•ÂäõÂÄ§„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
      </div>
    `;
    updateSectionStatus('molarity-calc', 'error');
  }
}

// üéØ Êó¢Â≠ò„ÅÆÈñ¢Êï∞Áæ§Ôºà„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë®àÁÆóÁî®Ôºâ

function setInputError(inputId, message, isWarning = false) {
  const errorEl = document.getElementById('error-' + inputId.replace('_','-'));
  const inputEl = document.getElementById(inputId);
  
  if (errorEl) {
    errorEl.textContent = message || '';
    errorEl.className = isWarning ? 'input-warning-message' : 'input-error-message';
    
    if (message) {
      errorEl.style.animation = 'none';
      errorEl.offsetHeight;
      errorEl.style.animation = 'bounceIn 0.4s ease-out';
    }
  }
  
  if (inputEl) {
    inputEl.classList.remove('invalid', 'warning', 'valid');
    if (message) {
      inputEl.classList.add(isWarning ? 'warning' : 'invalid');
    }
  }
  
  updateSectionVisualState(inputId, message, isWarning);
}

function updateSectionVisualState(inputId, hasMessage, isWarning) {
  const sectionMap = {
    'mw': 'stock',
    'molarity': 'stock', 
    'volume': 'stock',
    'final_molarity': 'dilution',
    'final_total_vol': 'dilution'
  };
  
  const sectionName = sectionMap[inputId];
  if (!sectionName) return;
  
  const sectionEl = document.getElementById(`section-${sectionName}`);
  if (!sectionEl) return;
  
  const hasErrors = sectionEl.querySelector('.input-error-message:not(:empty)');
  const hasWarnings = sectionEl.querySelector('.input-warning-message:not(:empty)');
  
  sectionEl.classList.remove('has-errors', 'has-warnings');
  
  if (hasErrors) {
    sectionEl.classList.add('has-errors');
  } else if (hasWarnings) {
    sectionEl.classList.add('has-warnings');
  }
}

function updateInputStatus(inputId, isValid, isEmpty = false) {
  const statusEl = document.getElementById(`status-${inputId.replace('_', '-')}`);
  const inputEl = document.getElementById(inputId);
  if (!statusEl || !inputEl) return;
  
  if (isEmpty) {
    statusEl.textContent = '';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '');
  } else if (isValid) {
    statusEl.textContent = '‚úì';
    statusEl.style.color = 'var(--success-color)';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '') + ' valid';
  } else {
    statusEl.textContent = '‚ö†';
    statusEl.style.color = 'var(--error-color)';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '') + ' invalid';
  }
}

function updateSectionStatus(sectionId, status) {
  const statusEl = document.getElementById(`status-${sectionId}`);
  const sectionEl = document.getElementById(`section-${sectionId}`);
  if (!statusEl || !sectionEl) return;
  
  statusEl.className = 'section-status ' + status;
  if (status === 'completed') {
    statusEl.textContent = 'ÂÆå‰∫Ü';
    sectionEl.classList.add('completed');
  } else if (status === 'error') {
    statusEl.textContent = '„Ç®„É©„Éº';
    sectionEl.classList.remove('completed');
  } else if (status === 'warning') {
    statusEl.textContent = 'Ê≥®ÊÑè';
    sectionEl.classList.remove('completed');
  } else {
    statusEl.textContent = '';
    sectionEl.classList.remove('completed');
  }
}

function formatMassCustomUnit(value_mg, selectedUnit) {
  if (selectedUnit === "mg") {
    return `${formatNumber(value_mg)} mg`;
  } else if (selectedUnit === "g") {
    return `${formatNumber(value_mg / 1000)} g`;
  } else if (selectedUnit === "Œºg") {
    return `${formatNumber(value_mg * 1000)} Œºg`;
  } else {
    return `${formatNumber(value_mg)} mg`;
  }
}

function validateInputs() {
  if (currentCalculationMode !== 'stock') return { warnings: [], errors: [] };
  
  const warnings = [];
  const errors = [];
  
  ['mw','molarity','volume','final-molarity','final-total-vol'].forEach(id => setInputError(id, ""));
  
  const mw = parseFloat(document.getElementById('mw').value);
  const molarity = parseFloat(document.getElementById('molarity').value);
  const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
  const volume = parseFloat(document.getElementById('volume').value);
  const volume_unit = parseFloat(document.getElementById('volume_unit').value);
  const final_molarity = parseFloat(document.getElementById('final_molarity').value);
  const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
  const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
  const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);
  
  const mwValid = !isNaN(mw) && mw > 0;
  const molarityValid = !isNaN(molarity) && molarity > 0;
  const volumeValid = !isNaN(volume) && volume > 0;
  const finalMolarityValid = document.getElementById('final_molarity').value === '' || (!isNaN(final_molarity) && final_molarity > 0);
  const finalVolumeValid = document.getElementById('final_total_vol').value === '' || (!isNaN(final_total_vol) && final_total_vol > 0);
  
  // ÂàÜÂ≠êÈáè„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!mwValid && document.getElementById('mw').value !== "") {
    setInputError('mw', 'ÂàÜÂ≠êÈáè„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    errors.push("ÂàÜÂ≠êÈáè„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
  } else if (mwValid && mw < 10) {
    setInputError('mw', 'ÂàÜÂ≠êÈáè„Åå10Êú™Ê∫Ä„Åß„Åô„ÄÇÂÖ•ÂäõÂÄ§„ÇíÁ¢∫Ë™çÔºÅ', true);
    warnings.push("ÂàÜÂ≠êÈáè„Åå10Êú™Ê∫Ä„Åß„Åô„ÄÇ‰ΩéÂàÜÂ≠êÂåñÂêàÁâ©„Åß„ÇÇÈÄöÂ∏∏10‰ª•‰∏ä„Åß„Åô„ÄÇÂÖ•ÂäõÂÄ§„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
  } else if (mwValid && mw > 2000 && mw <= 10000) {
    setInputError('mw', 'ÂàÜÂ≠êÈáè„Åå2000„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ∫∂Ëß£ÊÄß„Å´Ê≥®ÊÑè', true);
    warnings.push("ÂàÜÂ≠êÈáè„Åå2000„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éö„Éó„ÉÅ„Éâ„ÇÑÂ§ßÂàÜÂ≠êÂåñÂêàÁâ©„Åß„Åô„ÅãÔºüÊ∫∂Ëß£ÊÄß„Å´„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇ");
  } else if (mwValid && mw > 10000) {
    setInputError('mw', 'ÂàÜÂ≠êÈáè„Åå10000„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÁâπÊÆä„Å™Ê∫∂Ëß£Êù°‰ª∂„Åã„ÇÇ', true);
    warnings.push("ÂàÜÂ≠êÈáè„Åå10000„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Çø„É≥„Éë„ÇØË≥™„Å™„Å©„ÅÆÂ∑®Â§ßÂàÜÂ≠ê„Åß„Åô„Å≠„ÄÇÁâπÊÆä„Å™Ê∫∂Ëß£Êù°‰ª∂„ÅåÂøÖË¶Å„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ");
  }
  
  // „Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!molarityValid && document.getElementById('molarity').value !== "") {
    setInputError('molarity', 'ÊøÉÂ∫¶„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    errors.push("ÊøÉÂ∫¶„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
  } else if (molarityValid && molarity_unit > 0) {
    const stock_conc_molL = molarity * molarity_unit;
    if (stock_conc_molL > 1) {
      setInputError('molarity', '1MË∂Ö„ÅÆÈ´òÊøÉÂ∫¶„ÄÇÊ∫∂Ëß£Â∫¶„Å´Ê≥®ÊÑè', true);
      warnings.push("„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„Åå1 M „ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÊ∫∂Ëß£Â∫¶„ÅØÂ§ß‰∏àÂ§´„Åß„Åô„ÅãÔºüÈ´òÊøÉÂ∫¶„Åß„ÅØÊ≤àÊÆø„ÅÆ„É™„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
    } else if (stock_conc_molL > 0.1) {
      setInputError('molarity', '100mMË∂Ö„ÄÇÂÆåÂÖ®Ê∫∂Ëß£„ÇíÁ¢∫Ë™ç', true);
      warnings.push("„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„Åå100 mM „ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÆåÂÖ®Ê∫∂Ëß£„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„Çâ‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    } else if (stock_conc_molL < 1e-9) {
      setInputError('molarity', '1nMÊú™Ê∫Ä„ÄÇÁ≤æÂ∫¶„Å´Ê≥®ÊÑè', true);
      warnings.push("„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„ÅåÊ•µ„ÇÅ„Å¶‰Ωé„ÅÑ„Åß„ÅôÔºà1 nMÊú™Ê∫ÄÔºâ„ÄÇÂ∏åÈáàÁ≤æÂ∫¶„ÅåÂïèÈ°å„Å´„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
    }
  }
  
  // ‰ΩìÁ©ç„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!volumeValid && document.getElementById('volume').value !== "") {
    setInputError('volume', 'Ë™øË£ΩÈáè„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    errors.push("Ë™øË£ΩÈáè„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
  } else if (volumeValid && volume_unit > 0) {
    const total_vol_ul = volume * (volume_unit === 1 ? 1e6 : 1e3);
    if (total_vol_ul < 10) {
      setInputError('volume', '10ŒºLÊú™Ê∫Ä„ÄÇË™øË£ΩÂõ∞Èõ£', false);
      errors.push("Ë™øË£ΩÈáè„Åå10ŒºLÊú™Ê∫Ä„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆË™øË£Ω„ÅØÂõ∞Èõ£„Åß„Åô„ÄÇ„Çà„ÇäÂ§ß„Åç„Å™Èáè„Åß„ÅÆË™øË£Ω„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ");
    } else if (total_vol_ul < 100) {
      setInputError('volume', '100ŒºLÊú™Ê∫Ä„ÄÇ„Éî„Éö„ÉÉ„ÉàÁ≤æÂ∫¶„Å´Ê≥®ÊÑè', true);
      warnings.push("Ë™øË£ΩÈáè„Åå100ŒºLÊú™Ê∫Ä„Åß„Åô„ÄÇ„Éî„Éö„ÉÉ„ÉÜ„Ç£„É≥„Ç∞Á≤æÂ∫¶„Å´„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇ„Éû„Ç§„ÇØ„É≠„Éî„Éö„ÉÉ„Éà„ÅÆ‰ΩøÁî®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ");
    } else if (total_vol_ul > 1e9) {
      setInputError('volume', '1LË∂Ö„ÄÇÂçò‰Ωç„Éü„ÇπÊ≥®ÊÑè', true);
      warnings.push("Ë™øË£ΩÈáè„ÅåÈùûÁèæÂÆüÁöÑ„Å´Â§ß„Åç„ÅÑ„Åß„ÅôÔºà1 LË∂ÖÔºâ„ÄÇÂçò‰Ωç„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    }
  }
  
  // üéØ Â∏åÈáàÈñ¢ÈÄ£„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ôºà‰øÆÊ≠£ÁâàÔºâ
  const finalMolarityInput = document.getElementById('final_molarity').value;
  const finalVolumeInput = document.getElementById('final_total_vol').value;
  const bothFieldsEmpty = finalMolarityInput === '' && finalVolumeInput === '';
  const bothFieldsFilled = finalMolarityInput !== '' && finalVolumeInput !== '';
  const onlyOneFieldFilled = (finalMolarityInput !== '' && finalVolumeInput === '') || 
                             (finalMolarityInput === '' && finalVolumeInput !== '');
  
  if (onlyOneFieldFilled) {
    // „Å©„Å°„Çâ„ÅãÁâáÊñπ„Å†„ÅëÂÖ•Âäõ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Ç®„É©„Éº
    if (finalMolarityInput !== '' && finalVolumeInput === '') {
      setInputError('final-total-vol', 'Â∏åÈáàÂæåÁ∑èÈáè„ÇÇÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', false);
      errors.push("Â∏åÈáàË®àÁÆó„Å´„ÅØÊúÄÁµÇÊøÉÂ∫¶„Å®Â∏åÈáàÂæåÁ∑èÈáè„ÅÆ‰∏°Êñπ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
    }
    if (finalMolarityInput === '' && finalVolumeInput !== '') {
      setInputError('final-molarity', 'ÊúÄÁµÇÊøÉÂ∫¶„ÇÇÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', false);
      errors.push("Â∏åÈáàË®àÁÆó„Å´„ÅØÊúÄÁµÇÊøÉÂ∫¶„Å®Â∏åÈáàÂæåÁ∑èÈáè„ÅÆ‰∏°Êñπ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
    }
  } else if (bothFieldsFilled) {
    // ‰∏°ÊñπÂÖ•Âäõ„Åï„Çå„ÅüÂ†¥Âêà„ÅÆË©≥Á¥∞„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    if (!finalMolarityValid) {
      setInputError('final-molarity', 'ÊúÄÁµÇÊøÉÂ∫¶„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ');
      errors.push("ÊúÄÁµÇÊøÉÂ∫¶„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
    } else if (!finalVolumeValid) {
      setInputError('final-total-vol', 'Â∏åÈáàÂæåÁ∑èÈáè„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ');
      errors.push("Â∏åÈáàÂæåÁ∑èÈáè„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
    } else if (finalMolarityValid && molarityValid && molarity > 0) {
      const stock_conc = molarity * molarity_unit;
      const final_conc = final_molarity * final_molarity_unit;
      if (final_conc >= stock_conc) {
        setInputError('final-molarity', '„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶Êú™Ê∫Ä„ÅßÂÖ•Âäõ', false);
        errors.push("ÊúÄÁµÇÊøÉÂ∫¶„Åå„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶‰ª•‰∏ä„Åß„Åô„ÄÇÂ∏åÈáà„Åß„ÅØÂÆüÁèæ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„Çí‰∏ä„Åí„Çã„ÅãÊúÄÁµÇÊøÉÂ∫¶„Çí‰∏ã„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      } else {
        const dilution_factor = stock_conc / final_conc;
        if (dilution_factor > 10000) {
          setInputError('final-molarity', 'Â∏åÈáàÂÄçÁéá1‰∏áÂÄçË∂Ö„ÄÇÊÆµÈöéÂ∏åÈáàÊé®Â•®', true);
          warnings.push("Â∏åÈáàÂÄçÁéá„Åå1‰∏áÂÄç„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÊÆµÈöéÂ∏åÈáà„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ≤æÂ∫¶„Åå‰Ωé‰∏ã„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
        } else if (dilution_factor < 2) {
          setInputError('final-molarity', '2ÂÄçÊú™Ê∫Ä„ÄÇ„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶Ë¶ãÁõ¥„ÅóÊé®Â•®', true);
          warnings.push("Â∏åÈáàÂÄçÁéá„Åå2ÂÄçÊú™Ê∫Ä„Åß„Åô„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóÊøÉ„ÅÑ„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÅÆÊñπ„ÅåËâØ„ÅÑ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ");
        }
      }
    }
    
    // „Éî„Éö„ÉÉ„ÉÜ„Ç£„É≥„Ç∞Á≤æÂ∫¶„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    if (finalMolarityValid && final_molarity > 0 && finalVolumeValid && final_total_vol > 0 && molarityValid && molarity > 0) {
      const C1 = molarity * molarity_unit;
      const C2 = final_molarity * final_molarity_unit;
      const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);
      const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
      if (V1 < 0.1) {
        setInputError('final-molarity', '„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤„ÅÆÂøÖË¶ÅÈáè„Åå0.1ŒºLÊú™Ê∫Ä„ÄÇÁ≤æÂ∫¶‰∏çÂèØ', false);
        errors.push("ÂøÖË¶Å„Å™„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè„Åå0.1ŒºLÊú™Ê∫Ä„Åß„Åô„ÄÇÊ≠£Á¢∫„Å™„Éî„Éö„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„ÅØ‰∏çÂèØËÉΩ„Åß„Åô„ÄÇ„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶„Çí‰∏ã„Åí„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      } else if (V1 < 1) {
        setInputError('final-molarity', '1ŒºLÊú™Ê∫Ä„ÄÇÈ´òÁ≤æÂ∫¶„Éî„Éö„ÉÉ„ÉàÂøÖË¶Å', true);
        warnings.push("ÂøÖË¶Å„Å™„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè„Åå1ŒºLÊú™Ê∫Ä„Åß„Åô„ÄÇÈ´òÁ≤æÂ∫¶„Éî„Éö„ÉÉ„ÉàÔºà0.1-2ŒºLÁî®Ôºâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
      }
    }
  }
  // bothFieldsEmpty „ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà‰ªªÊÑè„Å™„ÅÆ„ÅßÔºâ
  
  // ÂøÖË¶ÅËñ¨Èáè„ÅÆË®àÁÆó„Å®„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (mwValid && molarityValid && volumeValid) {
    const molarity_molL = molarity * molarity_unit;
    const volume_L = volume * volume_unit;
    const mass_mg = mw * molarity_molL * volume_L * 1000;
    if (mass_mg < 0.1) {
      setInputError('mw', 'ÂøÖË¶ÅËñ¨Èáè„Åå0.1mgÊú™Ê∫Ä„ÄÇÂ§©Áß§Á≤æÂ∫¶‰∏çÂèØ', false);
      errors.push("ÂøÖË¶Å„Å™Ëñ¨Èáè„Åå0.1mgÊú™Ê∫Ä„Åß„Åô„ÄÇÂàÜÊûêÂ§©Áß§„Åß„ÇÇÊ≠£Á¢∫„Å™Áß§Èáè„ÅØÂõ∞Èõ£„Åß„Åô„ÄÇÊøÉÂ∫¶„Çí‰∏ã„Åí„Çã„ÅãÈáè„ÇíÂ¢ó„ÇÑ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    } else if (mass_mg < 1) {
      setInputError('mw', 'ÂøÖË¶ÅËñ¨Èáè„Åå1mgÊú™Ê∫Ä„ÄÇ„Éû„Ç§„ÇØ„É≠Â§©Áß§Êé®Â•®', true);
      warnings.push("ÂøÖË¶Å„Å™Ëñ¨Èáè„Åå1mgÊú™Ê∫Ä„Åß„Åô„ÄÇ„Éû„Ç§„ÇØ„É≠Â§©Áß§„Åæ„Åü„ÅØÊØçÊ∂≤Ë™øË£ΩÊ≥ïÔºàÈ´òÊøÉÂ∫¶„ÅßÂ∞ëÈáèË™øË£ΩÂæåÂ∏åÈáàÔºâ„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ");
    } else if (mass_mg > 1000) {
      setInputError('mw', 'ÂøÖË¶ÅËñ¨Èáè„Åå1gË∂Ö„ÄÇÊ∫∂Ëß£„ÉªÂÆπÂô®Ê≥®ÊÑè', true);
      warnings.push("ÂøÖË¶Å„Å™Ëñ¨Èáè„Åå1g„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÂÆπÂô®„Çµ„Ç§„Ç∫„Å®Ê∫∂Ëß£ÊôÇÈñì„Å´„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ„ÄÇÊÆµÈöéÁöÑ„Å´Ê∫∂Ëß£„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ");
    }
  }
  
  // „Çª„ÇØ„Ç∑„Éß„É≥„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞
  const stockValid = mwValid && molarityValid && volumeValid;
  const stockHasErrors = errors.some(error => error.includes('Ë™øË£ΩÈáè') || error.includes('Ëñ¨Èáè') || error.includes('ÂàÜÂ≠êÈáè') || error.includes('ÊøÉÂ∫¶'));
  const stockHasWarnings = warnings.some(warning => warning.includes('ÂàÜÂ≠êÈáè') || warning.includes('„Çπ„Éà„ÉÉ„ÇØÊøÉÂ∫¶') || warning.includes('Ë™øË£ΩÈáè') || warning.includes('Ëñ¨Èáè'));
  
  if (stockHasErrors) {
    updateSectionStatus('stock', 'error');
  } else if (stockHasWarnings) {
    updateSectionStatus('stock', 'warning');
  } else if (stockValid) {
    updateSectionStatus('stock', 'completed');
  } else {
    updateSectionStatus('stock', '');
  }
  
  // üéØ Â∏åÈáà„Çª„ÇØ„Ç∑„Éß„É≥„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞ÔºàÂÆåÂÖ®„Å´‰øÆÊ≠£Ôºâ
  const dilutionHasErrors = errors.some(error => error.includes('ÊúÄÁµÇÊøÉÂ∫¶') || error.includes('„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè') || error.includes('Â∏åÈáàÂæåÁ∑èÈáè') || error.includes('Â∏åÈáàË®àÁÆó'));
  const dilutionHasWarnings = warnings.some(warning => warning.includes('Â∏åÈáàÂÄçÁéá') || warning.includes('„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Èáè'));
  
  if (dilutionHasErrors) {
    updateSectionStatus('dilution', 'error');
  } else if (dilutionHasWarnings) {
    updateSectionStatus('dilution', 'warning');
  } else if (bothFieldsFilled && finalMolarityValid && finalVolumeValid && stockValid && !stockHasErrors) {
    // ‰∏°Êñπ„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÅåÊ≠£„Åó„ÅèÂÖ•Âäõ„Åï„Çå„ÄÅ„Çπ„Éà„ÉÉ„ÇØÊÉÖÂ†±„ÇÇÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„ÄåÂÆå‰∫Ü„Äç
    updateSectionStatus('dilution', 'completed');
  } else {
    // Êú™ÂÖ•ÂäõÔºà‰ªªÊÑèÔºâ„ÄÅÁâáÊñπ„ÅÆ„ÅøÂÖ•Âäõ„ÄÅ„Çπ„Éà„ÉÉ„ÇØÊú™ÂÆå‰∫Ü„ÅÆÂ†¥Âêà„ÅØ„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫„Å™„Åó
    updateSectionStatus('dilution', '');
  }
  
  return { warnings, errors };
}

function formatVolumeSI(value_ul) {
  if (value_ul >= 1e6) {
    return `${formatNumber(value_ul / 1e6)} L`;
  } else if (value_ul >= 1e3) {
    return `${formatNumber(value_ul / 1e3)} mL`;
  } else if (value_ul >= 1) {
    return `${formatNumber(value_ul)} ŒºL`;
  } else if (value_ul >= 1e-3) {
    return `${formatNumber(value_ul * 1e3)} nL`;
  } else if (value_ul > 0) {
    return `${formatNumber(value_ul * 1e6)} pL`;
  } else {
    return "0";
  }
}

function updateMainResults() {
  if (currentCalculationMode !== 'stock') return;
  
  const mw = parseFloat(document.getElementById('mw').value);
  const molarity = parseFloat(document.getElementById('molarity').value);
  const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
  const volume = parseFloat(document.getElementById('volume').value);
  const volume_unit = parseFloat(document.getElementById('volume_unit').value);
  const final_molarity = parseFloat(document.getElementById('final_molarity').value);
  const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
  const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
  const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);
  const selectedMassUnit = document.getElementById('mass_unit').value;
  
  let resultHTML = '';
  let hasResults = false;
  
  if (!isNaN(mw) && mw > 0 && !isNaN(molarity) && molarity > 0 && !isNaN(volume) && volume > 0) {
    const molarity_molL = molarity * molarity_unit;
    const volume_L = volume * volume_unit;
    const mass_mg = mw * molarity_molL * volume_L * 1000;
    let solvent_ul = volume * (volume_unit === 1 ? 1000000 : 1000);
    const massDisplay = formatMassCustomUnit(mass_mg, selectedMassUnit);
    
    resultHTML += `<div class="results-grid">
        <div class="result-item">
          <div class="result-label">ÂøÖË¶Å„Å™Ëñ¨Èáè</div>
          <div class="result-value">${massDisplay}</div>
        </div>
        <div class="result-item">
          <div class="result-label">Ê∫∂Â™íÈáè</div>
          <div class="result-value">${formatVolumeSI(solvent_ul)}</div>
        </div>`;
    
    hasResults = true;
    saveToHistory();
    
    let stockResult = `<strong>„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Ë™øË£Ω:</strong> Ëñ¨ ${massDisplay} + Ê∫∂Â™í ${formatVolumeSI(solvent_ul)}`;
    if (mass_mg < 1) {
      stockResult += '<br><span style="color: var(--warning-color);">‚ö† 1mgÊú™Ê∫Ä„ÅÆ„Åü„ÇÅÊØçÊ∂≤Ë™øË£ΩÊ≥ï„ÇíÊé®Â•®</span>';
    }
    showSectionResult('section-result-stock', stockResult);
  } else {
    showSectionResult('section-result-stock', null);
  }
  
  if (!isNaN(molarity) && molarity > 0 && !isNaN(final_molarity) && final_molarity > 0 &&
      !isNaN(final_total_vol) && final_total_vol > 0) {
    const C1 = molarity * molarity_unit;
    const C2 = final_molarity * final_molarity_unit;
    const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
    const V1_fixed = Math.max(0, V1);
    const diluent_uL = V2 - V1_fixed;
    
    if (hasResults) {
      resultHTML += `
          <div class="result-item">
            <div class="result-label">„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤</div>
            <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
          </div>
          <div class="result-item">
            <div class="result-label">ËøΩÂä†Ê∫∂Â™í</div>
            <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
          </div>
      `;
    } else {
      resultHTML += `
      <div class="results-grid">
          <div class="result-item">
            <div class="result-label">„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤</div>
            <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
          </div>
          <div class="result-item">
            <div class="result-label">ËøΩÂä†Ê∫∂Â™í</div>
            <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
          </div>
      `;
    }
    resultHTML += '</div>';
    hasResults = true;
    
    let dilutionResult = `<strong>Â∏åÈáàÈÖçÂêà:</strong> „Çπ„Éà„ÉÉ„ÇØ ${formatVolumeSI(V1_fixed)} + Ê∫∂Â™í ${formatVolumeSI(diluent_uL)}`;
    if (V1_fixed < 1) {
      dilutionResult += '<br><span style="color: var(--warning-color);">‚ö† È´òÁ≤æÂ∫¶„Éî„Éö„ÉÉ„ÉàÂøÖË¶Å</span>';
    }
    showSectionResult('section-result-dilution', dilutionResult);
  } else {
    showSectionResult('section-result-dilution', null);
  }
  
  if (hasResults) {
    if (!resultHTML.includes('</div>')) {
      resultHTML += '</div>';
    }
    document.getElementById('results-content').innerHTML = resultHTML;
  } else {
    document.getElementById('results-content').innerHTML = `
        <div class="results-placeholder">
          ÂøÖË¶ÅÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
        </div>
    `;
  }
  
  const validation = validateInputs();
  currentValidation = validation;
}

function showSectionResult(containerId, content) {
  const container = document.getElementById(containerId);
  if (container) {
    if (content) {
      container.innerHTML = content;
      container.classList.add('show');
    } else {
      container.classList.remove('show');
    }
  }
}

// „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÔºà„Çπ„Éà„ÉÉ„ÇØÊ∫∂Ê∂≤Áî®Ôºâ
[
  "mw","molarity","molarity_unit","volume","volume_unit","mass_unit",
  "final_molarity","final_molarity_unit","final_total_vol","final_total_vol_unit"
].forEach(id => {
  const element = document.getElementById(id);
  if (element) {
    element.addEventListener('input', updateMainResults);
    element.addEventListener('change', updateMainResults);
  }
});

function fetchPubChem() {
  const cid = document.getElementById('cid').value.trim();
  const searchButton = document.querySelector('.btn-primary');
  const searchText = document.getElementById('search-text');
  
  if (!cid) {
    showFloatingNotification("CID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", 'error');
    document.getElementById('cid').focus();
    return;
  }
  
  searchText.innerHTML = '<span class="loading-spinner"></span>Ê§úÁ¥¢‰∏≠';
  searchButton.disabled = true;
  
  const originalEndpoint = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/MolecularWeight,IUPACName,Title,CanonicalSMILES,MolecularFormula/JSON`;
  const proxyEndpoint = `https://api.allorigins.win/get?url=${encodeURIComponent(originalEndpoint)}`;
  
  fetch(proxyEndpoint)
    .then(response => {
      if (!response.ok) throw new Error("ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
      return response.json();
    })
    .then(proxyData => {
      const data = JSON.parse(proxyData.contents);
      const prop = data.PropertyTable.Properties[0];
      
      if (prop.CID) document.getElementById('cid').value = prop.CID;
      
      if (currentCalculationMode === 'stock') {
        if (prop.MolecularWeight) document.getElementById('mw').value = prop.MolecularWeight;
        updateMainResults();
      } else {
        if (prop.MolecularWeight) document.getElementById('molecular_weight').value = prop.MolecularWeight;
        if (prop.Title) document.getElementById('drug_name').value = prop.Title;
        calculateMolarity();
      }
      
      let infoHTML = "<table class='info-table' role='table'>";
      infoHTML += "<caption class='sr-only'>ÂèñÂæó„Åó„ÅüËñ¨Áâ©ÊÉÖÂ†±</caption>";
      infoHTML += `<tr><td class='info-label'>CID</td><td>${prop.CID ? prop.CID : "-"}</td></tr>`;
      infoHTML += `<tr><td class='info-label'>ÂåñÂ≠¶Âºè</td><td>${prop.MolecularFormula ? prop.MolecularFormula : "-"}</td></tr>`;
      infoHTML += `<tr><td class='info-label'>ÂàÜÂ≠êÈáè</td><td>${prop.MolecularWeight ? prop.MolecularWeight : "-"}</td></tr>`;
      if (prop.CanonicalSMILES)
        infoHTML += `<tr><td class='info-label'>SMILES</td><td style="word-break: break-all;">${prop.CanonicalSMILES}</td></tr>`;
      infoHTML += "</table>";
      
      document.getElementById('drug_info').innerHTML = infoHTML;
      document.getElementById('drug_info').style.display = "block";
      updateSectionStatus('search', 'completed');
      showFloatingNotification(`ÂåñÂêàÁâ©ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü: ${prop.Title || 'CID ' + prop.CID}`, 'success');
    })
    .catch(error => {
      document.getElementById('drug_info').style.display = "none";
      showFloatingNotification("Ëñ¨Áâ©ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message, 'error');
      updateSectionStatus('search', 'error');
    })
    .finally(() => {
      searchText.textContent = 'Ê§úÁ¥¢';
      searchButton.disabled = false;
    });
}

// ÂàùÊúüË®àÁÆóÂÆüË°å
updateMainResults();
</script>

  <!-- === ServiceWorker („Ç™„Éï„É©„Ç§„É≥„Ç≠„É£„ÉÉ„Ç∑„É•) === -->
  <script>
    if ("serviceWorker" in navigator) {
      const swCode = `
        self.addEventListener("fetch", e => {
          e.respondWith(
            caches.open("ycalc-sw").then(c =>
              c.match(e.request).then(r => r || fetch(e.request).then(res => { c.put(e.request, res.clone()); return res; }))
            )
          );
        });
      `;
      navigator.serviceWorker.register(
        URL.createObjectURL(new Blob([swCode], { type: "application/javascript" }))
      ).catch(console.error);
    }
  </script>

  <!-- === DarkMode ÂàáÊõø„É≠„Ç∏„ÉÉ„ÇØ === -->
  <script>
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById("theme-btn");
      const saved = localStorage.getItem("theme");
      const init  = saved || (matchMedia("(prefers-color-scheme:dark)").matches ? "dark" : "light");
      root.setAttribute("data-theme", init);
      // ÁµµÊñáÂ≠ó„ÅØ„Ç≥„Éº„Éâ„Éù„Ç§„É≥„ÉàÊåáÂÆö„ÅßÁ¢∫ÂÆü„Å´
  btn.textContent = init === "dark"
  ? String.fromCodePoint(0x1F52C)  // üî¨
  : String.fromCodePoint(0x1F48A); // üíä

      btn.addEventListener("click", ()=>{
        const next = root.getAttribute("data-theme")==="dark" ? "light" : "dark";
        root.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      btn.textContent = next==="dark"
        ? String.fromCodePoint(0x1F52C)  // üî¨
        : String.fromCodePoint(0x1F48A); // üíä
    });
  })();
  </script>

  <!-- === sanitizeHTML „Éò„É´„Éë„Éº === -->
  <script>
    const sanitizeHTML = html => DOMPurify.sanitize(html);
  </script></body>
</html>
