<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- === MathJax (æ•°å¼è¡¨ç¤ºç”¨) === -->
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- === DOMPurify (XSSé˜²å¾¡ç”¨) === -->
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <style>
    /* === prefers-reduced-motion å¯¾å¿œ === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>YoshinovaCalc Lab - Universal Calculator</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230d6efd;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%230b5ed7;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' fill='url(%23grad)' rx='6'/%3E%3Ccircle cx='8' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='6' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='8' r='2' fill='%23fff'/%3E%3Ccircle cx='12' cy='16' r='2' fill='%23fff'/%3E%3Ccircle cx='20' cy='14' r='2' fill='%23fff'/%3E%3Ccircle cx='8' cy='24' r='2' fill='%23fff'/%3E%3Ccircle cx='16' cy='22' r='2' fill='%23fff'/%3E%3Ccircle cx='24' cy='24' r='2' fill='%23fff'/%3E%3Cline x1='8' y1='8' x2='16' y2='6' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='24' y2='8' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='8' y1='8' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='12' y2='16' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='6' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='24' y1='8' x2='20' y2='14' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='8' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='12' y1='16' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='16' y2='22' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='20' y1='14' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3Cline x1='16' y1='22' x2='24' y2='24' stroke='%23fff' stroke-width='1.5'/%3E%3C/svg%3E">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
      --primary-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --primary-bg-dark: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      --panel-bg: rgba(255, 255, 255, 0.85);
      --panel-bg-dark: rgba(30, 40, 50, 0.9);
      --border-color: rgba(255, 255, 255, 0.18);
      --border-color-dark: rgba(255, 255, 255, 0.1);
      --primary-text: #1a202c;
      --primary-text-dark: #e2e8f0;
      --secondary-text: #4a5568;
      --secondary-text-dark: #a0aec0;
      --muted-text: #718096;
      --muted-text-dark: #718096;
      --primary-blue: #4299e1;
      --primary-blue-hover: #3182ce;
      --primary-blue-focus: #2c5aa0;
      --success-color: #48bb78;
      --warning-color: #ed8936;
      --error-color: #f56565;
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-bg-dark: rgba(0, 0, 0, 0.3);
      --backdrop-blur: blur(10px);
      --card-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      --card-shadow-dark: 0 8px 32px rgba(0, 0, 0, 0.5);
      --neumorphism-light: 20px 20px 60px #bebebe, -20px -20px 60px #ffffff;
      --neumorphism-dark: 20px 20px 60px #1e2a3a, -20px -20px 60px #364a5e;
    }

    [data-theme="dark"] {
      --panel-bg: var(--panel-bg-dark);
      --border-color: var(--border-color-dark);
      --primary-text: var(--primary-text-dark);
      --secondary-text: var(--secondary-text-dark);
      --muted-text: var(--muted-text-dark);
      --glass-bg: var(--glass-bg-dark);
      --card-shadow: var(--card-shadow-dark);
    }

    * {
      box-sizing: border-box;
      transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    }

    html, body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      color: var(--primary-text);
      background: var(--primary-bg);
      background-attachment: fixed;
      overflow-x: hidden;
    }

    body[data-theme="dark"] {
      background: var(--primary-bg-dark);
    }

    .container {
      max-width: 520px;
      margin: 2rem auto 1.5rem auto;
      padding: 2.5rem 2rem 2rem 2rem;
      background: var(--panel-bg);
      backdrop-filter: var(--backdrop-blur);
      border-radius: 24px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      position: relative;
      z-index: 1;
      animation: slideInUp 0.6s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3) translateY(-50px);
      }
      50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
      }
      70% {
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes glow {
      0%, 100% {
        box-shadow: 0 0 5px var(--warning-color);
      }
      50% {
        box-shadow: 0 0 20px var(--warning-color), 0 0 30px var(--warning-color);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    .theme-toggle {
      position: absolute;
      top: -10px;
      right: -10px;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.3rem;
      transition: all 0.3s ease;
      backdrop-filter: var(--backdrop-blur);
      position: relative;
      overflow: hidden;
    }

    .theme-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .theme-toggle:hover::before {
      left: 100%;
    }

    .theme-toggle:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    h1 {
      color: var(--primary-blue);
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .version-badge {
      display: inline-block;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      color: white;
      padding: 0.2rem 0.8rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .labicon {
      font-size: 1.3em;
      vertical-align: middle;
      animation: pulse 2s infinite;
    }

    .copyright {
      font-size: 0.8rem;
      color: var(--muted-text);
      margin-top: 0.8rem;
      opacity: 0.8;
    }

    /* ğŸ¯ è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¿ãƒ– */
    .calculation-mode-tabs {
      display: flex;
      background: var(--glass-bg);
      border-radius: 12px;
      padding: 0.3rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      backdrop-filter: var(--backdrop-blur);
    }

    .tab-button {
      flex: 1;
      background: transparent;
      border: none;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--secondary-text);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tab-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .tab-button:hover::before {
      left: 100%;
    }

    .tab-button.active {
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
      transform: translateY(-1px);
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      pointer-events: none;
    }

    .tab-button:hover:not(.active) {
      background: rgba(66, 153, 225, 0.1);
      color: var(--primary-blue);
    }

    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
    .calculation-mode {
      display: none;
    }

    .calculation-mode.active {
      display: block;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0.6rem 1.1rem;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--secondary-text);
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: var(--backdrop-blur);
      position: relative;
      overflow: hidden;
      user-select: none;
    }

    .toolbar-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .toolbar-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      color: var(--primary-blue);
      border-color: var(--primary-blue);
    }

    .toolbar-btn:hover::before {
      left: 100%;
    }

    .toolbar-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .toolbar-btn.active {
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      border-color: var(--primary-blue);
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
      transform: translateY(-1px);
    }

    .toolbar-btn.active::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      pointer-events: none;
    }

    .form-section {
      margin-bottom: 2rem;
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border-radius: 18px;
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue), var(--success-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .form-section.completed::before {
      transform: scaleX(1);
    }

    .form-section.completed {
      border-color: var(--success-color);
      box-shadow: 0 0 20px rgba(72, 187, 120, 0.2);
    }

    .form-section.has-warnings {
      border-color: var(--warning-color);
      background: linear-gradient(135deg, 
        var(--glass-bg), 
        rgba(237, 137, 54, 0.05)
      );
      animation: glow 2s infinite;
    }

    .form-section.has-errors {
      border-color: var(--error-color);
      background: linear-gradient(135deg, 
        var(--glass-bg), 
        rgba(245, 101, 101, 0.05)
      );
      animation: shake 0.5s ease-in-out;
    }

    .form-section h2 {
      margin: 0 0 1.2rem 0;
      color: var(--primary-blue);
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .section-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
    }

    .section-status {
      font-size: 0.75rem;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-weight: 600;
      margin-left: auto;
      transition: all 0.3s ease;
    }

    .section-status.completed {
      background: linear-gradient(45deg, var(--success-color), #68d391);
      color: white;
      box-shadow: 0 2px 10px rgba(72, 187, 120, 0.3);
    }

    .section-status.error {
      background: linear-gradient(45deg, var(--error-color), #fc8181);
      color: white;
      box-shadow: 0 2px 10px rgba(245, 101, 101, 0.3);
    }

    .section-status.warning {
      background: linear-gradient(45deg, var(--warning-color), #f6ad55);
      color: white;
      box-shadow: 0 2px 10px rgba(237, 137, 54, 0.3);
      animation: pulse 1.5s infinite;
    }

    .input-group {
      margin-bottom: 1.3rem;
      position: relative;
    }

    .input-label {
      color: var(--primary-text);
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      display: block;
      position: relative;
    }

    .required::after {
      content: " *";
      color: var(--error-color);
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    .input-row {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-bottom: 0.3rem;
    }

    .input-with-status {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      flex: 1;
    }

    .input-with-unit {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      padding: 0.3rem;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .input-with-unit:focus-within {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      transform: translateY(-1px);
    }

    .input-with-unit input[type="number"] {
      flex: 1;
      min-width: 0;
      border: none;
      background: transparent;
      outline: none;
      font-size: 1rem;
      padding: 0.8rem;
      color: var(--primary-text);
      font-weight: 500;
    }

    .input-with-unit select {
      border: none;
      background: var(--glass-bg);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      color: var(--secondary-text);
      font-weight: 500;
      cursor: pointer;
      outline: none;
      min-width: 80px;
    }

    .input-with-unit span {
      color: var(--muted-text);
      font-size: 0.9rem;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
    }

    input, select {
      font-size: 1rem;
      padding: 1rem 1.2rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      font-family: inherit;
      background: rgba(255, 255, 255, 0.8);
      color: var(--primary-text);
      transition: all 0.3s ease;
      min-height: 48px;
      font-weight: 500;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
      transform: translateY(-2px);
    }

    input.valid {
      border-color: var(--success-color);
      background: rgba(72, 187, 120, 0.05);
    }

    input.invalid {
      border-color: var(--error-color) !important;
      background: rgba(245, 101, 101, 0.05);
      animation: shake 0.5s ease-in-out;
    }

    input.warning {
      border-color: var(--warning-color) !important;
      background: rgba(237, 137, 54, 0.05);
      animation: glow 1.5s infinite;
    }

    .input-status {
      font-size: 1.2rem;
      min-width: 24px;
      text-align: center;
      transition: all 0.3s ease;
      align-self: center;
    }

    .preset-chemicals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.6rem;
      margin-bottom: 1rem;
    }

    .preset-btn {
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.7rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      color: var(--secondary-text);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .preset-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(66, 153, 225, 0.2), transparent);
      transition: left 0.4s;
    }

    .preset-btn:hover::before {
      left: 100%;
    }

    .preset-btn:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
    }

    .preset-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç›´ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚’å¤§å¹…å¼·åŒ– */
    .input-error-message, .input-warning-message {
      font-size: 0.85rem;
      min-height: 1.2em;
      margin-top: 0.4rem;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      line-height: 1.4;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: bounceIn 0.4s ease-out;
      border-left: 4px solid;
      backdrop-filter: var(--backdrop-blur);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .input-error-message {
      color: var(--error-color);
      background: linear-gradient(135deg, 
        rgba(245, 101, 101, 0.15), 
        rgba(245, 101, 101, 0.05)
      );
      border-left-color: var(--error-color);
    }

    .input-error-message::before {
      content: "âš ï¸";
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    .input-warning-message {
      color: var(--warning-color);
      background: linear-gradient(135deg, 
        rgba(237, 137, 54, 0.15), 
        rgba(237, 137, 54, 0.05)
      );
      border-left-color: var(--warning-color);
    }

    .input-warning-message::before {
      content: "ğŸ’¡";
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    /* ç©ºã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®Œå…¨ã«éš ã™ */
    .input-error-message:empty, .input-warning-message:empty {
      display: none;
    }

    /* ğŸ¯ ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .concentration-display {
      background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(72, 187, 120, 0.1));
      border: 1px solid var(--primary-blue);
      padding: 1rem;
      border-radius: 12px;
      margin: 1rem 0;
      text-align: center;
      font-weight: 700;
      color: var(--primary-blue);
      backdrop-filter: var(--backdrop-blur);
      animation: bounceIn 0.4s ease-out;
    }

    .section-result {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      padding: 1rem 1.2rem;
      border-radius: 12px;
      margin-top: 1.2rem;
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
      color: var(--primary-text);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.4s ease;
      transform: translateY(-10px);
    }

    .section-result.show {
      opacity: 1;
      max-height: 300px;
      transform: translateY(0);
    }

    .section-result strong {
      color: var(--success-color);
      font-weight: 700;
    }

    .results-panel {
      position: fixed;
      top: 2rem;
      right: 2rem;
      width: 380px;
      max-width: 90vw;
      background: var(--panel-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      z-index: 999;
      animation: slideInRight 0.6s ease-out;
      transition: transform 0.3s cubic-bezier(.4,2,.6,1), max-height 0.4s ease;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .results-panel.minimized {
      transform: translateY(75%);
      max-height: 62px !important;
      min-height: 44px;
      overflow: hidden;
      opacity: 0.8;
      pointer-events: auto;
    }

    .results-panel.minimized .results-title {
      border-bottom: none;
    }

    .results-minimize-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      background: var(--glass-bg);
      border: 1.5px solid var(--border-color);
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary-blue);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 1px 8px rgba(66,153,225,0.12);
      backdrop-filter: var(--backdrop-blur);
    }

    .results-minimize-btn:hover {
      background: var(--primary-blue);
      color: #fff;
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
    }

    .results-minimize-btn:active {
      transform: scale(0.95);
    }

    .results-title {
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--primary-blue);
      font-size: 1.1rem;
      text-align: center;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0.5rem;
      position: relative;
    }

    .results-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: linear-gradient(45deg, var(--primary-blue), var(--success-color));
    }

    .results-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(2, 1fr);
    }

    .result-item {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .result-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-blue), var(--success-color));
    }

    .result-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .result-label {
      font-size: 0.75rem;
      color: var(--secondary-text);
      margin-bottom: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-value {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary-text);
      word-break: break-all;
    }

    .results-placeholder {
      text-align: center;
      color: var(--muted-text);
      font-style: italic;
      padding: 2rem 1rem;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 2px dashed var(--border-color);
      backdrop-filter: var(--backdrop-blur);
    }

    .btn {
      min-height: 48px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-blue-hover));
      color: white;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--glass-bg);
      color: var(--secondary-text);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-text);
      color: white;
    }

    .history-panel {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.5);
    }

    .history-item:hover {
      background: var(--primary-blue);
      color: white;
      transform: translateX(5px);
    }

    .formula-display {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      color: var(--primary-text);
      transition: all 0.3s ease;
    }

    .drug-info {
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
    }

    .info-table td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .info-label {
      font-weight: 600;
      color: var(--secondary-text);
      width: 30%;
    }

    /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é€šçŸ¥ï¼ˆç·Šæ€¥æ™‚ç”¨ï¼‰ */
    .floating-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 350px;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 1000;
      animation: bounceIn 0.5s ease-out;
      backdrop-filter: var(--backdrop-blur);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .floating-notification.success {
      background: linear-gradient(135deg, rgba(72, 187, 120, 0.9), rgba(72, 187, 120, 0.7));
      color: white;
      border-left-color: var(--success-color);
    }

    .floating-notification.warning {
      background: linear-gradient(135deg, rgba(237, 137, 54, 0.9), rgba(237, 137, 54, 0.7));
      color: white;
      border-left-color: var(--warning-color);
    }

    .floating-notification.error {
      background: linear-gradient(135deg, rgba(245, 101, 101, 0.9), rgba(245, 101, 101, 0.7));
      color: white;
      border-left-color: var(--error-color);
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .keyboard-shortcuts {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background: var(--glass-bg);
      backdrop-filter: var(--backdrop-blur);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: var(--muted-text);
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .keyboard-shortcuts:hover {
      opacity: 1;
    }

    small {
      color: var(--muted-text);
      font-size: 0.8rem;
      line-height: 1.4;
    }

    @media (max-width: 1200px) {
      .results-panel {
        right: 1rem;
        width: 340px;
      }
    }

    @media (max-width: 768px) {
      .container {
        max-width: 95vw;
        padding: 1.5rem 1rem;
        margin: 1rem auto;
      }

      .results-panel {
        left: 0;
        right: 0;
        top: auto;
        bottom: 0;
        width: 100vw;
        max-width: 100vw;
        border-radius: 20px 20px 0 0;
        border-width: 1px 0 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        padding: 1.5rem 1rem 2rem 1rem;
        animation: slideInUp 0.6s ease-out;
      }

      .results-panel.minimized {
  	transform: translateY(0%);
  	max-height: 56px !important;
  	min-height: 44px;
  	opacity: 0.97;
  	pointer-events: auto;
  	bottom: 0;
  	left: 0;
  	right: 0;
	}


      .results-minimize-btn {
        width: 44px;
        height: 44px;
        font-size: 2rem;
        top: 8px;
        right: 8px;
      }

      .results-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .toolbar {
        justify-content: center;
      }

      .toolbar-btn {
        font-size: 0.7rem;
        padding: 0.5rem 0.9rem;
      }

      .keyboard-shortcuts {
        display: none;
      }

      .preset-chemicals {
        grid-template-columns: repeat(2, 1fr);
      }

      .floating-notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .calculation-mode-tabs {
        flex-direction: column;
        gap: 0.3rem;
      }

      .tab-button {
        font-size: 0.8rem;
        padding: 0.6rem 0.8rem;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }

      .container {
        padding: 1rem 0.8rem;
      }

      .form-section {
        padding: 1rem;
      }

      .input-row {
        flex-direction: column;
        gap: 0.5rem;
      }

      .preset-chemicals {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Print styles */
    @media print {
      .results-panel,
      .toolbar,
      .theme-toggle,
      .keyboard-shortcuts,
      .calculation-mode-tabs {
        display: none !important;
      }

      .container {
        box-shadow: none;
        border: 1px solid #000;
        max-width: 100%;
        margin: 0;
      }

      body {
        background: white !important;
      }
    }
  </style>
</head>
<body>
<button id="theme-btn" class="theme-toggle" aria-label="ç¹ãƒ»ãƒ»ç¹æ§«ãƒ»è­–ï½¿">îæŠ½</button>
  <div class="container">
    <header class="header">
      <div class="theme-toggle" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿ (Ctrl+D)">
        <span id="theme-icon">ğŸ’Š</span>
      </div>
      <h1>
        YoshinovaCalc Lab Ver.1.1
      </h1>
      <div class="copyright">
        Â© 2025 Fumihiko Yoshino. All Rights Reserved. Update:2025-06-06
      </div>
    </header>

    <!-- ğŸ¯ è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¿ãƒ– -->
    <div class="calculation-mode-tabs">
      <button class="tab-button active" onclick="switchCalculationMode('stock')" id="tab-stock">
        ğŸ”¬ ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²èª¿è£½
      </button>
      <button class="tab-button" onclick="switchCalculationMode('molarity')" id="tab-molarity">
        ğŸ§ª ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—
      </button>
    </div>

    <div class="toolbar">
      <button class="toolbar-btn" id="formula-btn" onclick="toggleFormula()" title="è¨ˆç®—å¼è¡¨ç¤º (Ctrl+F)">
        ğŸ“ è¨ˆç®—å¼
      </button>
      <button class="toolbar-btn" id="history-btn" onclick="toggleHistory()" title="å±¥æ­´è¡¨ç¤º (Ctrl+H)">
        ğŸ“‹ å±¥æ­´
      </button>
      <button class="toolbar-btn" onclick="exportResults()" title="PDFå‡ºåŠ› (Ctrl+P)">
        ğŸ“„ PDFå‡ºåŠ›
      </button>
      <button class="toolbar-btn" onclick="clearAll()" title="ãƒªã‚»ãƒƒãƒˆ (Ctrl+R)">
        ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>

    <main id="main-content">
      <!-- ğŸ”¬ ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²èª¿è£½ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="stock-mode" class="calculation-mode active">
        <!-- ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹åŒ–åˆç‰©ã®ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
        <section class="form-section" id="section-presets">
          <h2>
            <div class="section-icon">âš¡</div>
            ã‚¯ã‚¤ãƒƒã‚¯ãƒ—ãƒªã‚»ãƒƒãƒˆ
          </h2>
          <div class="preset-chemicals">
            <button class="preset-btn" onclick="applyPreset('4-OH-TEMPO', 157.25)">4-OH-TEMPO</button>
            <button class="preset-btn" onclick="applyPreset('CYPMPO', 225.32)">CYPMPO</button>
            <button class="preset-btn" onclick="applyPreset('L-histidine', 155.15)">L-histidine</button>
            <button class="preset-btn" onclick="applyPreset('Phloxine B', 641.83)">Phloxine B</button>
            <button class="preset-btn" onclick="applyPreset('Rose Bengal', 1017.60)">Rose Bengal</button>
            <button class="preset-btn" onclick="applyPreset('TEMPOL', 172.24)">TEMPOL</button>
          </div>
        </section>

        <!-- ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²è¨­å®š -->
        <section class="form-section" id="section-stock" role="region" aria-labelledby="stock-heading">
          <h2 id="stock-heading">
            <div class="section-icon">ğŸ”¬</div>
            ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²è¨­å®š
            <span class="section-status" id="status-stock"></span>
          </h2>
          <div class="input-group">
            <label for="mw" class="input-label required">åˆ†å­é‡ï¼ˆg/molï¼‰</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="mw" step="0.01" placeholder="åˆ†å­é‡" required inputmode="decimal" accesskey="m">
                  <span>g/mol</span>
                </div>
                <span class="input-status" id="status-mw"></span>
                <div class="input-error-message" id="error-mw"></div>
              </div>
            </div>
            <small>ç‰©è³ªã®åˆ†å­é‡ã‚’g/molå˜ä½ã§å…¥åŠ› (Shortcut: Alt+M)</small>
          </div>

          <div class="input-group">
            <label for="molarity" class="input-label required">ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã®ãƒ¢ãƒ«æ¿ƒåº¦</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="molarity" step="any" min="0" placeholder="æ¿ƒåº¦" required inputmode="decimal" accesskey="c">
                  <select id="molarity_unit" aria-label="æ¿ƒåº¦ã®å˜ä½">
                    <option value="1">mol/L</option>
                    <option value="0.001">mmol/L</option>
                    <option value="0.000001">Î¼mol/L</option>
                    <option value="0.000000001">nmol/L</option>
                  </select>
                </div>
                <span class="input-status" id="status-molarity"></span>
                <div class="input-error-message" id="error-molarity"></div>
              </div>
            </div>
            <small>èª¿è£½ã—ãŸã„ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã®æ¿ƒåº¦ã‚’å…¥åŠ› (Shortcut: Alt+C)</small>
          </div>

          <div class="input-group">
            <label for="volume" class="input-label required">ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="volume" step="any" min="0" placeholder="èª¿è£½é‡" required inputmode="decimal" accesskey="v">
                  <select id="volume_unit" aria-label="ä½“ç©ã®å˜ä½">
                    <option value="0.001">mL</option>
                    <option value="1">L</option>
                  </select>
                </div>
                <span class="input-status" id="status-volume"></span>
                <div class="input-error-message" id="error-volume"></div>
              </div>
            </div>
            <small>èª¿è£½ã—ãŸã„ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã®ç·é‡ã‚’å…¥åŠ› (Shortcut: Alt+V)</small>
          </div>

          <div class="input-group">
            <label for="mass_unit" class="input-label">è¡¨ç¤ºå˜ä½ï¼ˆå¿…è¦ãªè–¬é‡ï¼‰</label>
            <div class="input-row">
              <select id="mass_unit" aria-label="è³ªé‡ã®è¡¨ç¤ºå˜ä½" style="width:7em;">
                <option value="mg">mg</option>
                <option value="g">g</option>
                <option value="Î¼g">Î¼g</option>
              </select>
            </div>
          </div>

          <div id="section-result-stock" class="section-result" aria-live="polite"></div>
        </section>

        <!-- å¸Œé‡ˆè¨ˆç®— -->
        <section class="form-section" id="section-dilution" role="region" aria-labelledby="dilution-heading">
          <h2 id="dilution-heading">
            <div class="section-icon">ğŸ’§</div>
            å¸Œé‡ˆè¨ˆç®—ï¼ˆä»»æ„ï¼‰
            <span class="section-status" id="status-dilution"></span>
          </h2>
          <div class="input-group">
            <label for="final_molarity" class="input-label">å®Ÿé¨“ã§ã®æœ€çµ‚æ¿ƒåº¦</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="final_molarity" step="any" min="0" placeholder="ä¾‹: 5" inputmode="decimal" accesskey="f">
                  <select id="final_molarity_unit" aria-label="æœ€çµ‚æ¿ƒåº¦ã®å˜ä½">
                    <option value="1">mol/L</option>
                    <option value="0.001">mmol/L</option>
                    <option value="0.000001">Î¼mol/L</option>
                    <option value="0.000000001">nmol/L</option>
                  </select>
                </div>
                <span class="input-status" id="status-final-molarity"></span>
                <div class="input-error-message" id="error-final-molarity"></div>
              </div>
            </div>
            <small>å®Ÿé¨“ã§ä½¿ç”¨ã—ãŸã„æœ€çµ‚æ¿ƒåº¦ã‚’å…¥åŠ› (Shortcut: Alt+F)</small>
          </div>

          <div class="input-group">
            <label for="final_total_vol" class="input-label">å¸Œé‡ˆå¾Œç·é‡ï¼ˆæº¶åª’ï¼‹ã‚µãƒ³ãƒ—ãƒ«ï¼‰</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="final_total_vol" step="any" min="0" placeholder="ä¾‹: 100" inputmode="decimal" accesskey="t">
                  <select id="final_total_vol_unit" aria-label="å¸Œé‡ˆå¾Œç·é‡ã®å˜ä½">
                    <option value="0.001">Î¼L</option>
                    <option value="1">mL</option>
                  </select>
                </div>
                <span class="input-status" id="status-final-volume"></span>
                <div class="input-error-message" id="error-final-total-vol"></div>
              </div>
            </div>
            <small>æº¶åª’ã«ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã‚’æ·»åŠ ã—ãŸå¾Œã®æœ€çµ‚ç·æ¶²é‡ã‚’å…¥åŠ› (Shortcut: Alt+T)</small>
          </div>

          <div id="section-result-dilution" class="section-result" aria-live="polite"></div>
        </section>

        <!-- CIDæ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="form-section" id="section-search" role="region" aria-labelledby="search-heading">
          <h2 id="search-heading">
            <div class="section-icon">ğŸ”</div>
            è–¬ç‰©æƒ…å ±æ¤œç´¢ï¼ˆCIDã‚³ãƒ¼ãƒ‰ï¼‰
            <span class="section-status" id="status-search"></span>
          </h2>
          <div class="input-group">
            <label for="cid" class="input-label">CIDã‚³ãƒ¼ãƒ‰</label>
            <div class="input-row">
              <div class="input-with-status" style="flex-direction: column;">
                <input type="text" id="cid" autocomplete="off" placeholder="ä¾‹: 54670067" aria-describedby="cid-help" accesskey="s">
                <span class="input-status" id="status-cid"></span>
                <div class="input-error-message" id="error-cid"></div>
              </div>
              <button class="btn btn-primary" type="button" onclick="fetchPubChem()">
                <span id="search-text">æ¤œç´¢</span>
              </button>
            </div>
            <small id="cid-help">PubChemã®Compound IDã‚’å…¥åŠ› (Shortcut: Alt+S)</small>
          </div>
          <div id="drug_info" class="drug-info" style="display:none;" role="region" aria-labelledby="drug-info-heading">
            <h3 id="drug-info-heading" class="sr-only">å–å¾—ã—ãŸè–¬ç‰©æƒ…å ±</h3>
          </div>
        </section>
      </div>

      <!-- ğŸ§ª ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="molarity-mode" class="calculation-mode">
        <section class="form-section" id="section-molarity-info">
          <h2>
            <div class="section-icon">ğŸ’¡</div>
            è¨ˆç®—æ‰‹é †
          </h2>
          <div style="background: rgba(66, 153, 225, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-blue);">
            <strong>ã‚¹ãƒ†ãƒƒãƒ—:</strong><br>
            1. è³ªé‡æ¿ƒåº¦ (mg/mL) = è–¬ç‰©é‡ Ã· æ¶²é‡<br>
            2. ãƒ¢ãƒ«æ¿ƒåº¦ (mol/L) = è³ªé‡æ¿ƒåº¦ (mg/mL) Ã· åˆ†å­é‡ (g/mol)
          </div>
        </section>

        <section class="form-section" id="section-molarity-calc">
          <h2>
            <div class="section-icon">ğŸ§ª</div>
            åˆ†å­é‡ãƒ»è–¬ç‰©é‡ãƒ»æ¶²é‡å…¥åŠ›
            <span class="section-status" id="status-molarity-calc"></span>
          </h2>
          
          <div class="input-group">
            <label for="molecular_weight" class="input-label required">åˆ†å­é‡</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number"
                         id="molecular_weight"
                         step="0.01"
                         placeholder="ä¾‹: 300.0"
                         required
                         inputmode="decimal">
                  <span>g/mol</span>
                </div>
                <span class="input-status" id="status-molecular-weight"></span>
                <div class="input-error-message" id="error-molecular-weight"></div>
              </div>
            </div>
            <small>è–¬ç‰©ã®åˆ†å­é‡ï¼ˆãƒ€ãƒ«ãƒˆãƒ³å€¤ã¨åŒã˜ï¼‰</small>
          </div>
          <div class="input-group">
            <label for="drug_amount" class="input-label required">è–¬ç‰©é‡</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="drug_amount" step="0.0001" placeholder="ä¾‹: 10.0" required inputmode="decimal">
                  <select id="drug_unit" aria-label="è–¬ç‰©é‡ã®å˜ä½">
                    <option value="mg" selected>mg</option>
                    <option value="g">g</option>
                    <option value="Î¼g">Î¼g</option>
                    <option value="ng">ng</option>
                    <option value="kg">kg</option>
                  </select>
                </div>
                <span class="input-status" id="status-drug-amount"></span>
                <div class="input-error-message" id="error-drug-amount"></div>
              </div>
            </div>
            <small>è–¬ç‰©ã®ç·é‡é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>

          <div class="input-group">
            <label for="liquid_volume" class="input-label required">æ¶²é‡ï¼ˆæº¶åª’é‡ï¼‰</label>
            <div class="input-row">
              <div class="input-with-status">
                <div class="input-with-unit">
                  <input type="number" id="liquid_volume" step="0.0001" placeholder="ä¾‹: 10.0" required inputmode="decimal">
                  <select id="liquid_unit" aria-label="æ¶²é‡ã®å˜ä½">
                    <option value="mL" selected>mL</option>
                    <option value="L">L</option>
                    <option value="Î¼L">Î¼L</option>
                    <option value="nL">nL</option>
                    <option value="dL">dL</option>
                  </select>
                </div>
                <span class="input-status" id="status-liquid-volume"></span>
                <div class="input-error-message" id="error-liquid-volume"></div>
              </div>
            </div>
            <small>è–¬ç‰©ã‚’æº¶è§£ã™ã‚‹æº¶åª’ã®ä½“ç©</small>
          </div>

          <div id="concentration-display" class="concentration-display" style="display: none;" aria-live="polite">
            è³ªé‡æ¿ƒåº¦: <span id="concentration-value">-</span> mg/mL
          </div>

            <div class="input-group">
            <label for="drug_name" class="input-label">è–¬ç‰©åï¼ˆä»»æ„ï¼‰</label>
            <div class="input-row">
              <input type="text" id="drug_name" placeholder="ä¾‹: ã‚¢ã‚¹ãƒ”ãƒªãƒ³" style="width: 100%;">
            </div>
            <small>è¨ˆç®—çµæœã®è¡¨ç¤ºç”¨</small>
          </div>
        </section>
      </div>

      <!-- è¨ˆç®—å¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="formula-display" class="formula-display" style="display:none;">
        <h3>ğŸ’¡ è¨ˆç®—å¼</h3>
        <div id="formula-content"></div>
      </div>

      <!-- å±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="history-panel" class="history-panel" style="display:none;">
        <h3>ğŸ“‹ è¨ˆç®—å±¥æ­´</h3>
        <div id="history-content"></div>
        <button class="btn btn-secondary" onclick="clearHistory()" style="width: 100%; margin-top: 1rem;">
          å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        </button>
      </div>
    </main>
  </div>

  <!-- è¨ˆç®—çµæœãƒ‘ãƒãƒ«ï¼šPCå³ä¸Š/ã‚¹ãƒãƒ›ä¸‹éƒ¨ã«è¿½å¾“ -->
  <div class="results-panel" id="results-panel">
    <button id="results-minimize-btn"
            class="results-minimize-btn"
            title="çµæœãƒ‘ãƒãƒ«ã‚’æœ€å°åŒ–"
            aria-label="çµæœãƒ‘ãƒãƒ«ã‚’æœ€å°åŒ–"
            type="button">
      <span id="results-minimize-icon">â–¼</span>
    </button>
    <div class="results-title">âš—ï¸ è¨ˆç®—çµæœ</div>
    <div id="results-content">
      <div class="results-placeholder">
        å¿…è¦é …ç›®ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    </div>
  </div>

  <!-- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¡¨ç¤º -->
  <div class="keyboard-shortcuts">
    ğŸ’¡ Ctrl+D: ãƒ†ãƒ¼ãƒåˆ‡æ›¿ | Ctrl+F: è¨ˆç®—å¼ | Ctrl+H: å±¥æ­´ | Ctrl+R: ãƒªã‚»ãƒƒãƒˆ
  </div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentValidation = { warnings: [], errors: [] };
let calculationHistory = JSON.parse(localStorage.getItem('molarity-calc-history') || '[]');
let isDarkMode = localStorage.getItem('theme') === 'dark';
let activeStates = {
  formula: false,
  history: false
};
let currentCalculationMode = 'stock'; // 'stock' ã¾ãŸã¯ 'molarity'

// ğŸ¯ ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ç”¨ã®å˜ä½å¤‰æ›ä¿‚æ•°
const drugUnitFactors = {
  'mg': 1,
  'g': 1000,
  'Î¼g': 0.001,
  'ng': 0.000001,
  'kg': 1000000
};

const volumeUnitFactors = {
  'mL': 1,
  'L': 1000,
  'Î¼L': 0.001,
  'nL': 0.000001,
  'dL': 100
};

// ğŸ¯ å®Œå…¨ã«ä¿®æ­£ã•ã‚ŒãŸæœ€å°åŒ–ãƒœã‚¿ãƒ³æ©Ÿèƒ½
function initializeResultsMinimizeButton() {
  const resultsPanel = document.getElementById('results-panel');
  const minimizeBtn = document.getElementById('results-minimize-btn');
  const minimizeIcon = document.getElementById('results-minimize-icon');
  const resultsTitle = document.querySelector('.results-title'); // â˜…è¿½åŠ 

  if (!resultsPanel || !minimizeBtn || !minimizeIcon || !resultsTitle) {
    console.error('çµæœãƒ‘ãƒãƒ«ã¾ãŸã¯æœ€å°åŒ–ãƒœã‚¿ãƒ³ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  function setResultsPanelMinimized(minimized) {
    if (minimized) {
      resultsPanel.classList.add('minimized');
      minimizeIcon.textContent = 'â–²';
      minimizeBtn.title = 'çµæœãƒ‘ãƒãƒ«ã‚’å…ƒã«æˆ»ã™';
      minimizeBtn.setAttribute('aria-label', 'çµæœãƒ‘ãƒãƒ«ã‚’å…ƒã«æˆ»ã™');
      resultsTitle.innerHTML = 'â–² è¨ˆç®—çµæœã‚’é–‹ãï¼ˆã‚¿ãƒƒãƒ—ï¼‰'; // ãƒ’ãƒ³ãƒˆãŠã™ã™ã‚
      localStorage.setItem('results-panel-minimized', 'true');
    } else {
      resultsPanel.classList.remove('minimized');
      minimizeIcon.textContent = 'â–¼';
      minimizeBtn.title = 'çµæœãƒ‘ãƒãƒ«ã‚’æœ€å°åŒ–';
      minimizeBtn.setAttribute('aria-label', 'çµæœãƒ‘ãƒãƒ«ã‚’æœ€å°åŒ–');
      resultsTitle.innerHTML = (currentCalculationMode === 'stock')
        ? 'âš—ï¸ è¨ˆç®—çµæœ'
        : 'ğŸ§ª ãƒ¢ãƒ«æ¿ƒåº¦çµæœ';
      localStorage.setItem('results-panel-minimized', 'false');
    }
  }

  // â˜…ã“ã“ï¼
  minimizeBtn.addEventListener('click', function(event) {
    event.preventDefault();
    event.stopPropagation();
    const isCurrentlyMinimized = resultsPanel.classList.contains('minimized');
    setResultsPanelMinimized(!isCurrentlyMinimized);
  });

  // â˜…ã“ã“ã‚‚ï¼
  resultsTitle.addEventListener('click', function() {
    if (resultsPanel.classList.contains('minimized')) {
      setResultsPanelMinimized(false);
    }
  });

  // åˆæœŸçŠ¶æ…‹ã®å¾©å…ƒ
  const shouldBeMinimized = localStorage.getItem('results-panel-minimized') === 'true';
  setResultsPanelMinimized(shouldBeMinimized);
  
  console.log('çµæœãƒ‘ãƒãƒ«ã®æœ€å°åŒ–ãƒœã‚¿ãƒ³ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
}


// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMèª­ã¿è¾¼ã¿å®Œäº†ã€åˆæœŸåŒ–é–‹å§‹...');
  
  if (isDarkMode) {
    document.body.setAttribute('data-theme', 'dark');
    document.getElementById('theme-icon').textContent = 'ğŸ”¬';
  }
  
  loadHistory();
  setupKeyboardShortcuts();
  setupMolarityCalculationListeners();
  updateResultsPanelTitle();
  
  // ğŸ¯ æœ€å°åŒ–ãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆï¼‰
  initializeResultsMinimizeButton();
  
  console.log('åˆæœŸåŒ–å®Œäº†');
});

// ğŸ¯ results-panelã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å¤‰æ›´
function updateResultsPanelTitle() {
  const resultsTitle = document.querySelector('.results-title');
  // ã‚‚ã—æœ€å°åŒ–ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (document.getElementById('results-panel').classList.contains('minimized')) return;
  if (currentCalculationMode === 'stock') {
    resultsTitle.innerHTML = 'âš—ï¸ è¨ˆç®—çµæœ';
  } else {
    resultsTitle.innerHTML = 'ğŸ§ª ãƒ¢ãƒ«æ¿ƒåº¦çµæœ';
  }
}

// ğŸ¯ è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function switchCalculationMode(mode) {
  currentCalculationMode = mode;
  
  // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`tab-${mode}`).classList.add('active');
  
  // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
  document.querySelectorAll('.calculation-mode').forEach(el => el.classList.remove('active'));
  document.getElementById(`${mode}-mode`).classList.add('active');
  
  // çµæœã‚’ã‚¯ãƒªã‚¢
  clearModeResults();
  
  // ğŸ¯ results-panelã®ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
  updateResultsPanelTitle();
  
  // è¨ˆç®—å¼ã®æ›´æ–°
  if (activeStates.formula) {
    updateFormulaDisplay();
  }
  
  showFloatingNotification(
    mode === 'stock' ? 'ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²èª¿è£½ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ' : 'ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', 
    'success'
  );
  
  // ğŸ¯ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å¾Œã«è¨ˆç®—ã‚’å†å®Ÿè¡Œ
  if (mode === 'stock') {
    updateMainResults();
  } else {
    calculateMolarity();
  }
}

function clearModeResults() {
  // results-panelã®çµæœã‚’ã‚¯ãƒªã‚¢
  document.getElementById('results-content').innerHTML = `
    <div class="results-placeholder">
      å¿…è¦é …ç›®ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
    </div>
  `;
  
  // ãƒ¢ãƒ«æ¿ƒåº¦ãƒ¢ãƒ¼ãƒ‰ã®è³ªé‡æ¿ƒåº¦è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
  const concentrationDisplay = document.getElementById('concentration-display');
  if (concentrationDisplay) {
    concentrationDisplay.style.display = 'none';
  }
}

// ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function toggleTheme() {
  isDarkMode = !isDarkMode;
  if (isDarkMode) {
    document.body.setAttribute('data-theme', 'dark');
    document.getElementById('theme-icon').textContent = 'ğŸ”¬';
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.removeAttribute('data-theme');
    document.getElementById('theme-icon').textContent = 'ğŸ’Š';
    localStorage.setItem('theme', 'light');
  }
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¨­å®š
function setupKeyboardShortcuts() {
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch(e.key) {
        case 'd':
          e.preventDefault();
          toggleTheme();
          break;
        case 'f':
          e.preventDefault();
          toggleFormula();
          break;
        case 'h':
          e.preventDefault();
          toggleHistory();
          break;
        case 'r':
          e.preventDefault();
          clearAll();
          break;
        case 'p':
          e.preventDefault();
          exportResults();
          break;
        case '1':
          e.preventDefault();
          switchCalculationMode('stock');
          break;
        case '2':
          e.preventDefault();
          switchCalculationMode('molarity');
          break;
      }
    }
  });
}

// ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨
function applyPreset(name, mw) {
  if (currentCalculationMode === 'stock') {
    document.getElementById('mw').value = mw;
    updateMainResults();
  } else {
    document.getElementById('molecular_weight').value = mw;
    document.getElementById('drug_name').value = name;
    calculateMolarity();
  }
  showFloatingNotification(`${name} (MW: ${mw}) ãŒã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ`, 'success');
}

// ğŸ¯ æ”¹å–„ã•ã‚ŒãŸé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
function showFloatingNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = `floating-notification ${type}`;
  
  const icon = type === 'error' ? 'âš ï¸' : type === 'warning' ? 'ğŸ’¡' : 'âœ…';
  notification.innerHTML = `<span style="font-size: 1.2rem;">${icon}</span><span>${message}</span>`;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100px)';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, duration);
}

// è¨ˆç®—å¼è¡¨ç¤ºåˆ‡æ›¿
function toggleFormula() {
  activeStates.formula = !activeStates.formula;
  if (activeStates.formula) {
    updateFormulaDisplay();
    document.getElementById('formula-display').style.display = 'block';
    document.getElementById('formula-btn').classList.add('active');
  } else {
    document.getElementById('formula-display').style.display = 'none';
    document.getElementById('formula-btn').classList.remove('active');
  }
}

function updateFormulaDisplay() {
  const formulaContent = document.getElementById('formula-content');

  if (currentCalculationMode === 'stock') {
    // å…¥åŠ›å€¤å–å¾—
    const mw = document.getElementById('mw').value;
    const molarity = document.getElementById('molarity').value;
    const molarity_unit_el = document.getElementById('molarity_unit');
    const molarity_unit_txt = molarity_unit_el.options[molarity_unit_el.selectedIndex].text;
    const molarity_unit_val = parseFloat(molarity_unit_el.value);
    const volume = document.getElementById('volume').value;
    const volume_unit_el = document.getElementById('volume_unit');
    const volume_unit_txt = volume_unit_el.options[volume_unit_el.selectedIndex].text;
    const volume_unit_val = parseFloat(volume_unit_el.value);

    // å¸Œé‡ˆè¨ˆç®—ç”¨
    const final_molarity = document.getElementById('final_molarity').value;
    const final_molarity_unit = document.getElementById('final_molarity_unit');
    const final_molarity_unit_txt = final_molarity_unit.options[final_molarity_unit.selectedIndex].text;
    const final_total_vol = document.getElementById('final_total_vol').value;
    const final_total_vol_unit = document.getElementById('final_total_vol_unit');
    const final_total_vol_unit_txt = final_total_vol_unit.options[final_total_vol_unit.selectedIndex].text;

    // ä½“ç©Læ›ç®—
    let volume_L = "";
    if (volume && volume_unit_val) {
      volume_L = (parseFloat(volume) * volume_unit_val).toFixed(6);
    }

    // ãƒ¢ãƒ«æ¿ƒåº¦mol/Læ›ç®—
    let molarity_molL = "";
    if (molarity && molarity_unit_val) {
      molarity_molL = (parseFloat(molarity) * molarity_unit_val).toExponential(6);
    }

    // å¿…è¦è–¬é‡ï¼ˆgï¼‰è¨ˆç®—
    let mass = "";
    if (mw && molarity && molarity_unit_val && volume && volume_unit_val) {
      mass = (parseFloat(mw) * parseFloat(molarity) * molarity_unit_val * parseFloat(volume) * volume_unit_val).toFixed(6);
    }

    // å¿…è¦è–¬é‡ã®ä¾‹
    let stockExample = '';
    if (mw && molarity && volume) {
      stockExample = `
        <div style="margin-top:0.6em;">
          ä¾‹: <b>${mw}</b> (g/mol) Ã— <b>${molarity}</b> (${molarity_unit_txt}) Ã— <b>${volume}</b> (${volume_unit_txt})
          <br>ï¼ <b>${mw}</b> (g/mol) Ã— <b>${molarity_molL}</b> (mol/L) Ã— <b>${volume_L}</b> (L)
          <br>ï¼ <span style="color:#38a169;font-weight:bold;">${mass} g</span>
        </div>
        <div style="color:#555;font-size:0.95em;">
          â€»ä½“ç©ãƒ»æ¿ƒåº¦ã¯è‡ªå‹•ã§SIå˜ä½(L, mol/L)ã«æ›ç®—
        </div>
      `;
    }

    // å¸Œé‡ˆè¨ˆç®—ã®ä¾‹
    let dilutionExample = '';
    if (final_molarity && final_total_vol && molarity) {
      dilutionExample = `
        <div style="margin-top:0.6em;">
          ä¾‹: <b>${final_molarity}</b> Ã— <b>${final_total_vol}</b> Ã· <b>${molarity}</b> = <span style="color:#3182ce;font-weight:bold;">${(final_molarity * final_total_vol / molarity).toFixed(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[å˜ä½: ${final_molarity_unit_txt}, ${final_total_vol_unit_txt}, ${molarity_unit_txt}]</div>
      `;
    }

    // å¸Œé‡ˆå€ç‡ã®ä¾‹
    let factorExample = '';
    if (molarity && final_molarity) {
      factorExample = `
        <div style="margin-top:0.6em;">
          ä¾‹: <b>${molarity}</b> Ã· <b>${final_molarity}</b> = <span style="color:#ed8936;font-weight:bold;">${(molarity / final_molarity).toFixed(2)} å€</span>
        </div>
      `;
    }

    // ã“ã“ã§ã¾ã¨ã‚ã¦HTMLã«ã‚»ãƒƒãƒˆ
    formulaContent.innerHTML = `
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">
          å¿…è¦è–¬é‡ (g) = åˆ†å­é‡ (g/mol) Ã— ãƒ¢ãƒ«æ¿ƒåº¦ (mol/L) Ã— ä½“ç© (L)
        </span>
        ${stockExample}
      </div>
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">å¸Œé‡ˆè¨ˆç®—: V<sub>1</sub> = (C<sub>2</sub> Ã— V<sub>2</sub>) Ã· C<sub>1</sub></span>
        ${dilutionExample}
        <div style="color:#718096;font-size:0.9em;">V<sub>1</sub>: å¿…è¦ãªã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡, C<sub>1</sub>: ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦, C<sub>2</sub>: æœ€çµ‚æ¿ƒåº¦, V<sub>2</sub>: æœ€çµ‚ä½“ç©</div>
      </div>
      <div>
        <span style="font-weight:bold;">å¸Œé‡ˆå€ç‡ = ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ Ã· æœ€çµ‚æ¿ƒåº¦</span>
        ${factorExample}
      </div>
    `;
  } else {
    // ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰
    const drug_amount = document.getElementById('drug_amount').value;
    const drug_unit = document.getElementById('drug_unit').value;
    const liquid_volume = document.getElementById('liquid_volume').value;
    const liquid_unit = document.getElementById('liquid_unit').value;
    const molecular_weight = document.getElementById('molecular_weight').value;

    let step1 = '';
    if (drug_amount && liquid_volume) {
      step1 = `
        <div style="margin-top:0.6em;">
          ä¾‹: <b>${drug_amount}</b> Ã· <b>${liquid_volume}</b> = <span style="color:#38a169;font-weight:bold;">${(drug_amount / liquid_volume).toFixed(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[å˜ä½: ${drug_unit}, ${liquid_unit}]</div>
      `;
    }
    let step2 = '';
    if (drug_amount && liquid_volume && molecular_weight) {
      step2 = `
        <div style="margin-top:0.6em;">
          ä¾‹: ${drug_amount / liquid_volume} Ã· ${molecular_weight} = <span style="color:#3182ce;font-weight:bold;">${((drug_amount / liquid_volume) / molecular_weight).toExponential(3)}</span>
        </div>
        <div style="color:#718096;font-size:0.9em;">[å˜ä½: mol/L]</div>
      `;
    }

    formulaContent.innerHTML = `
      <div style="margin-bottom:1.5em;">
        <span style="font-weight:bold;">è³ªé‡æ¿ƒåº¦ = è–¬ç‰©é‡ Ã· æ¶²é‡</span>
        ${step1}
      </div>
      <div>
        <span style="font-weight:bold;">ãƒ¢ãƒ«æ¿ƒåº¦ = è³ªé‡æ¿ƒåº¦ Ã· åˆ†å­é‡</span>
        ${step2}
      </div>
    `;
  }
}

// å±¥æ­´è¡¨ç¤ºåˆ‡æ›¿
function toggleHistory() {
  const historyPanel = document.getElementById('history-panel');
  const historyBtn = document.getElementById('history-btn');
  
  activeStates.history = !activeStates.history;
  
  if (activeStates.history) {
    loadHistory();
    historyPanel.style.display = 'block';
    historyBtn.classList.add('active');
  } else {
    historyPanel.style.display = 'none';
    historyBtn.classList.remove('active');
  }
}

// å±¥æ­´ä¿å­˜
function saveToHistory() {
  if (currentCalculationMode === 'stock') {
    const mw = parseFloat(document.getElementById('mw').value);
    const molarity = parseFloat(document.getElementById('molarity').value);
    const volume = parseFloat(document.getElementById('volume').value);
    
    if (!isNaN(mw) && !isNaN(molarity) && !isNaN(volume)) {
      const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
      const volume_unit = parseFloat(document.getElementById('volume_unit').value);
      const mass_mg = mw * molarity * molarity_unit * volume * volume_unit * 1000;
      
      const historyItem = {
        type: 'stock',
        timestamp: new Date().toLocaleString('ja-JP'),
        mw: mw,
        molarity: molarity,
        molarity_unit: document.getElementById('molarity_unit').options[document.getElementById('molarity_unit').selectedIndex].text,
        volume: volume,
        volume_unit: document.getElementById('volume_unit').options[document.getElementById('volume_unit').selectedIndex].text,
        mass_mg: mass_mg
      };
      
      calculationHistory.unshift(historyItem);
      if (calculationHistory.length > 15) {
        calculationHistory.pop();
      }
      
      localStorage.setItem('molarity-calc-history', JSON.stringify(calculationHistory));
    }
  } else {
    // ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ã®å±¥æ­´ä¿å­˜
    const drugAmount = parseFloat(document.getElementById('drug_amount').value);
    const liquidVolume = parseFloat(document.getElementById('liquid_volume').value);
    const molecularWeight = parseFloat(document.getElementById('molecular_weight').value);
    const drugName = document.getElementById('drug_name').value;
    
    if (!isNaN(drugAmount) && !isNaN(liquidVolume) && !isNaN(molecularWeight)) {
      const drugUnit = document.getElementById('drug_unit').value;
      const liquidUnit = document.getElementById('liquid_unit').value;
      
      const drugAmountInMg = drugAmount * drugUnitFactors[drugUnit];
      const liquidVolumeInMl = liquidVolume * volumeUnitFactors[liquidUnit];
      const concentration = drugAmountInMg / liquidVolumeInMl;
      const molarity = concentration / molecularWeight;
      
      const historyItem = {
        type: 'molarity',
        timestamp: new Date().toLocaleString('ja-JP'),
        drugAmount: drugAmount,
        drugUnit: drugUnit,
        liquidVolume: liquidVolume,
        liquidUnit: liquidUnit,
        molecularWeight: molecularWeight,
        drugName: drugName || '',
        concentration: concentration,
        molarity: molarity
      };
      
      calculationHistory.unshift(historyItem);
      if (calculationHistory.length > 15) {
        calculationHistory.pop();
      }
      
      localStorage.setItem('molarity-calc-history', JSON.stringify(calculationHistory));
    }
  }
}

// å±¥æ­´èª­ã¿è¾¼ã¿
function loadHistory() {
  const historyContent = document.getElementById('history-content');
  const modeHistory = calculationHistory.filter(item => 
    currentCalculationMode === 'stock' ? item.type === 'stock' : item.type === 'molarity'
  );
  
  if (modeHistory.length === 0) {
    historyContent.innerHTML = '<p style="text-align: center; color: var(--muted-text);">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }
  
  let historyHTML = '';
  modeHistory.forEach((item, index) => {
    if (item.type === 'stock') {
      historyHTML += `
        <div class="history-item" onclick="loadFromHistory(${calculationHistory.indexOf(item)})">
          <div style="font-size: 0.8rem; color: var(--muted-text);">${item.timestamp} [ã‚¹ãƒˆãƒƒã‚¯]</div>
          <div><strong>MW:</strong> ${item.mw} g/mol</div>
          <div><strong>æ¿ƒåº¦:</strong> ${item.molarity} ${item.molarity_unit}</div>
          <div><strong>ä½“ç©:</strong> ${item.volume} ${item.volume_unit}</div>
          <div><strong>å¿…è¦è–¬é‡:</strong> ${formatNumber(item.mass_mg)} mg</div>
        </div>
      `;
    } else {
      const displayName = item.drugName ? ` [${item.drugName}]` : '';
      historyHTML += `
        <div class="history-item" onclick="loadFromHistory(${calculationHistory.indexOf(item)})">
          <div style="font-size: 0.8rem; color: var(--muted-text);">${item.timestamp} [ãƒ¢ãƒ«æ¿ƒåº¦]${displayName}</div>
          <div><strong>è–¬ç‰©:</strong> ${item.drugAmount} ${item.drugUnit}</div>
          <div><strong>æ¶²é‡:</strong> ${item.liquidVolume} ${item.liquidUnit}</div>
          <div><strong>MW:</strong> ${item.molecularWeight} g/mol</div>
          <div><strong>ãƒ¢ãƒ«æ¿ƒåº¦:</strong> ${formatMolarityForDisplay(item.molarity)}</div>
        </div>
      `;
    }
  });
  
  historyContent.innerHTML = historyHTML;
}

// å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿
function loadFromHistory(index) {
  const item = calculationHistory[index];
  
  if (item.type === 'stock') {
    if (currentCalculationMode !== 'stock') {
      switchCalculationMode('stock');
      setTimeout(() => loadFromHistoryStock(item), 100);
    } else {
      loadFromHistoryStock(item);
    }
  } else {
    if (currentCalculationMode !== 'molarity') {
      switchCalculationMode('molarity');
      setTimeout(() => loadFromHistoryMolarity(item), 100);
    } else {
      loadFromHistoryMolarity(item);
    }
  }
  
  toggleHistory();
  showFloatingNotification('å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
}

function loadFromHistoryStock(item) {
  document.getElementById('mw').value = item.mw;
  document.getElementById('molarity').value = item.molarity;
  
  const molarityUnit = document.getElementById('molarity_unit');
  for (let i = 0; i < molarityUnit.options.length; i++) {
    if (molarityUnit.options[i].text === item.molarity_unit) {
      molarityUnit.selectedIndex = i;
      break;
    }
  }
  
  const volumeUnit = document.getElementById('volume_unit');
  for (let i = 0; i < volumeUnit.options.length; i++) {
    if (volumeUnit.options[i].text === item.volume_unit) {
      volumeUnit.selectedIndex = i;
      break;
    }
  }
  
  document.getElementById('volume').value = item.volume;
  updateMainResults();
}

function loadFromHistoryMolarity(item) {
  document.getElementById('drug_amount').value = item.drugAmount;
  document.getElementById('drug_unit').value = item.drugUnit;
  document.getElementById('liquid_volume').value = item.liquidVolume;
  document.getElementById('liquid_unit').value = item.liquidUnit;
  document.getElementById('molecular_weight').value = item.molecularWeight;
  document.getElementById('drug_name').value = item.drugName || '';
  calculateMolarity();
}

// å±¥æ­´ã‚¯ãƒªã‚¢
function clearHistory() {
  if (confirm('å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    calculationHistory = [];
    localStorage.removeItem('molarity-calc-history');
    loadHistory();
    showFloatingNotification('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
  }
}

// å…¨ã‚¯ãƒªã‚¢
function clearAll() {
  if (confirm('ã™ã¹ã¦ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
    if (currentCalculationMode === 'stock') {
      document.getElementById('mw').value = '';
      document.getElementById('molarity').value = '';
      document.getElementById('volume').value = '';
      document.getElementById('final_molarity').value = '';
      document.getElementById('final_total_vol').value = '';
      document.getElementById('cid').value = '';
      document.getElementById('drug_info').style.display = 'none';
      updateMainResults();
    } else {
      document.getElementById('drug_amount').value = '';
      document.getElementById('liquid_volume').value = '';
      document.getElementById('molecular_weight').value = '';
      document.getElementById('drug_name').value = '';
      calculateMolarity();
    }
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆ
    if (activeStates.formula) toggleFormula();
    if (activeStates.history) toggleHistory();
    
    clearModeResults();
    showFloatingNotification('ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
  }
}

// ğŸ¯ çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–¢æ•°ã‚’æ›´æ–°
function exportResults() {
  const resultsContent = document.getElementById('results-content');
  const hasResults = !resultsContent.querySelector('.results-placeholder');
  
  if (!hasResults) {
    showFloatingNotification('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  const printWindow = window.open('', '_blank');
  const modeTitle = currentCalculationMode === 'stock' ? 'ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²èª¿è£½' : 'ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—';
  const results = resultsContent.innerHTML;
  
    // ES5è å‘ˆé‹¤ãƒ»å£½æšèŸ„æ€œãƒ»é¨¾ï½£é‚¨èˆŒã€’HTMLé‚¨ãƒ»ï½«å…·ï½¼ãƒ»ãƒ»èœ‰ãƒ»
  var html =
    '<!DOCTYPE html>' +
    '<html lang="ja">' +
    '<head><meta charset="UTF-8"><title>YoshinovaCalc Lab ' + modeTitle + ' é‚¨å…ˆæ£¡</title>' +
      '<style>' +
        'body{font-family:Inter,system-ui,sans-serif;margin:20px;color:#333;}' +
        '.header{text-align:center;margin-bottom:20px;border-bottom:2px solid #4299e1;padding-bottom:10px;}' +
        '.results{border:1px solid #ccc;padding:15px;border-radius:6px;background:#f9f9f9;}' +
      '</style>' +
    '</head>' +
    '<body>' +
      '<div class="header"><h1>îï½§ï½¬ YoshinovaCalc Lab îï½§ï½¬</h1>' +
      '<p>' + modeTitle + ' é‚¨å…ˆæ£¡ - ' + new Date().toLocaleString('ja-JP') + '</p></div>' +
      '<div class="results">' + results + '</div>' +
    '</body>' +
    '</html>';
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.print();
}

// ğŸ¯ ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—ã®å®Ÿè£…ï¼ˆresults-panelçµ±ä¸€ç‰ˆï¼‰
function setupMolarityCalculationListeners() {
  const molarityInputs = ['drug_amount', 'drug_unit', 'liquid_volume', 'liquid_unit', 'molecular_weight', 'drug_name'];
  molarityInputs.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('input', calculateMolarity);
      element.addEventListener('change', calculateMolarity);
    }
  });
}

function formatNumber(num) {
  if (num === 0) return "0";
  if (Math.abs(num) >= 100) return num.toFixed(1);
  if (Math.abs(num) >= 10) return num.toFixed(2);
  if (Math.abs(num) >= 1) return num.toFixed(3);
  if (Math.abs(num) >= 0.1) return num.toFixed(3);
  return num.toFixed(4);
}

function formatMolarityForDisplay(molarity) {
  let displayValue, unit;
  if (molarity >= 1) {
    displayValue = formatNumber(molarity);
    unit = 'M';
  } else if (molarity >= 0.001) {
    displayValue = formatNumber(molarity * 1000);
    unit = 'mM';
  } else if (molarity >= 0.000001) {
    displayValue = formatNumber(molarity * 1000000);
    unit = 'Î¼M';
  } else {
    displayValue = formatNumber(molarity * 1000000000);
    unit = 'nM';
  }
  return `${displayValue} ${unit}`;
}

function calculateMolarity() {
  if (currentCalculationMode !== 'molarity') return;
  
  const drugAmount = parseFloat(document.getElementById('drug_amount').value);
  const drugUnit = document.getElementById('drug_unit').value;
  const liquidVolume = parseFloat(document.getElementById('liquid_volume').value);
  const liquidUnit = document.getElementById('liquid_unit').value;
  const molecularWeight = parseFloat(document.getElementById('molecular_weight').value);
  const drugName = document.getElementById('drug_name').value;
  
  const concentrationDisplay = document.getElementById('concentration-display');
  const concentrationValue = document.getElementById('concentration-value');
  const resultsContent = document.getElementById('results-content');
  
  // å…¥åŠ›å€¤æ¤œè¨¼
  if (isNaN(drugAmount) || isNaN(liquidVolume) || drugAmount <= 0 || liquidVolume <= 0) {
    concentrationDisplay.style.display = 'none';
    resultsContent.innerHTML = `
      <div class="results-placeholder">
        å¿…è¦é …ç›®ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    `;
    updateSectionStatus('molarity-calc', '');
    return;
  }
  
  try {
    // å˜ä½å¤‰æ›
    const drugAmountInMg = drugAmount * drugUnitFactors[drugUnit];
    const liquidVolumeInMl = liquidVolume * volumeUnitFactors[liquidUnit];
    
    // è³ªé‡æ¿ƒåº¦è¨ˆç®— (mg/mL)
    const concentration = drugAmountInMg / liquidVolumeInMl;
    
    // è³ªé‡æ¿ƒåº¦è¡¨ç¤ºï¼ˆå·¦å´ï¼‰
    concentrationValue.textContent = formatNumber(concentration);
    concentrationDisplay.style.display = 'block';
    
    // ãƒ¢ãƒ«æ¿ƒåº¦è¨ˆç®—
    if (!isNaN(molecularWeight) && molecularWeight > 0) {
      const molarity = concentration / molecularWeight;
      const molarityDisplayValue = formatMolarityForDisplay(molarity);
      
      // ğŸ¯ å³å´results-panelã«çµ±ä¸€è¡¨ç¤º
      const drugDisplay = drugName ? drugName : 'åŒ–åˆç‰©';
      
      resultsContent.innerHTML = `
        <div class="results-grid">
          <div class="result-item">
            <div class="result-label">è³ªé‡æ¿ƒåº¦</div>
            <div class="result-value">${formatNumber(concentration)} mg/mL</div>
          </div>
          <div class="result-item">
            <div class="result-label">ãƒ¢ãƒ«æ¿ƒåº¦</div>
            <div class="result-value">${molarityDisplayValue}</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">èª¿è£½æ¡ä»¶</div>
            <div class="result-value" style="font-size: 0.9rem;">${drugAmount} ${drugUnit} Ã· ${liquidVolume} ${liquidUnit}</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">è–¬ç‰©æƒ…å ±</div>
            <div class="result-value" style="font-size: 0.9rem;">
              ${drugDisplay} (MW: ${molecularWeight} g/mol)
            </div>
          </div>
        </div>
        <div style="margin-top: 1rem; padding: 0.8rem; background: rgba(255, 255, 255, 0.3); border-radius: 8px; font-size: 0.8rem; color: var(--muted-text);">
          <strong>ğŸ’¡ è¨ˆç®—éç¨‹:</strong><br>
          1. è³ªé‡æ¿ƒåº¦ = ${formatNumber(drugAmountInMg)} mg Ã· ${formatNumber(liquidVolumeInMl)} mL = ${formatNumber(concentration)} mg/mL<br>
          2. ãƒ¢ãƒ«æ¿ƒåº¦ = ${formatNumber(concentration)} Ã· ${molecularWeight} = ${formatNumber(molarity, 4)} mol/L<br>
          3. è©³ç´°å€¤: ${molarity.toExponential(3)} mol/L
        </div>
      `;
      
      updateSectionStatus('molarity-calc', 'completed');
      saveToHistory();
    } else {
      // åˆ†å­é‡æœªå…¥åŠ›æ™‚
      resultsContent.innerHTML = `
        <div class="results-grid">
          <div class="result-item">
            <div class="result-label">è³ªé‡æ¿ƒåº¦</div>
            <div class="result-value">${formatNumber(concentration)} mg/mL</div>
          </div>
          <div class="result-item">
            <div class="result-label">ãƒ¢ãƒ«æ¿ƒåº¦</div>
            <div class="result-value" style="color: var(--muted-text);">åˆ†å­é‡ã‚’å…¥åŠ›</div>
          </div>
          <div class="result-item" style="grid-column: 1 / -1;">
            <div class="result-label">èª¿è£½æ¡ä»¶</div>
            <div class="result-value" style="font-size: 0.9rem;">${drugAmount} ${drugUnit} Ã· ${liquidVolume} ${liquidUnit}</div>
          </div>
        </div>
      `;
      updateSectionStatus('molarity-calc', '');
    }
    
  } catch (error) {
    resultsContent.innerHTML = `
      <div class="results-placeholder" style="color: var(--error-color); border-color: var(--error-color);">
        âš ï¸ è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      </div>
    `;
    updateSectionStatus('molarity-calc', 'error');
  }
}

// ğŸ¯ æ—¢å­˜ã®é–¢æ•°ç¾¤ï¼ˆã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²è¨ˆç®—ç”¨ï¼‰

function setInputError(inputId, message, isWarning = false) {
  const errorEl = document.getElementById('error-' + inputId.replace('_','-'));
  const inputEl = document.getElementById(inputId);
  
  if (errorEl) {
    errorEl.textContent = message || '';
    errorEl.className = isWarning ? 'input-warning-message' : 'input-error-message';
    
    if (message) {
      errorEl.style.animation = 'none';
      errorEl.offsetHeight;
      errorEl.style.animation = 'bounceIn 0.4s ease-out';
    }
  }
  
  if (inputEl) {
    inputEl.classList.remove('invalid', 'warning', 'valid');
    if (message) {
      inputEl.classList.add(isWarning ? 'warning' : 'invalid');
    }
  }
  
  updateSectionVisualState(inputId, message, isWarning);
}

function updateSectionVisualState(inputId, hasMessage, isWarning) {
  const sectionMap = {
    'mw': 'stock',
    'molarity': 'stock', 
    'volume': 'stock',
    'final_molarity': 'dilution',
    'final_total_vol': 'dilution'
  };
  
  const sectionName = sectionMap[inputId];
  if (!sectionName) return;
  
  const sectionEl = document.getElementById(`section-${sectionName}`);
  if (!sectionEl) return;
  
  const hasErrors = sectionEl.querySelector('.input-error-message:not(:empty)');
  const hasWarnings = sectionEl.querySelector('.input-warning-message:not(:empty)');
  
  sectionEl.classList.remove('has-errors', 'has-warnings');
  
  if (hasErrors) {
    sectionEl.classList.add('has-errors');
  } else if (hasWarnings) {
    sectionEl.classList.add('has-warnings');
  }
}

function updateInputStatus(inputId, isValid, isEmpty = false) {
  const statusEl = document.getElementById(`status-${inputId.replace('_', '-')}`);
  const inputEl = document.getElementById(inputId);
  if (!statusEl || !inputEl) return;
  
  if (isEmpty) {
    statusEl.textContent = '';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '');
  } else if (isValid) {
    statusEl.textContent = 'âœ“';
    statusEl.style.color = 'var(--success-color)';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '') + ' valid';
  } else {
    statusEl.textContent = 'âš ';
    statusEl.style.color = 'var(--error-color)';
    inputEl.className = inputEl.className.replace(/\s*(valid|invalid|warning)/, '') + ' invalid';
  }
}

function updateSectionStatus(sectionId, status) {
  const statusEl = document.getElementById(`status-${sectionId}`);
  const sectionEl = document.getElementById(`section-${sectionId}`);
  if (!statusEl || !sectionEl) return;
  
  statusEl.className = 'section-status ' + status;
  if (status === 'completed') {
    statusEl.textContent = 'å®Œäº†';
    sectionEl.classList.add('completed');
  } else if (status === 'error') {
    statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼';
    sectionEl.classList.remove('completed');
  } else if (status === 'warning') {
    statusEl.textContent = 'æ³¨æ„';
    sectionEl.classList.remove('completed');
  } else {
    statusEl.textContent = '';
    sectionEl.classList.remove('completed');
  }
}

function formatMassCustomUnit(value_mg, selectedUnit) {
  if (selectedUnit === "mg") {
    return `${formatNumber(value_mg)} mg`;
  } else if (selectedUnit === "g") {
    return `${formatNumber(value_mg / 1000)} g`;
  } else if (selectedUnit === "Î¼g") {
    return `${formatNumber(value_mg * 1000)} Î¼g`;
  } else {
    return `${formatNumber(value_mg)} mg`;
  }
}

function validateInputs() {
  if (currentCalculationMode !== 'stock') return { warnings: [], errors: [] };
  
  const warnings = [];
  const errors = [];
  
  ['mw','molarity','volume','final-molarity','final-total-vol'].forEach(id => setInputError(id, ""));
  
  const mw = parseFloat(document.getElementById('mw').value);
  const molarity = parseFloat(document.getElementById('molarity').value);
  const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
  const volume = parseFloat(document.getElementById('volume').value);
  const volume_unit = parseFloat(document.getElementById('volume_unit').value);
  const final_molarity = parseFloat(document.getElementById('final_molarity').value);
  const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
  const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
  const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);
  
  const mwValid = !isNaN(mw) && mw > 0;
  const molarityValid = !isNaN(molarity) && molarity > 0;
  const volumeValid = !isNaN(volume) && volume > 0;
  const finalMolarityValid = document.getElementById('final_molarity').value === '' || (!isNaN(final_molarity) && final_molarity > 0);
  const finalVolumeValid = document.getElementById('final_total_vol').value === '' || (!isNaN(final_total_vol) && final_total_vol > 0);
  
  // åˆ†å­é‡ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!mwValid && document.getElementById('mw').value !== "") {
    setInputError('mw', 'åˆ†å­é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    errors.push("åˆ†å­é‡ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
  } else if (mwValid && mw < 10) {
    setInputError('mw', 'åˆ†å­é‡ãŒ10æœªæº€ã§ã™ã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªï¼', true);
    warnings.push("åˆ†å­é‡ãŒ10æœªæº€ã§ã™ã€‚ä½åˆ†å­åŒ–åˆç‰©ã§ã‚‚é€šå¸¸10ä»¥ä¸Šã§ã™ã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  } else if (mwValid && mw > 2000 && mw <= 10000) {
    setInputError('mw', 'åˆ†å­é‡ãŒ2000ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æº¶è§£æ€§ã«æ³¨æ„', true);
    warnings.push("åˆ†å­é‡ãŒ2000ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ãƒšãƒ—ãƒãƒ‰ã‚„å¤§åˆ†å­åŒ–åˆç‰©ã§ã™ã‹ï¼Ÿæº¶è§£æ€§ã«ã”æ³¨æ„ãã ã•ã„ã€‚");
  } else if (mwValid && mw > 10000) {
    setInputError('mw', 'åˆ†å­é‡ãŒ10000ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ç‰¹æ®Šãªæº¶è§£æ¡ä»¶ã‹ã‚‚', true);
    warnings.push("åˆ†å­é‡ãŒ10000ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãªã©ã®å·¨å¤§åˆ†å­ã§ã™ã­ã€‚ç‰¹æ®Šãªæº¶è§£æ¡ä»¶ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚");
  }
  
  // ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!molarityValid && document.getElementById('molarity').value !== "") {
    setInputError('molarity', 'æ¿ƒåº¦ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    errors.push("æ¿ƒåº¦ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
  } else if (molarityValid && molarity_unit > 0) {
    const stock_conc_molL = molarity * molarity_unit;
    if (stock_conc_molL > 1) {
      setInputError('molarity', '1Mè¶…ã®é«˜æ¿ƒåº¦ã€‚æº¶è§£åº¦ã«æ³¨æ„', true);
      warnings.push("ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ãŒ1 M ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æº¶è§£åº¦ã¯å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿé«˜æ¿ƒåº¦ã§ã¯æ²ˆæ®¿ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚");
    } else if (stock_conc_molL > 0.1) {
      setInputError('molarity', '100mMè¶…ã€‚å®Œå…¨æº¶è§£ã‚’ç¢ºèª', true);
      warnings.push("ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ãŒ100 mM ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚å®Œå…¨æº¶è§£ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
    } else if (stock_conc_molL < 1e-9) {
      setInputError('molarity', '1nMæœªæº€ã€‚ç²¾åº¦ã«æ³¨æ„', true);
      warnings.push("ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ãŒæ¥µã‚ã¦ä½ã„ã§ã™ï¼ˆ1 nMæœªæº€ï¼‰ã€‚å¸Œé‡ˆç²¾åº¦ãŒå•é¡Œã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    }
  }
  
  // ä½“ç©ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!volumeValid && document.getElementById('volume').value !== "") {
    setInputError('volume', 'èª¿è£½é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    errors.push("èª¿è£½é‡ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
  } else if (volumeValid && volume_unit > 0) {
    const total_vol_ul = volume * (volume_unit === 1 ? 1e6 : 1e3);
    if (total_vol_ul < 10) {
      setInputError('volume', '10Î¼Læœªæº€ã€‚èª¿è£½å›°é›£', false);
      errors.push("èª¿è£½é‡ãŒ10Î¼Læœªæº€ã§ã™ã€‚å®Ÿéš›ã®èª¿è£½ã¯å›°é›£ã§ã™ã€‚ã‚ˆã‚Šå¤§ããªé‡ã§ã®èª¿è£½ã‚’æ¨å¥¨ã—ã¾ã™ã€‚");
    } else if (total_vol_ul < 100) {
      setInputError('volume', '100Î¼Læœªæº€ã€‚ãƒ”ãƒšãƒƒãƒˆç²¾åº¦ã«æ³¨æ„', true);
      warnings.push("èª¿è£½é‡ãŒ100Î¼Læœªæº€ã§ã™ã€‚ãƒ”ãƒšãƒƒãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã«ã”æ³¨æ„ãã ã•ã„ã€‚ãƒã‚¤ã‚¯ãƒ­ãƒ”ãƒšãƒƒãƒˆã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚");
    } else if (total_vol_ul > 1e9) {
      setInputError('volume', '1Lè¶…ã€‚å˜ä½ãƒŸã‚¹æ³¨æ„', true);
      warnings.push("èª¿è£½é‡ãŒéç¾å®Ÿçš„ã«å¤§ãã„ã§ã™ï¼ˆ1 Lè¶…ï¼‰ã€‚å˜ä½ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  }
  
  // ğŸ¯ å¸Œé‡ˆé–¢é€£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£ç‰ˆï¼‰
  const finalMolarityInput = document.getElementById('final_molarity').value;
  const finalVolumeInput = document.getElementById('final_total_vol').value;
  const bothFieldsEmpty = finalMolarityInput === '' && finalVolumeInput === '';
  const bothFieldsFilled = finalMolarityInput !== '' && finalVolumeInput !== '';
  const onlyOneFieldFilled = (finalMolarityInput !== '' && finalVolumeInput === '') || 
                             (finalMolarityInput === '' && finalVolumeInput !== '');
  
  if (onlyOneFieldFilled) {
    // ã©ã¡ã‚‰ã‹ç‰‡æ–¹ã ã‘å…¥åŠ›ã•ã‚ŒãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (finalMolarityInput !== '' && finalVolumeInput === '') {
      setInputError('final-total-vol', 'å¸Œé‡ˆå¾Œç·é‡ã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„', false);
      errors.push("å¸Œé‡ˆè¨ˆç®—ã«ã¯æœ€çµ‚æ¿ƒåº¦ã¨å¸Œé‡ˆå¾Œç·é‡ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
    }
    if (finalMolarityInput === '' && finalVolumeInput !== '') {
      setInputError('final-molarity', 'æœ€çµ‚æ¿ƒåº¦ã‚‚å…¥åŠ›ã—ã¦ãã ã•ã„', false);
      errors.push("å¸Œé‡ˆè¨ˆç®—ã«ã¯æœ€çµ‚æ¿ƒåº¦ã¨å¸Œé‡ˆå¾Œç·é‡ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
    }
  } else if (bothFieldsFilled) {
    // ä¸¡æ–¹å…¥åŠ›ã•ã‚ŒãŸå ´åˆã®è©³ç´°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!finalMolarityValid) {
      setInputError('final-molarity', 'æœ€çµ‚æ¿ƒåº¦ã‚’æ­£ã—ãå…¥åŠ›');
      errors.push("æœ€çµ‚æ¿ƒåº¦ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    } else if (!finalVolumeValid) {
      setInputError('final-total-vol', 'å¸Œé‡ˆå¾Œç·é‡ã‚’æ­£ã—ãå…¥åŠ›');
      errors.push("å¸Œé‡ˆå¾Œç·é‡ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
    } else if (finalMolarityValid && molarityValid && molarity > 0) {
      const stock_conc = molarity * molarity_unit;
      const final_conc = final_molarity * final_molarity_unit;
      if (final_conc >= stock_conc) {
        setInputError('final-molarity', 'ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦æœªæº€ã§å…¥åŠ›', false);
        errors.push("æœ€çµ‚æ¿ƒåº¦ãŒã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ä»¥ä¸Šã§ã™ã€‚å¸Œé‡ˆã§ã¯å®Ÿç¾ã§ãã¾ã›ã‚“ã€‚ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ã‚’ä¸Šã’ã‚‹ã‹æœ€çµ‚æ¿ƒåº¦ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚");
      } else {
        const dilution_factor = stock_conc / final_conc;
        if (dilution_factor > 10000) {
          setInputError('final-molarity', 'å¸Œé‡ˆå€ç‡1ä¸‡å€è¶…ã€‚æ®µéšå¸Œé‡ˆæ¨å¥¨', true);
          warnings.push("å¸Œé‡ˆå€ç‡ãŒ1ä¸‡å€ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚æ®µéšå¸Œé‡ˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚ç²¾åº¦ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
        } else if (dilution_factor < 2) {
          setInputError('final-molarity', '2å€æœªæº€ã€‚ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦è¦‹ç›´ã—æ¨å¥¨', true);
          warnings.push("å¸Œé‡ˆå€ç‡ãŒ2å€æœªæº€ã§ã™ã€‚ã‚‚ã†å°‘ã—æ¿ƒã„ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã®æ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚");
        }
      }
    }
    
    // ãƒ”ãƒšãƒƒãƒ†ã‚£ãƒ³ã‚°ç²¾åº¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (finalMolarityValid && final_molarity > 0 && finalVolumeValid && final_total_vol > 0 && molarityValid && molarity > 0) {
      const C1 = molarity * molarity_unit;
      const C2 = final_molarity * final_molarity_unit;
      const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);
      const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
      if (V1 < 0.1) {
        setInputError('final-molarity', 'ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ã®å¿…è¦é‡ãŒ0.1Î¼Læœªæº€ã€‚ç²¾åº¦ä¸å¯', false);
        errors.push("å¿…è¦ãªã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡ãŒ0.1Î¼Læœªæº€ã§ã™ã€‚æ­£ç¢ºãªãƒ”ãƒšãƒƒãƒ†ã‚£ãƒ³ã‚°ã¯ä¸å¯èƒ½ã§ã™ã€‚ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚");
      } else if (V1 < 1) {
        setInputError('final-molarity', '1Î¼Læœªæº€ã€‚é«˜ç²¾åº¦ãƒ”ãƒšãƒƒãƒˆå¿…è¦', true);
        warnings.push("å¿…è¦ãªã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡ãŒ1Î¼Læœªæº€ã§ã™ã€‚é«˜ç²¾åº¦ãƒ”ãƒšãƒƒãƒˆï¼ˆ0.1-2Î¼Lç”¨ï¼‰ãŒå¿…è¦ã§ã™ã€‚");
      }
    }
  }
  // bothFieldsEmpty ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆä»»æ„ãªã®ã§ï¼‰
  
  // å¿…è¦è–¬é‡ã®è¨ˆç®—ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (mwValid && molarityValid && volumeValid) {
    const molarity_molL = molarity * molarity_unit;
    const volume_L = volume * volume_unit;
    const mass_mg = mw * molarity_molL * volume_L * 1000;
    if (mass_mg < 0.1) {
      setInputError('mw', 'å¿…è¦è–¬é‡ãŒ0.1mgæœªæº€ã€‚å¤©ç§¤ç²¾åº¦ä¸å¯', false);
      errors.push("å¿…è¦ãªè–¬é‡ãŒ0.1mgæœªæº€ã§ã™ã€‚åˆ†æå¤©ç§¤ã§ã‚‚æ­£ç¢ºãªç§¤é‡ã¯å›°é›£ã§ã™ã€‚æ¿ƒåº¦ã‚’ä¸‹ã’ã‚‹ã‹é‡ã‚’å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚");
    } else if (mass_mg < 1) {
      setInputError('mw', 'å¿…è¦è–¬é‡ãŒ1mgæœªæº€ã€‚ãƒã‚¤ã‚¯ãƒ­å¤©ç§¤æ¨å¥¨', true);
      warnings.push("å¿…è¦ãªè–¬é‡ãŒ1mgæœªæº€ã§ã™ã€‚ãƒã‚¤ã‚¯ãƒ­å¤©ç§¤ã¾ãŸã¯æ¯æ¶²èª¿è£½æ³•ï¼ˆé«˜æ¿ƒåº¦ã§å°‘é‡èª¿è£½å¾Œå¸Œé‡ˆï¼‰ã‚’æ¨å¥¨ã—ã¾ã™ã€‚");
    } else if (mass_mg > 1000) {
      setInputError('mw', 'å¿…è¦è–¬é‡ãŒ1gè¶…ã€‚æº¶è§£ãƒ»å®¹å™¨æ³¨æ„', true);
      warnings.push("å¿…è¦ãªè–¬é‡ãŒ1gã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚å®¹å™¨ã‚µã‚¤ã‚ºã¨æº¶è§£æ™‚é–“ã«ã”æ³¨æ„ãã ã•ã„ã€‚æ®µéšçš„ã«æº¶è§£ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚");
    }
  }
  
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
  const stockValid = mwValid && molarityValid && volumeValid;
  const stockHasErrors = errors.some(error => error.includes('èª¿è£½é‡') || error.includes('è–¬é‡') || error.includes('åˆ†å­é‡') || error.includes('æ¿ƒåº¦'));
  const stockHasWarnings = warnings.some(warning => warning.includes('åˆ†å­é‡') || warning.includes('ã‚¹ãƒˆãƒƒã‚¯æ¿ƒåº¦') || warning.includes('èª¿è£½é‡') || warning.includes('è–¬é‡'));
  
  if (stockHasErrors) {
    updateSectionStatus('stock', 'error');
  } else if (stockHasWarnings) {
    updateSectionStatus('stock', 'warning');
  } else if (stockValid) {
    updateSectionStatus('stock', 'completed');
  } else {
    updateSectionStatus('stock', '');
  }
  
  // ğŸ¯ å¸Œé‡ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ï¼ˆå®Œå…¨ã«ä¿®æ­£ï¼‰
  const dilutionHasErrors = errors.some(error => error.includes('æœ€çµ‚æ¿ƒåº¦') || error.includes('ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡') || error.includes('å¸Œé‡ˆå¾Œç·é‡') || error.includes('å¸Œé‡ˆè¨ˆç®—'));
  const dilutionHasWarnings = warnings.some(warning => warning.includes('å¸Œé‡ˆå€ç‡') || warning.includes('ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²é‡'));
  
  if (dilutionHasErrors) {
    updateSectionStatus('dilution', 'error');
  } else if (dilutionHasWarnings) {
    updateSectionStatus('dilution', 'warning');
  } else if (bothFieldsFilled && finalMolarityValid && finalVolumeValid && stockValid && !stockHasErrors) {
    // ä¸¡æ–¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ãå…¥åŠ›ã•ã‚Œã€ã‚¹ãƒˆãƒƒã‚¯æƒ…å ±ã‚‚å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€Œå®Œäº†ã€
    updateSectionStatus('dilution', 'completed');
  } else {
    // æœªå…¥åŠ›ï¼ˆä»»æ„ï¼‰ã€ç‰‡æ–¹ã®ã¿å…¥åŠ›ã€ã‚¹ãƒˆãƒƒã‚¯æœªå®Œäº†ã®å ´åˆã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãªã—
    updateSectionStatus('dilution', '');
  }
  
  return { warnings, errors };
}

function formatVolumeSI(value_ul) {
  if (value_ul >= 1e6) {
    return `${formatNumber(value_ul / 1e6)} L`;
  } else if (value_ul >= 1e3) {
    return `${formatNumber(value_ul / 1e3)} mL`;
  } else if (value_ul >= 1) {
    return `${formatNumber(value_ul)} Î¼L`;
  } else if (value_ul >= 1e-3) {
    return `${formatNumber(value_ul * 1e3)} nL`;
  } else if (value_ul > 0) {
    return `${formatNumber(value_ul * 1e6)} pL`;
  } else {
    return "0";
  }
}

function updateMainResults() {
  if (currentCalculationMode !== 'stock') return;
  
  const mw = parseFloat(document.getElementById('mw').value);
  const molarity = parseFloat(document.getElementById('molarity').value);
  const molarity_unit = parseFloat(document.getElementById('molarity_unit').value);
  const volume = parseFloat(document.getElementById('volume').value);
  const volume_unit = parseFloat(document.getElementById('volume_unit').value);
  const final_molarity = parseFloat(document.getElementById('final_molarity').value);
  const final_molarity_unit = parseFloat(document.getElementById('final_molarity_unit').value);
  const final_total_vol = parseFloat(document.getElementById('final_total_vol').value);
  const final_total_vol_unit = parseFloat(document.getElementById('final_total_vol_unit').value);
  const selectedMassUnit = document.getElementById('mass_unit').value;
  
  let resultHTML = '';
  let hasResults = false;
  
  if (!isNaN(mw) && mw > 0 && !isNaN(molarity) && molarity > 0 && !isNaN(volume) && volume > 0) {
    const molarity_molL = molarity * molarity_unit;
    const volume_L = volume * volume_unit;
    const mass_mg = mw * molarity_molL * volume_L * 1000;
    let solvent_ul = volume * (volume_unit === 1 ? 1000000 : 1000);
    const massDisplay = formatMassCustomUnit(mass_mg, selectedMassUnit);
    
    resultHTML += `<div class="results-grid">
        <div class="result-item">
          <div class="result-label">å¿…è¦ãªè–¬é‡</div>
          <div class="result-value">${massDisplay}</div>
        </div>
        <div class="result-item">
          <div class="result-label">æº¶åª’é‡</div>
          <div class="result-value">${formatVolumeSI(solvent_ul)}</div>
        </div>`;
    
    hasResults = true;
    saveToHistory();
    
    let stockResult = `<strong>ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²èª¿è£½:</strong> è–¬ ${massDisplay} + æº¶åª’ ${formatVolumeSI(solvent_ul)}`;
    if (mass_mg < 1) {
      stockResult += '<br><span style="color: var(--warning-color);">âš  1mgæœªæº€ã®ãŸã‚æ¯æ¶²èª¿è£½æ³•ã‚’æ¨å¥¨</span>';
    }
    showSectionResult('section-result-stock', stockResult);
  } else {
    showSectionResult('section-result-stock', null);
  }
  
  if (!isNaN(molarity) && molarity > 0 && !isNaN(final_molarity) && final_molarity > 0 &&
      !isNaN(final_total_vol) && final_total_vol > 0) {
    const C1 = molarity * molarity_unit;
    const C2 = final_molarity * final_molarity_unit;
    const V2 = final_total_vol * (final_total_vol_unit === 1 ? 1000 : 1);const V1 = (C2 * V2 / 1e6) / C1 * 1e6;
    const V1_fixed = Math.max(0, V1);
    const diluent_uL = V2 - V1_fixed;
    
    if (hasResults) {
      resultHTML += `
          <div class="result-item">
            <div class="result-label">ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²</div>
            <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
          </div>
          <div class="result-item">
            <div class="result-label">è¿½åŠ æº¶åª’</div>
            <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
          </div>
      `;
    } else {
      resultHTML += `
      <div class="results-grid">
          <div class="result-item">
            <div class="result-label">ã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²</div>
            <div class="result-value">${formatVolumeSI(V1_fixed)}</div>
          </div>
          <div class="result-item">
            <div class="result-label">è¿½åŠ æº¶åª’</div>
            <div class="result-value">${formatVolumeSI(diluent_uL)}</div>
          </div>
      `;
    }
    resultHTML += '</div>';
    hasResults = true;
    
    let dilutionResult = `<strong>å¸Œé‡ˆé…åˆ:</strong> ã‚¹ãƒˆãƒƒã‚¯ ${formatVolumeSI(V1_fixed)} + æº¶åª’ ${formatVolumeSI(diluent_uL)}`;
    if (V1_fixed < 1) {
      dilutionResult += '<br><span style="color: var(--warning-color);">âš  é«˜ç²¾åº¦ãƒ”ãƒšãƒƒãƒˆå¿…è¦</span>';
    }
    showSectionResult('section-result-dilution', dilutionResult);
  } else {
    showSectionResult('section-result-dilution', null);
  }
  
  if (hasResults) {
    if (!resultHTML.includes('</div>')) {
      resultHTML += '</div>';
    }
    document.getElementById('results-content').innerHTML = resultHTML;
  } else {
    document.getElementById('results-content').innerHTML = `
        <div class="results-placeholder">
          å¿…è¦é …ç›®ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    `;
  }
  
  const validation = validateInputs();
  currentValidation = validation;
}

function showSectionResult(containerId, content) {
  const container = document.getElementById(containerId);
  if (container) {
    if (content) {
      container.innerHTML = content;
      container.classList.add('show');
    } else {
      container.classList.remove('show');
    }
  }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆã‚¹ãƒˆãƒƒã‚¯æº¶æ¶²ç”¨ï¼‰
[
  "mw","molarity","molarity_unit","volume","volume_unit","mass_unit",
  "final_molarity","final_molarity_unit","final_total_vol","final_total_vol_unit"
].forEach(id => {
  const element = document.getElementById(id);
  if (element) {
    element.addEventListener('input', updateMainResults);
    element.addEventListener('change', updateMainResults);
  }
});

function fetchPubChem() {
  const cid = document.getElementById('cid').value.trim();
  const searchButton = document.querySelector('.btn-primary');
  const searchText = document.getElementById('search-text');
  
  if (!cid) {
    showFloatingNotification("CIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 'error');
    document.getElementById('cid').focus();
    return;
  }
  
  searchText.innerHTML = '<span class="loading-spinner"></span>æ¤œç´¢ä¸­';
  searchButton.disabled = true;
  
  const originalEndpoint = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/MolecularWeight,IUPACName,Title,CanonicalSMILES,MolecularFormula/JSON`;
  const proxyEndpoint = `https://api.allorigins.win/get?url=${encodeURIComponent(originalEndpoint)}`;
  
  fetch(proxyEndpoint)
    .then(response => {
      if (!response.ok) throw new Error("æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return response.json();
    })
    .then(proxyData => {
      const data = JSON.parse(proxyData.contents);
      const prop = data.PropertyTable.Properties[0];
      
      if (prop.CID) document.getElementById('cid').value = prop.CID;
      
      if (currentCalculationMode === 'stock') {
        if (prop.MolecularWeight) document.getElementById('mw').value = prop.MolecularWeight;
        updateMainResults();
      } else {
        if (prop.MolecularWeight) document.getElementById('molecular_weight').value = prop.MolecularWeight;
        if (prop.Title) document.getElementById('drug_name').value = prop.Title;
        calculateMolarity();
      }
      
      let infoHTML = "<table class='info-table' role='table'>";
      infoHTML += "<caption class='sr-only'>å–å¾—ã—ãŸè–¬ç‰©æƒ…å ±</caption>";
      infoHTML += `<tr><td class='info-label'>CID</td><td>${prop.CID ? prop.CID : "-"}</td></tr>`;
      infoHTML += `<tr><td class='info-label'>åŒ–å­¦å¼</td><td>${prop.MolecularFormula ? prop.MolecularFormula : "-"}</td></tr>`;
      infoHTML += `<tr><td class='info-label'>åˆ†å­é‡</td><td>${prop.MolecularWeight ? prop.MolecularWeight : "-"}</td></tr>`;
      if (prop.CanonicalSMILES)
        infoHTML += `<tr><td class='info-label'>SMILES</td><td style="word-break: break-all;">${prop.CanonicalSMILES}</td></tr>`;
      infoHTML += "</table>";
      
      document.getElementById('drug_info').innerHTML = infoHTML;
      document.getElementById('drug_info').style.display = "block";
      updateSectionStatus('search', 'completed');
      showFloatingNotification(`åŒ–åˆç‰©æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ: ${prop.Title || 'CID ' + prop.CID}`, 'success');
    })
    .catch(error => {
      document.getElementById('drug_info').style.display = "none";
      showFloatingNotification("è–¬ç‰©æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, 'error');
      updateSectionStatus('search', 'error');
    })
    .finally(() => {
      searchText.textContent = 'æ¤œç´¢';
      searchButton.disabled = false;
    });
}

// åˆæœŸè¨ˆç®—å®Ÿè¡Œ
updateMainResults();
</script>

  <!-- === ServiceWorker (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥) === -->
  <script>
    if ("serviceWorker" in navigator) {
      const swCode = `
        self.addEventListener("fetch", e => {
          e.respondWith(
            caches.open("ycalc-sw").then(c =>
              c.match(e.request).then(r => r || fetch(e.request).then(res => { c.put(e.request, res.clone()); return res; }))
            )
          );
        });
      `;
      navigator.serviceWorker.register(
        URL.createObjectURL(new Blob([swCode], { type: "application/javascript" }))
      ).catch(console.error);
    }
  </script>

  <!-- === DarkMode åˆ‡æ›¿ãƒ­ã‚¸ãƒƒã‚¯ === -->
  <script>
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById("theme-btn");
      const saved = localStorage.getItem("theme");
      const init  = saved || (matchMedia("(prefers-color-scheme:dark)").matches ? "dark" : "light");
      root.setAttribute("data-theme", init);
      // çµµæ–‡å­—ã¯ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆæŒ‡å®šã§ç¢ºå®Ÿã«
  btn.textContent = init === "dark"
  ? String.fromCodePoint(0x1F52C)  // ğŸ”¬
  : String.fromCodePoint(0x1F48A); // ğŸ’Š

      btn.addEventListener("click", ()=>{
        const next = root.getAttribute("data-theme")==="dark" ? "light" : "dark";
        root.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      btn.textContent = next==="dark"
        ? String.fromCodePoint(0x1F52C)  // ğŸ”¬
        : String.fromCodePoint(0x1F48A); // ğŸ’Š
    });
  })();
  </script>

  <!-- === sanitizeHTML ãƒ˜ãƒ«ãƒ‘ãƒ¼ === -->
  <script>
    const sanitizeHTML = html => DOMPurify.sanitize(html);
  </script></body>
</html>
